<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¸Ù | Employee</title>
<style>
:root{
  --bg:#0b1220;
  --card:#0f1a33;
  --line:rgba(255,255,255,.10);
  --text:#eef3ff;
  --muted:#a6b6ea;
  --blue:#2b6bff;
  --green:#18c37e;
  --red:#ff4d4d;
  --amber:#ffb020;
  --shadow: 0 14px 34px rgba(0,0,0,.35);
  --r:18px;
  --r2:22px;
  --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic","Noto Sans Arabic", Tahoma, Arial;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--font);
  color:var(--text);
  background:
    radial-gradient(1100px 650px at 10% 0%, rgba(43,107,255,.22), transparent 55%),
    radial-gradient(900px 650px at 100% 10%, rgba(24,195,126,.12), transparent 55%),
    radial-gradient(800px 520px at 40% 90%, rgba(255,176,32,.10), transparent 60%),
    var(--bg);
  direction:rtl;
}
a{color:inherit}
button,input,select,textarea{font-family:inherit}
.container{max-width:1180px; margin:0 auto; padding:16px}
.topbar{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:12px 14px;
  border:1px solid var(--line);
  border-radius:var(--r2);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow:var(--shadow);
  position:sticky; top:12px; z-index:30; backdrop-filter: blur(10px);
}
.brand{display:flex; align-items:center; gap:10px; min-width:0}
.logo{
  width:44px;height:44px;border-radius:14px;
  border:1px solid var(--line);
  background:linear-gradient(135deg, rgba(43,107,255,.35), rgba(24,195,126,.20));
  overflow:hidden; display:grid; place-items:center;
}
.logo img{width:100%;height:100%;object-fit:cover}
.brand .txt{display:flex;flex-direction:column;min-width:0}
.brand .txt b{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.brand .txt span{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
.pill{
  padding:8px 10px; border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  font-size:12px; color:var(--muted);
}
.btn{
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:10px 12px;
  border-radius:14px;
  cursor:pointer;
  font-weight:900;
  display:inline-flex; align-items:center; gap:8px;
}
.btn:active{transform:translateY(1px)}
.btn.primary{background:linear-gradient(135deg, rgba(43,107,255,.95), rgba(43,107,255,.70)); border-color:rgba(43,107,255,.35)}
.btn.green{background:linear-gradient(135deg, rgba(24,195,126,.95), rgba(24,195,126,.70)); border-color:rgba(24,195,126,.35)}
.btn.red{background:linear-gradient(135deg, rgba(255,77,77,.95), rgba(255,77,77,.70)); border-color:rgba(255,77,77,.35)}
.btn.ghost{background:transparent}
.grid{display:grid; gap:14px}
@media(min-width:920px){ .grid.cols2{grid-template-columns: 1.2fr .8fr} }
.card{
  border:1px solid var(--line);
  border-radius:var(--r2);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow:var(--shadow);
  overflow:hidden;
}
.card .hd{padding:14px 14px 10px; border-bottom:1px solid var(--line); display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
.card .hd h2{margin:0; font-size:14px}
.card .hd p{margin:6px 0 0; font-size:12px; color:var(--muted)}
.card .bd{padding:14px}
.row{display:grid; gap:10px}
@media(min-width:820px){
  .row.cols2{grid-template-columns:1fr 1fr}
  .row.cols3{grid-template-columns:1fr 1fr 1fr}
  .row.cols4{grid-template-columns:1fr 1fr 1fr 1fr}
}
.field{display:flex; flex-direction:column; gap:6px}
label{font-size:12px; color:var(--muted)}
input,select,textarea{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(10,16,30,.55);
  color:var(--text);
  outline:none;
}
textarea{min-height:96px; resize:vertical}
.small{font-size:12px; color:var(--muted)}
hr.sep{border:none;border-top:1px solid var(--line); margin:12px 0}
.tableWrap{overflow:auto; border:1px solid var(--line); border-radius:16px}
table{width:100%; border-collapse:collapse; min-width:860px; background:rgba(0,0,0,.15)}
th,td{padding:10px; border-bottom:1px solid var(--line); text-align:right; font-size:12px}
th{color:var(--muted); font-weight:900; background:rgba(255,255,255,.04); position:sticky; top:0}
tr:hover td{background:rgba(255,255,255,.03)}
.tag{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;border:1px solid var(--line);
  background:rgba(255,255,255,.03); font-size:12px; color:var(--muted)
}
.tag.good{color:#bff7df; border-color:rgba(24,195,126,.30); background:rgba(24,195,126,.10)}
.tag.bad{color:#ffc0c0; border-color:rgba(255,77,77,.30); background:rgba(255,77,77,.10)}
.tag.warn{color:#ffe0b3; border-color:rgba(255,176,32,.30); background:rgba(255,176,32,.10)}
.toast{
  position:fixed; inset:auto 14px 14px 14px; max-width:720px; margin:0 auto;
  display:none; gap:10px; align-items:flex-start;
  background:rgba(10,16,30,.92);
  border:1px solid var(--line);
  border-radius:18px; padding:12px;
  box-shadow:var(--shadow);
  z-index:120;
}
.toast.show{display:flex}
.toast .dot{width:10px;height:10px;border-radius:999px;background:var(--green); margin-top:6px}
.toast .msg{font-size:13px; line-height:1.4}
.drawerOverlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:60}
.drawerOverlay.show{display:block}
.drawer{
  position:fixed; inset:0 auto 0 0; width:min(320px, 88vw);
  background:linear-gradient(180deg, rgba(15,26,51,.98), rgba(11,18,32,.98));
  border-right:1px solid var(--line);
  transform:translateX(-105%); transition:transform .25s ease;
  z-index:70;
  padding:14px;
  display:flex; flex-direction:column; gap:12px;
}
.drawer.show{transform:translateX(0)}
.nav{display:flex; flex-direction:column; gap:8px}
.nav button{
  width:100%;
  text-align:right;
  padding:12px;
  border-radius:16px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  color:var(--text);
  cursor:pointer;
  font-weight:900;
}
.nav button.active{border-color:rgba(43,107,255,.55); background:rgba(43,107,255,.15)}
.kpis{display:grid; gap:10px}
@media(min-width:820px){.kpis{grid-template-columns:repeat(4,1fr)}}
.kpi{padding:12px;border:1px solid var(--line); border-radius:18px; background:rgba(255,255,255,.03)}
.kpi b{display:block; font-size:12px; color:var(--muted)}
.kpi span{display:block; font-size:18px; font-weight:1000; margin-top:6px}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  border:1px solid var(--line); border-radius:16px; padding:10px 12px;
  background:rgba(255,255,255,.03);
  font-size:12px; color:var(--muted)
}
.loginTabs{display:flex; gap:10px; flex-wrap:wrap}
.loginTabs .btn{flex:1}
.hint{font-size:12px;color:var(--muted)}
.printArea{direction:rtl; font-family:var(--font); color:#111}
.printTitle{font-size:20px;font-weight:900;margin:0 0 10px}
.printSub{margin:0 0 10px; color:#333}
.printBox{border:1px solid #ddd; border-radius:12px; padding:12px}
.printTable{width:100%; border-collapse:collapse}
.printTable th,.printTable td{border-bottom:1px solid #eee; padding:8px; font-size:12px; text-align:right}

.nav button.danger{background:rgba(255,77,77,.12); border-color:rgba(255,77,77,.35)}
.nav button.danger:hover{background:rgba(255,77,77,.18)}

</style>
<script>
/* ====== Payroll App (Static / LocalStorage) ====== */
const APP_KEY = "payrollApp_v1";

function deepClone(v){ return JSON.parse(JSON.stringify(v)); }
function uid(prefix="id"){ return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`; }
function toast(msg, type="ok"){
  const el = document.getElementById("toast");
  if(!el) return;
  const dot = el.querySelector(".dot");
  dot.style.background = type==="bad" ? "var(--red)" : (type==="warn" ? "var(--amber)" : "var(--green)");
  el.querySelector(".msg").textContent = msg;
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>el.classList.remove("show"), 2600);
}
function fmtMoney(n){
  n = Number(n);
  if(!isFinite(n)) n = 0;
  return (Math.round(n*100)/100).toLocaleString('ar-EG', {minimumFractionDigits:2, maximumFractionDigits:2});
}
function nowISODate(){
  const d=new Date();
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function yyyymm(d=new Date()){
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0');
  return `${yyyy}-${mm}`;
}
function prevYYYYMM(ym){
  const [y,m]=ym.split('-').map(Number);
  const d=new Date(y, m-1, 1);
  d.setMonth(d.getMonth()-1);
  return yyyymm(d);
}
function parseTimeToMinutes(hhmm){
  if(!hhmm) return null;
  const m=/^(\d{1,2}):(\d{2})$/.exec(String(hhmm).trim());
  if(!m) return null;
  const h=Number(m[1]), mi=Number(m[2]);
  if(h<0||h>23||mi<0||mi>59) return null;
  return h*60+mi;
}
function minutesToHHMM(min){
  min = Math.max(0, Math.floor(min));
  const h=Math.floor(min/60), m=min%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

function getApp(){
  try{
    const raw = localStorage.getItem(APP_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function setApp(obj){ localStorage.setItem(APP_KEY, JSON.stringify(obj)); }
function ensureApp(){
  let app = getApp();
  const ym = yyyymm();
  if(!app){
    app = {
      company:{ companyName:"", companyLogo:"" },
      departments:[],
      employees:[],
      managers:[{ id: uid("mgr"), username:"manager", password:"manager123" }],
      monthSettings:{},
      attendance:{},
      advances:{},
      advancesList:[]
    };
  }
  if(!Array.isArray(app.managers) || !app.managers.find(m=>m.username==="manager")){
    app.managers = Array.isArray(app.managers) ? app.managers : [];
    app.managers.push({ id: uid("mgr"), username:"manager", password:"manager123" });
  }
  if(!app.monthSettings) app.monthSettings = {};
  if(!app.monthSettings[ym]){
    const d=new Date();
    const daysInMonth = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    app.monthSettings[ym] = {
      daysInMonth,
      workHoursInMonth: 176,
      shiftStart:"09:00",
      shiftEnd:"17:00",
      lateGraceMinutes: 10,
      earlyLeaveGraceMinutes: 10,
      latePenaltyMultiplier: 1.5,
      earlyPenaltyMultiplier: 1.5,
      overtimeMultiplier: 1.5
    };
  }
  if(!app.attendance) app.attendance = {};
  if(!app.advances) app.advances = {};

  if(!Array.isArray(app.advancesList)) app.advancesList = [];
  if(app.advances && Object.keys(app.advances).length && app.advancesList.length===0){
    try{
      for(const ymKey of Object.keys(app.advances||{})){
        const m = app.advances[ymKey]||{};
        for(const empId of Object.keys(m||{})){
          const a = m[empId]||{};
          const amount = Number(a.amount||0);
          if(!amount) continue;
          app.advancesList.push({
            id: uid("adv"),
            date: `${ymKey}-01`,
            ym: ymKey,
            employeeId: empId,
            amount,
            note: (a.note||"").trim() || "â€” (Ù…Ù‡Ø§Ø¬Ø±Ø© Ù…Ù† Ù†Ø³Ø®Ø© Ù‚Ø¯ÙŠÙ…Ø©)"
          });
        }
      }
    }catch(e){}
  }

  if(!app.departments) app.departments = [];
  if(!app.employees) app.employees = [];
  if(!app.company) app.company = { companyName:"", companyLogo:"" };
  setApp(app);
  return app;
}
function updateApp(mutator){
  const app = ensureApp();
  const draft = deepClone(app);
  mutator(draft);
  setApp(draft);
  return draft;
}

function sessionSet(obj){ sessionStorage.setItem(`${APP_KEY}:session`, JSON.stringify(obj)); }
function sessionGet(){ try{ return JSON.parse(sessionStorage.getItem(`${APP_KEY}:session`)||"null"); }catch(e){ return null; } }
function sessionClear(){ sessionStorage.removeItem(`${APP_KEY}:session`); }

function requireRole(roles){
  const s = sessionGet();
  if(!s || !roles.includes(s.role)) return null;
  return s;
}

function csvParse(text){
  const rows = [];
  const lines = String(text||"").replace(/\r/g,"").split("\n").filter(l=>l.trim().length);
  if(!lines.length) return rows;
  const sep = (lines[0].includes(";") && !lines[0].includes(",")) ? ";" : ",";
  for(const line of lines){
    const out=[];
    let cur="", inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){
        if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
        else inQ = !inQ;
      }else if(ch===sep && !inQ){
        out.push(cur.trim()); cur="";
      }else cur+=ch;
    }
    out.push(cur.trim());
    rows.push(out);
  }
  return rows;
}
function csvStringify(rows){
  return rows.map(r => r.map(v=>{
    const s=String(v??"");
    if(/[",\n;]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }).join(",")).join("\n");
}
function downloadText(filename, text, mime="text/plain;charset=utf-8"){
  const blob=new Blob([text],{type:mime});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
}
function downloadJSON(filename, obj){ downloadText(filename, JSON.stringify(obj,null,2), "application/json;charset=utf-8"); }

async function readFileText(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(String(fr.result||""));
    fr.onerror=()=>rej(fr.error||new Error("FileReader error"));
    fr.readAsText(file,"utf-8");
  });
}

/* ====== Payroll Logic ====== */
function computeDayMetrics(settings, rec){
  // returns {lateMinutes, earlyLeaveMinutes, overtimeMinutes, absent}
  const s=settings;
  const start = parseTimeToMinutes(s.shiftStart);
  const end = parseTimeToMinutes(s.shiftEnd);
  const checkIn = parseTimeToMinutes(rec.checkIn);
  const checkOut = parseTimeToMinutes(rec.checkOut);

  const excuse = rec.excuseType || "none";
  const hasTimes = (checkIn!=null && checkOut!=null);

  let late=0, early=0, ot=0, absent=false;

  if(!hasTimes){
    // no in/out -> absent
    absent=true;
  }else{
    if(checkIn>start){
      late = Math.max(0, checkIn - start - Number(s.lateGraceMinutes||0));
    }
    if(checkOut<end){
      early = Math.max(0, end - checkOut - Number(s.earlyLeaveGraceMinutes||0));
    }
    if(checkOut>end){
      ot = Math.max(0, checkOut - end);
    }
  }

  if(excuse==="late_excused") late=0;
  if(excuse==="early_excused") early=0;
  if(excuse==="absent_excused"){ absent=true; late=0; early=0; ot=0; }

  return { lateMinutes:late, earlyLeaveMinutes:early, overtimeMinutes:ot, absent };
}

function computePayrollForEmployee(app, emp, ym){
  const settings = app.monthSettings[ym] || app.monthSettings[yyyymm()] || {};
  const workHoursInMonth = Number(settings.workHoursInMonth||176);
  const hourValue = (Number(emp.monthlySalary||0) / (workHoursInMonth || 1));

  // advances (multiple records by date)
  const advances = sumAdvancesForMonth(app, ym, emp.id);
// attendance records for month
  let lateMin=0, earlyMin=0, otMin=0;
  let absentExcusedDays=0, absentNoExcuseDays=0;
  const rows = [];

  for(const dateKey of Object.keys(app.attendance||{})){
    if(!dateKey.startsWith(ym+"-")) continue;
    const day = app.attendance[dateKey] || {};
    const rec = day[emp.id];
    if(!rec) continue;

    const m = computeDayMetrics(settings, rec);
    lateMin += m.lateMinutes;
    earlyMin += m.earlyLeaveMinutes;
    otMin += m.overtimeMinutes;

    if(m.absent){
      if((rec.excuseType||"none")==="absent_excused") absentExcusedDays += 1;
      else if(!rec.checkIn && !rec.checkOut) absentNoExcuseDays += 1;
    }

    rows.push({
      date: dateKey,
      checkIn: rec.checkIn || "",
      checkOut: rec.checkOut || "",
      excuseType: rec.excuseType || "none",
      outOfFactory: !!rec.outOfFactory,
      note: rec.note || "",
      ...m
    });
  }

  // Deduction & additions
  const lateDeduction = (lateMin/60) * hourValue * Number(settings.latePenaltyMultiplier||1.5);
  const earlyDeduction = (earlyMin/60) * hourValue * Number(settings.earlyPenaltyMultiplier||1.5);
  const otValue = (otMin/60) * hourValue * Number(settings.overtimeMultiplier||1.5);

  // absent without excuse -> deduct full day based on salary/daysInMonth, multiplier
  const daysInMonth = Number(settings.daysInMonth||30);
  const dayValue = (Number(emp.monthlySalary||0) / (daysInMonth || 1));
  const absenceNoExcuseFactor = Number((settings.absenceNoExcuseFactor ?? 1.0));
  const absenceNoExcuseDeduction = absentNoExcuseDays * dayValue * absenceNoExcuseFactor;

  const base = Number(emp.monthlySalary||0);

  // if employee has no attendance at all in month => net=0 (as requested in spec)
  const hasAny = rows.length > 0;
  let net = base + otValue - lateDeduction - earlyDeduction - absenceNoExcuseDeduction - advances;
  if(!hasAny) net = 0;

  return {
    ym,
    hourValue,
    baseSalary: base,
    totals:{
      baseSalary: base,
      lateMinutes: lateMin,
      earlyLeaveMinutes: earlyMin,
      overtimeMinutes: otMin,
      absentExcusedDays,
      absentNoExcuseDays,
      advances,
      lateDeduction,
      earlyDeduction,
      overtimeValue: otValue,
      absenceNoExcuseDeduction,
      net
    },
    rows: rows.sort((a,b)=>a.date.localeCompare(b.date))
  };
}

/* ====== Printing (Receipt PDF via Print) ====== */
function openReceiptPrintWindow(app, emp, ym){
  const dept = (app.departments||[]).find(d=>d.id===emp.departmentId);
  const payroll = computePayrollForEmployee(app, emp, ym);
  const companyName = (app.company?.companyName || "").trim() || "â€”";
  const logo = app.company?.companyLogo || "";

  const rowsHtml = payroll.rows.map(r=>{
    const exMap = {
      none:"Ø¨Ø¯ÙˆÙ†",
      late_excused:"ØªØ£Ø®ÙŠØ± Ø¨Ø¹Ø°Ø±",
      early_excused:"Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ± Ø¨Ø¹Ø°Ø±",
      absent_excused:"ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±"
    };
    return `<tr>
      <td>${r.date}</td>
      <td>${r.checkIn||"â€”"}</td>
      <td>${r.checkOut||"â€”"}</td>
      <td>${exMap[r.excuseType]||"Ø¨Ø¯ÙˆÙ†"}</td>
      <td>${r.outOfFactory?"Ù†Ø¹Ù…":"Ù„Ø§"}</td>
      <td>${(r.note||"").replace(/</g,"&lt;")}</td>
    </tr>`;
  }).join("");

  const html = `<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ØµÙƒ Ù‚Ø¨Ø¶ - ${emp.name}</title>
  <style>
    body{font-family: ui-sans-serif, system-ui, "Noto Kufi Arabic","Noto Sans Arabic", Tahoma, Arial; background:#fff; color:#111; margin:0; padding:18px}
    .row{display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .box{border:1px solid #e6e6e6; border-radius:14px; padding:14px}
    .logo{width:54px;height:54px;border-radius:14px; overflow:hidden; border:1px solid #eee; display:grid; place-items:center}
    .logo img{width:100%;height:100%;object-fit:cover}
    h1{margin:0; font-size:20px}
    p{margin:6px 0 0; color:#333; font-size:12px}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{border-bottom:1px solid #eee; padding:8px; font-size:12px; text-align:right}
    th{background:#fafafa}
    .k{color:#666; font-size:12px}
    .v{font-weight:800}
    .sig{display:flex; gap:14px; margin-top:16px}
    .sig .s{flex:1; border-top:1px dashed #bbb; padding-top:10px; text-align:center; color:#333}
    @media print{ body{padding:0} .noPrint{display:none} }
  </style>
  </head><body>
    <div class="noPrint" style="margin-bottom:10px">
      <button onclick="window.print()" style="padding:10px 12px; border-radius:12px; border:1px solid #ddd; background:#0b1220; color:#fff; font-weight:800; cursor:pointer">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
    </div>

    <div class="box">
      <div class="row">
        <div class="row" style="gap:10px">
          <div class="logo">${logo ? `<img src="${logo}"/>` : `<span style="font-weight:900;color:#0b1220">ğŸ¢</span>`}</div>
          <div>
            <h1>ØµÙƒ Ù‚Ø¨Ø¶ Ø±Ø§ØªØ¨</h1>
            <p>${companyName}</p>
          </div>
        </div>
        <div style="text-align:left">
          <div class="k">Ø§Ù„Ø´Ù‡Ø±</div>
          <div class="v">${ym}</div>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <div><span class="k">Ø§Ù„Ù…ÙˆØ¸Ù:</span> <span class="v">${emp.name}</span></div>
        <div><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span> <span class="v">${dept?dept.name:"â€”"}</span></div>
        <div><span class="k">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:</span> <span class="v">${fmtMoney(payroll.totals.baseSalary)}</span></div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¯Ø®ÙˆÙ„</th><th>Ø§Ù„Ø®Ø±ÙˆØ¬</th><th>Ø§Ù„Ø¹Ø°Ø±</th><th>Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ØµÙ†Ø¹</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml || `<tr><td colspan="6" style="text-align:center;color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</td></tr>`}
        </tbody>
      </table>

      <div class="row" style="margin-top:12px">
        <div><span class="k">Ø¥Ø¶Ø§ÙÙŠ (Ø¯Ù‚Ø§Ø¦Ù‚):</span> <span class="v">${payroll.totals.overtimeMinutes}</span></div>
        <div><span class="k">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ:</span> <span class="v">${fmtMoney(payroll.totals.overtimeValue)}</span></div>
        <div><span class="k">ØªØ£Ø®ÙŠØ± (Ø¯Ù‚Ø§Ø¦Ù‚):</span> <span class="v">${payroll.totals.lateMinutes}</span></div>
        <div><span class="k">Ø®ØµÙ… Ø§Ù„ØªØ£Ø®ÙŠØ±:</span> <span class="v">${fmtMoney(payroll.totals.lateDeduction)}</span></div>
        <div><span class="k">Ù…Ø¨ÙƒØ± (Ø¯Ù‚Ø§Ø¦Ù‚):</span> <span class="v">${payroll.totals.earlyLeaveMinutes}</span></div>
        <div><span class="k">Ø®ØµÙ… Ø§Ù„Ù…Ø¨ÙƒØ±:</span> <span class="v">${fmtMoney(payroll.totals.earlyDeduction)}</span></div>
        <div><span class="k">ØºÙŠØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø± (Ø£ÙŠØ§Ù…):</span> <span class="v">${payroll.totals.absentNoExcuseDays}</span></div>
        <div><span class="k">Ø®ØµÙ… Ø§Ù„ØºÙŠØ§Ø¨:</span> <span class="v">${fmtMoney(payroll.totals.absenceNoExcuseDeduction)}</span></div>
        <div><span class="k">Ø§Ù„Ø³Ù„Ù:</span> <span class="v">${fmtMoney(payroll.totals.advances)}</span></div>
        <div style="flex:1"></div>
        <div style="min-width:220px"><span class="k">Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span> <span class="v" style="font-size:16px">${fmtMoney(payroll.totals.net)}</span></div>
      </div>

      <div class="sig">
        <div class="s">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸Ù</div>
        <div class="s">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
      </div>
    </div>
  </body></html>`;

  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* ====== UI helpers ====== */
function setBrandFromCompany(){
  const app = ensureApp();
  const name = (app.company?.companyName||"").trim() || "Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ù… ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨";
  const elName = document.querySelector("[data-company-name]");
  if(elName) elName.textContent = name;
  const img = document.querySelector("[data-company-logo]");
  if(img){
    if(app.company?.companyLogo){
      img.src = app.company.companyLogo;
      img.style.display="block";
    }else{
      img.removeAttribute("src");
      img.style.display="none";
    }
  }
}
function drawerInit(){
  const overlay = document.getElementById("drawerOverlay");
  const drawer = document.getElementById("drawer");
  const btn = document.getElementById("btnMenu");
  function close(){ overlay?.classList.remove("show"); drawer?.classList.remove("show"); }
  function open(){ overlay?.classList.add("show"); drawer?.classList.add("show"); }
  btn?.addEventListener("click", open);
  overlay?.addEventListener("click", close);
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") close(); });
  return {open,close};
}
function switchSection(id){
  document.querySelectorAll("[data-section]").forEach(el=>el.style.display="none");
  const target = document.querySelector(`[data-section="${id}"]`);
  if(target) target.style.display="block";
  document.querySelectorAll("[data-nav]").forEach(b=>{
    b.classList.toggle("active", b.getAttribute("data-nav")===id);
  });
  sessionStorage.setItem(`${APP_KEY}:lastSection`, id);
}
function restoreLastSection(defaultId){
  const id = sessionStorage.getItem(`${APP_KEY}:lastSection`) || defaultId;
  switchSection(id);
}

</script>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">
      <div class="logo"><img data-company-logo style="display:none"/></div>
      <div class="txt">
        <b data-company-name>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ù… ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</b>
        <span id="empSub">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¸Ù â€¢ Ø¹Ø±Ø¶ ÙÙ‚Ø·</span>
      </div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="btnMenu">â˜°</button>
    </div>
  </div>

  <div id="drawerOverlay" class="drawerOverlay"></div>
  <aside id="drawer" class="drawer" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
    <div class="brand" style="justify-content:space-between">
      <div class="txt">
        <b>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</b>
        <span>Ù…ÙˆØ¸Ù</span>
      </div>
      <button class="btn ghost" id="btnCloseDrawer">âœ•</button>
    </div>
    <div class="nav">
      <button id="btnCurr">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
      <button id="btnPrev">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button id="btnPrintDrawer">Ø·Ø¨Ø§Ø¹Ø© ØµÙƒ Ø§Ù„Ù‚Ø¨Ø¶</button>
      <button id="btnLogout" class="danger">Ø®Ø±ÙˆØ¬</button>
    </div>
    <div class="small">Ø¹Ø±Ø¶ ÙÙ‚Ø· â€” Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù.</div>
  </aside>

  <div style="height:14px"></div>

  <div class="card">
    <div class="hd">
      <div>
        <h2 id="empTitle">â€”</h2>
        <p id="empMonth">â€”</p>
      </div>
      <button class="btn ghost" id="btnPrint">Ø·Ø¨Ø§Ø¹Ø© ØµÙƒ Ù‚Ø¨Ø¶</button>
    </div>
    <div class="bd">
      <div class="kpis">
        <div class="kpi"><b>Ø¥Ø¶Ø§ÙÙŠ (Ø¯Ù‚Ø§Ø¦Ù‚)</b><span id="kOt">0</span></div>
        <div class="kpi"><b>ØªØ£Ø®ÙŠØ± (Ø¯Ù‚Ø§Ø¦Ù‚)</b><span id="kLate">0</span></div>
        <div class="kpi"><b>Ù…Ø¨ÙƒØ± (Ø¯Ù‚Ø§Ø¦Ù‚)</b><span id="kEarly">0</span></div>
        <div class="kpi"><b>Ø§Ù„Ù…Ø³ØªØ­Ù‚</b><span id="kNet">0</span></div>
      </div>

      <div style="height:10px"></div>

      <div class="tableWrap">
        <table>
          <thead><tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¯Ø®ÙˆÙ„</th><th>Ø§Ù„Ø®Ø±ÙˆØ¬</th><th>Ø§Ù„Ø¹Ø°Ø±</th><th>Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ØµÙ†Ø¹</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
          </tr></thead>
          <tbody id="empTable"></tbody>
        </table>
      </div>

      <div style="height:10px"></div>
      <div class="small">Ø§Ù„Ù…ØªØ§Ø­: Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ + Ø´Ù‡Ø± Ø³Ø§Ø¨Ù‚ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·.</div>
    </div>
  </div>
</div>

<script>
const s = requireRole(["employee"]);
if(!s){ location.href="index.html"; }
ensureApp();
setBrandFromCompany();

let currentYM = yyyymm();
const prevYM = prevYYYYMM(currentYM);

function getEmployee(){
  const app=ensureApp();
  return (app.employees||[]).find(e=>e.id===s.empId) || null;
}
function getDeptName(emp){
  const app=ensureApp();
  const d=(app.departments||[]).find(x=>x.id===emp.departmentId);
  return d?d.name:"â€”";
}

function renderMonth(ym){
  const app=ensureApp();
  const emp=getEmployee();
  if(!emp){ toast("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù.", "bad"); return; }

  document.getElementById("empTitle").textContent = `${emp.name} â€” ${getDeptName(emp)}`;
  document.getElementById("empMonth").textContent = `Ø§Ù„Ø´Ù‡Ø±: ${ym}`;

  const pr = computePayrollForEmployee(app, emp, ym);
  document.getElementById("kOt").textContent = pr.totals.overtimeMinutes;
  document.getElementById("kLate").textContent = pr.totals.lateMinutes;
  document.getElementById("kEarly").textContent = pr.totals.earlyLeaveMinutes;
  document.getElementById("kNet").textContent = fmtMoney(pr.totals.net);

  const exMap={none:"Ø¨Ø¯ÙˆÙ†", late_excused:"ØªØ£Ø®ÙŠØ± Ø¨Ø¹Ø°Ø±", early_excused:"Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ± Ø¨Ø¹Ø°Ø±", absent_excused:"ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±"};
  const tb=document.getElementById("empTable");
  tb.innerHTML="";
  for(const r of pr.rows){
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${r.date}</td><td>${r.checkIn||"â€”"}</td><td>${r.checkOut||"â€”"}</td><td>${exMap[r.excuseType]||"Ø¨Ø¯ÙˆÙ†"}</td><td>${r.outOfFactory?"Ù†Ø¹Ù…":"Ù„Ø§"}</td><td>${r.note||""}</td>`;
    tb.appendChild(tr);
  }
  if(pr.rows.length===0){
    const tr=document.createElement("tr");
    tr.innerHTML = `<td colspan="6" style="text-align:center;color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</td>`;
    tb.appendChild(tr);
  }
}

document.getElementById("btnCurr").addEventListener("click", ()=>{
  currentYM = yyyymm();
  renderMonth(currentYM);
});
document.getElementById("btnPrev").addEventListener("click", ()=>{
  currentYM = prevYM;
  renderMonth(currentYM);
});
document.getElementById("btnLogout").addEventListener("click", ()=>{
  sessionClear(); location.href="index.html";
});
document.getElementById("btnPrint").addEventListener("click", ()=>{
  const app=ensureApp();
  const emp=getEmployee();
  if(!emp) return;
  openReceiptPrintWindow(app, emp, currentYM);
});

renderMonth(currentYM);
</script>


<div id="toast" class="toast" role="status" aria-live="polite">
  <div class="dot"></div>
  <div class="msg"></div>
</div>
</body>
</html>

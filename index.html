<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ERP Ù…Ø­Ø§Ø³Ø¨Ø© + ØªØµÙ†ÙŠØ¹ + Ù…Ø±Ø§ÙƒØ² ÙƒÙ„ÙØ© (Ù†Ø³Ø®Ø© Frontend)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Excel + PDF -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#070f1f;
      --card:#0f1a2f;
      --card2:#101f3a;
      --text:#eaf0ff;
      --muted:#a7b3d6;
      --line:rgba(255,255,255,.09);
      --brand:#6ee7ff;
      --brand2:#a78bfa;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow: 0 14px 42px rgba(0,0,0,.38);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Cairo", system-ui, -apple-system, Segoe UI, Arial;
      background:
        radial-gradient(900px 520px at 15% 10%, rgba(110,231,255,.16), transparent 60%),
        radial-gradient(820px 520px at 85% 0%, rgba(167,139,250,.16), transparent 60%),
        radial-gradient(650px 500px at 60% 95%, rgba(52,211,153,.08), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px 14px 96px}
    .topbar{
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(7,15,31,.92), rgba(7,15,31,.55));
      border-bottom:1px solid var(--line);
    }
    .topbar .inner{max-width:1200px;margin:0 auto;padding:12px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(110,231,255,.95), rgba(167,139,250,.95));
      box-shadow: 0 14px 35px rgba(110,231,255,.12);
      position:relative;
    }
    .logo::after{content:""; position:absolute; inset:10px;border-radius:10px;background: rgba(7,15,31,.35);border:1px solid rgba(255,255,255,.18);}
    .title{line-height:1.15}
    .title b{display:block;font-size:14px}
    .title small{color:var(--muted);font-size:12px}
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding:8px 10px;border-radius:999px;
      display:flex;gap:8px;align-items:center;
      color:var(--muted);font-size:12px;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;font-weight:900;
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      transition: transform .08s ease, background .2s ease;
      user-select:none; white-space:nowrap;
    }
    .btn:active{transform:scale(.98)}
    .btn.primary{border-color:transparent;background: linear-gradient(135deg, rgba(110,231,255,.95), rgba(167,139,250,.95));color:#081028;}
    .btn.danger{border-color: rgba(251,113,133,.35);background: rgba(251,113,133,.08);color:#ffd8df;}
    .btn.good{border-color: rgba(52,211,153,.35);background: rgba(52,211,153,.08);color:#d8fff0;}
    .btn.warn{border-color: rgba(251,191,36,.35);background: rgba(251,191,36,.08);color:#fff2cc;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;gap:12px}
    .cols{grid-template-columns: 1.15fr .85fr}
    @media (max-width: 980px){ .cols{grid-template-columns: 1fr} }
    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,26,47,.92), rgba(15,26,47,.72));
      box-shadow: var(--shadow);
      border-radius: var(--r);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex;justify-content:space-between;align-items:flex-start;gap:10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
    }
    .card .hd .h{font-weight:900;font-size:14px;display:flex;gap:8px;align-items:center}
    .card .hd .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .card .bd{padding:14px}
    .field{display:flex;flex-direction:column;gap:6px;min-width:170px;flex:1}
    .field label{font-size:12px;color:var(--muted)}
    input, select, textarea{
      width:100%; border:1px solid var(--line); background: rgba(255,255,255,.04);
      color:var(--text); border-radius:14px; padding:11px 12px; outline:none; font-family: inherit;
    }
    textarea{min-height:92px;resize:vertical}
    input::placeholder, textarea::placeholder{color:rgba(167,179,214,.7)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);text-align:right;font-size:13px;vertical-align:top}
    th{color:var(--muted);font-size:12px}
    tr:hover td{background:rgba(255,255,255,.02)}
    .badge{
      display:inline-flex;gap:6px;align-items:center;
      padding:5px 8px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:900px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{border:1px solid var(--line);background: rgba(255,255,255,.04);border-radius:16px;padding:12px}
    .kpi .box b{display:block;font-size:16px}
    .kpi .box small{color:var(--muted)}
    .toast{
      position:fixed; bottom:14px; left:14px; right:14px;
      max-width:1200px; margin:0 auto;
      display:flex;justify-content:center;
      pointer-events:none; z-index:80;
    }
    .toast .msg{
      pointer-events:auto;
      background: rgba(16,31,58,.94);
      border:1px solid rgba(255,255,255,.18);
      padding:10px 12px;border-radius:14px;
      box-shadow: var(--shadow);
      color:var(--text); font-weight:900;
      display:flex; gap:10px; align-items:center;
      max-width:920px;
    }
    .hide{display:none !important}
    .center{display:flex;align-items:center;justify-content:center;min-height: calc(100vh - 100px);}
    .loginCard{max-width:560px;width:100%}
    .footerbar{
      position:fixed; bottom:0; left:0; right:0;
      background: linear-gradient(to top, rgba(7,15,31,.92), rgba(7,15,31,.55));
      border-top:1px solid var(--line);
      backdrop-filter: blur(10px);
      z-index:35;
    }
    .footerbar .inner{max-width:1200px;margin:0 auto;padding:10px 14px;display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    /* Drawer menu */
    .drawerOverlay{position:fixed; inset:0; background:rgba(0,0,0,.48); z-index:55;}
    .drawer{
      position:fixed; top:0; right:0; height:100%;
      width:min(92vw, 380px);
      background: linear-gradient(180deg, rgba(16,31,58,.97), rgba(15,26,47,.92));
      border-left:1px solid rgba(255,255,255,.14);
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
      z-index:60;
      border-top-left-radius: 22px;
      border-bottom-left-radius: 22px;
      overflow:hidden;
    }
    .drawerHd{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .drawerTitle{display:flex; gap:10px; align-items:center}
    .drawerBd{padding:12px; display:grid; gap:10px}
    .drawerSection{display:grid; gap:8px}
    .drawerSectionTitle{font-weight:900;color:var(--muted);font-size:12px;margin:8px 0 4px}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <b id="appTitle">ERP Ù…Ø­Ø§Ø³Ø¨Ø© + ØªØµÙ†ÙŠØ¹ + Ù…Ø±Ø§ÙƒØ² ÙƒÙ„ÙØ©</b>
          <small id="appSub">Frontend ÙÙ‚Ø· â€¢ GitHub Pages â€¢ LocalStorage + Backup</small>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="btnMenu" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">â˜°</button>
        <div class="pill" id="userPill"><span>ğŸ”’</span><span class="muted">ØºÙŠØ± Ù…Ø³Ø¬Ù„</span></div>
      </div>
    </div>
  </div>

  <div class="drawerOverlay hide" id="drawerOverlay"></div>
  <aside class="drawer hide" id="drawer" aria-label="Ù‚Ø§Ø¦Ù…Ø©">
    <div class="drawerHd">
      <div class="drawerTitle">
        <div class="logo" style="width:34px;height:34px;border-radius:14px"></div>
        <div>
          <b style="display:block;font-size:13px">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</b>
          <small style="color:var(--muted);font-size:12px" id="drawerUser">ØºÙŠØ± Ù…Ø³Ø¬Ù„</small>
        </div>
      </div>
      <button class="btn" id="btnCloseDrawer" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
    </div>

    <div class="drawerBd">
      <div class="drawerSection">
        <div class="drawerSectionTitle">Ø§Ù„ØªÙ†Ù‚Ù„</div>
        <button class="btn" data-nav="dashboard">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
        <button class="btn" data-nav="masters">ğŸ§© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</button>
        <button class="btn" data-nav="coa">ğŸ§± Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
        <button class="btn" data-nav="purchases">ğŸ§¾ Ø§Ù„Ø´Ø±Ø§Ø¡</button>
        <button class="btn" data-nav="mfg">ğŸ­ Ø§Ù„ØªØµÙ†ÙŠØ¹</button>
        <button class="btn" data-nav="sales">ğŸ§¾ Ø§Ù„Ø¨ÙŠØ¹</button>
        <button class="btn" data-nav="journal">ğŸ§¾ Ø§Ù„Ù‚ÙŠÙˆØ¯</button>
        <button class="btn" data-nav="vouchers">ğŸ’³ Ø§Ù„Ø³Ù†Ø¯Ø§Øª</button>
        <button class="btn" data-nav="reports">ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
      </div>

      <div class="hr"></div>

      <div class="drawerSection">
        <div class="drawerSectionTitle">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
        <button class="btn" id="btnBackup">â¬‡ï¸ Backup JSON</button>
        <button class="btn" id="btnRestore">â¬†ï¸ Restore JSON</button>
        <button class="btn" id="btnExportXlsx">ğŸ“— Excel</button>
      </div>

      <div class="hr"></div>

      <button class="btn danger" id="btnLogout">Ø®Ø±ÙˆØ¬</button>

      <div class="hr"></div>
      <div style="color:var(--muted);font-size:12px;line-height:1.7">
        âœ… ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ± â€¢ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ<br>
        ğŸ’¾ Ø®Ø° Backup Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù‚Ø¨Ù„ Ø£ÙŠ ØªØºÙŠÙŠØ±Ø§Øª
      </div>
    </div>
  </aside>

  <div class="wrap">
    <!-- LOGIN -->
    <div id="viewLogin" class="center">
      <div class="card loginCard">
        <div class="hd">
          <div>
            <div class="h">ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
            <div class="sub">Admin Ø§ÙØªØ±Ø§Ø¶ÙŠ â€“ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±</div>
          </div>
          <span class="badge">Admin: <span class="mono">admin / admin123</span></span>
        </div>
        <div class="bd grid" style="gap:12px">
          <div class="row">
            <div class="field">
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
              <input id="loginUser" placeholder="admin" autocomplete="username">
            </div>
            <div class="field">
              <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
              <input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
            </div>
          </div>
          <div class="row">
            <button class="btn primary" id="btnLogin" style="flex:1">Ø¯Ø®ÙˆÙ„</button>
          </div>
          <div class="hr"></div>
          <div style="color:var(--muted);font-size:12px;line-height:1.7">
            â€¢ Ù…Ø­Ø§Ø³Ø¨Ø© Ù…Ø²Ø¯ÙˆØ¬Ø© + Ù…Ø±Ø§ÙƒØ² ÙƒÙ„ÙØ©<br>
            â€¢ ØªØµÙ†ÙŠØ¹ (BOM + Ø£ÙˆØ§Ù…Ø± Ø¥Ù†ØªØ§Ø¬) + WIP/FG<br>
            â€¢ Backup/Restore + Excel + PDF<br>
          </div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="viewApp" class="hide">
      <div class="grid cols">

        <div class="grid">

          <div class="card" id="panelDashboard">
            <div class="hd">
              <div>
                <div class="h">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
                <div class="sub">Ù…Ù„Ø®Øµ Ø£Ø±Ø¨Ø§Ø­/Ø®Ø³Ø§Ø¦Ø± + Ù†Ø¸Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„ØªØµÙ†ÙŠØ¹</div>
              </div>
              <div class="row">
                <span class="badge" id="fyBadge">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©: â€”</span>
                <span class="badge" id="curBadge">Ø§Ù„Ø¹Ù…Ù„Ø©: â€”</span>
              </div>
            </div>
            <div class="bd">
              <div class="kpi">
                <div class="box"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</small><b id="kpiRevenue">0</b></div>
                <div class="box"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</small><b id="kpiExpense">0</b></div>
                <div class="box"><small>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</small><b id="kpiNet">0</b></div>
              </div>
              <div class="hr"></div>
              <div class="kpi">
                <div class="box"><small>Ù‚ÙŠÙ…Ø© Ù…Ø®Ø²ÙˆÙ† Ø®Ø§Ù…Ø§Øª</small><b id="kpiRM">0</b></div>
                <div class="box"><small>Ù‚ÙŠÙ…Ø© Ù…Ø®Ø²ÙˆÙ† Ø¥Ù†ØªØ§Ø¬ ØªØ§Ù…</small><b id="kpiFG">0</b></div>
                <div class="box"><small>Ø£ÙˆØ§Ù…Ø± Ø¥Ù†ØªØ§Ø¬ Ù…ÙØªÙˆØ­Ø©</small><b id="kpiWO">0</b></div>
              </div>
              <div class="hr"></div>
              <div class="row">
                <div class="field"><label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label><input type="date" id="dashFrom"></div>
                <div class="field"><label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label><input type="date" id="dashTo"></div>
                <div class="field" style="min-width:220px"><label>&nbsp;</label><button class="btn good" id="btnDashRefresh">ØªØ­Ø¯ÙŠØ«</button></div>
              </div>
            </div>
          </div>

          <div class="card hide" id="panelMasters">
            <div class="hd">
              <div>
                <div class="h">ğŸ§© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
                <div class="sub">Ø¹Ù…Ù„Ø§Ø¡/Ù…ÙˆØ±Ø¯ÙŠÙ†/Ø£ØµÙ†Ø§Ù + Ù…Ø±Ø§ÙƒØ² ÙƒÙ„ÙØ©</div>
              </div>
              <div class="row">
                <button class="btn" id="btnAddCustomer">+ Ø¹Ù…ÙŠÙ„</button>
                <button class="btn" id="btnAddVendor">+ Ù…ÙˆØ±Ø¯</button>
                <button class="btn" id="btnAddItem">+ ØµÙ†Ù</button>
                <button class="btn primary" id="btnAddCC">+ Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ©</button>
              </div>
            </div>
            <div class="bd">
              <div class="field"><label>Ø¨Ø­Ø«</label><input id="masterSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..."></div>
              <div class="hr"></div>

              <div class="grid" style="gap:10px">
                <div class="card" style="background:rgba(255,255,255,.03);box-shadow:none">
                  <div class="hd" style="border-bottom:1px solid var(--line)"><div class="h">ğŸ‘¤ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div></div>
                  <div class="bd" style="padding:0"><div style="overflow:auto;max-height:220px">
                    <table id="customersTable"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th style="min-width:120px">Ø§Ù„Ø±ØµÙŠØ¯</th><th style="min-width:120px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody></tbody></table>
                  </div></div>
                </div>

                <div class="card" style="background:rgba(255,255,255,.03);box-shadow:none">
                  <div class="hd" style="border-bottom:1px solid var(--line)"><div class="h">ğŸ­ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div></div>
                  <div class="bd" style="padding:0"><div style="overflow:auto;max-height:220px">
                    <table id="vendorsTable"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th style="min-width:120px">Ø§Ù„Ø±ØµÙŠØ¯</th><th style="min-width:120px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody></tbody></table>
                  </div></div>
                </div>

                <div class="card" style="background:rgba(255,255,255,.03);box-shadow:none">
                  <div class="hd" style="border-bottom:1px solid var(--line)"><div class="h">ğŸ“¦ Ø§Ù„Ø£ØµÙ†Ø§Ù</div></div>
                  <div class="bd" style="padding:0"><div style="overflow:auto;max-height:260px">
                    <table id="itemsTable"><thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th style="min-width:110px">Ø§Ù„Ù†ÙˆØ¹</th><th style="min-width:120px">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th style="min-width:120px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody></tbody></table>
                  </div></div>
                </div>

                <div class="card" style="background:rgba(255,255,255,.03);box-shadow:none">
                  <div class="hd" style="border-bottom:1px solid var(--line)"><div class="h">ğŸ¯ Ù…Ø±Ø§ÙƒØ² Ø§Ù„ÙƒÙ„ÙØ©</div></div>
                  <div class="bd" style="padding:0"><div style="overflow:auto;max-height:220px">
                    <table id="ccTable"><thead><tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th style="min-width:120px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody></tbody></table>
                  </div></div>
                </div>

              </div>
            </div>
          </div>

          <div class="card hide" id="panelCOA">
            <div class="hd">
              <div>
                <div class="h">ğŸ§± Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
                <div class="sub">Ø´Ø¬Ø±Ø© + Ø­Ø³Ø§Ø¨Ø§Øª ØªØµÙ†ÙŠØ¹ (Ù…ÙˆØ§Ø¯/WIP/FG/COGS)</div>
              </div>
              <button class="btn primary" id="btnAddAccount">+ Ø­Ø³Ø§Ø¨</button>
            </div>
            <div class="bd">
              <div class="field"><label>Ø¨Ø­Ø«</label><input id="coaSearch" placeholder="Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ / Ø§Ø³Ù…..."></div>
              <div class="hr"></div>
              <div id="coaTree" style="font-size:13px;line-height:1.7"></div>
            </div>
          </div>

          <div class="card hide" id="panelPurchases">
            <div class="hd">
              <div>
                <div class="h">ğŸ§¾ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø´Ø±Ø§Ø¡</div>
                <div class="sub">Ù‚ÙŠØ¯ Ø¢Ù„ÙŠ + ØªØ­Ø¯ÙŠØ« Ù…ØªÙˆØ³Ø· ØªÙƒÙ„ÙØ© Ù„Ù„Ù…ÙˆØ§Ø¯</div>
              </div>
              <div class="row"><button class="btn primary" id="btnNewPurchase">+ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡</button></div>
            </div>
            <div class="bd">
              <div class="row">
                <div class="field" style="min-width:240px"><label>Ø¨Ø­Ø«</label><input id="purSearch" placeholder="Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© / Ù…ÙˆØ±Ø¯..."></div>
                <div class="field"><label>Ù…Ù†</label><input type="date" id="purFrom"></div>
                <div class="field"><label>Ø¥Ù„Ù‰</label><input type="date" id="purTo"></div>
                <div class="field" style="min-width:160px"><label>&nbsp;</label><button class="btn" id="btnPurFilter">ÙÙ„ØªØ±Ø©</button></div>
              </div>
              <div class="hr"></div>
              <div style="overflow:auto">
                <table id="purchasesTable"><thead><tr><th style="min-width:110px">Ø±Ù‚Ù…</th><th style="min-width:120px">ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th style="min-width:120px">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th style="min-width:180px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </div>

          <div class="card hide" id="panelMFG">
            <div class="hd">
              <div>
                <div class="h">ğŸ­ Ø§Ù„ØªØµÙ†ÙŠØ¹</div>
                <div class="sub">BOM + Ø£ÙˆØ§Ù…Ø± Ø¥Ù†ØªØ§Ø¬ + ØµØ±Ù Ù…ÙˆØ§Ø¯ + ØªØ­Ù…ÙŠÙ„ ØªØ´ØºÙŠÙ„ + ØªØ³ÙŠÙŠÙ„ Ø¥Ù†ØªØ§Ø¬ ØªØ§Ù…</div>
              </div>
              <div class="row">
                <button class="btn" id="btnAddBOM">+ BOM</button>
                <button class="btn primary" id="btnNewWO">+ Ø£Ù…Ø± Ø¥Ù†ØªØ§Ø¬</button>
              </div>
            </div>
            <div class="bd">
              <div class="row">
                <div class="field" style="min-width:260px"><label>Ø¨Ø­Ø«</label><input id="mfgSearch" placeholder="BOM / Ø£Ù…Ø± Ø¥Ù†ØªØ§Ø¬ / Ù…Ù†ØªØ¬..."></div>
                <div class="field"><label>Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ© (ÙÙ„ØªØ±Ø©)</label><select id="mfgCCFilter"></select></div>
                <div class="field" style="min-width:160px"><label>&nbsp;</label><button class="btn" id="btnMfgFilter">ØªØ­Ø¯ÙŠØ«</button></div>
              </div>
              <div class="hr"></div>

              <div class="grid" style="gap:12px">
                <div class="card" style="background:rgba(255,255,255,.03);box-shadow:none">
                  <div class="hd" style="border-bottom:1px solid var(--line)"><div class="h">ğŸ§¾ BOM</div></div>
                  <div class="bd" style="padding:0"><div style="overflow:auto;max-height:260px">
                    <table id="bomTable"><thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th style="min-width:100px">ÙˆØ­Ø¯Ø©</th><th style="min-width:120px">ØªÙƒÙ„ÙØ© Ù…Ø¹ÙŠØ§Ø±ÙŠØ©</th><th style="min-width:160px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody></tbody></table>
                  </div></div>
                </div>

                <div class="card" style="background:rgba(255,255,255,.03);box-shadow:none">
                  <div class="hd" style="border-bottom:1px solid var(--line)"><div class="h">ğŸ“Œ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬</div></div>
                  <div class="bd" style="padding:0"><div style="overflow:auto;max-height:320px">
                    <table id="woTable"><thead><tr>
                      <th style="min-width:110px">Ø±Ù‚Ù…</th><th style="min-width:120px">ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th style="min-width:90px">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                      <th style="min-width:120px">Ø§Ù„Ø­Ø§Ù„Ø©</th><th style="min-width:220px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr></thead><tbody></tbody></table>
                  </div></div>
                </div>
              </div>
            </div>
          </div>

          <div class="card hide" id="panelSales">
            <div class="hd">
              <div>
                <div class="h">ğŸ§¾ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¨ÙŠØ¹</div>
                <div class="sub">Ù‚ÙŠØ¯ Ø¢Ù„ÙŠ + Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ© + ØªÙƒÙ„ÙØ© Ù…Ø¨ÙŠØ¹Ø§Øª</div>
              </div>
              <div class="row"><button class="btn primary" id="btnNewSale">+ ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</button></div>
            </div>
            <div class="bd">
              <div class="row">
                <div class="field" style="min-width:240px"><label>Ø¨Ø­Ø«</label><input id="saleSearch" placeholder="Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© / Ø¹Ù…ÙŠÙ„..."></div>
                <div class="field"><label>Ù…Ù†</label><input type="date" id="saleFrom"></div>
                <div class="field"><label>Ø¥Ù„Ù‰</label><input type="date" id="saleTo"></div>
                <div class="field" style="min-width:160px"><label>&nbsp;</label><button class="btn" id="btnSaleFilter">ÙÙ„ØªØ±Ø©</button></div>
              </div>
              <div class="hr"></div>
              <div style="overflow:auto">
                <table id="salesTable"><thead><tr><th style="min-width:110px">Ø±Ù‚Ù…</th><th style="min-width:120px">ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th style="min-width:120px">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th style="min-width:180px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </div>

          <div class="card hide" id="panelJournal">
            <div class="hd">
              <div>
                <div class="h">ğŸ§¾ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</div>
                <div class="sub">Double-entry + Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ø³Ø·Ø±</div>
              </div>
              <div class="row">
                <button class="btn primary" id="btnAddJournal">+ Ù‚ÙŠØ¯ Ø¬Ø¯ÙŠØ¯</button>
              </div>
            </div>
            <div class="bd">
              <div class="row">
                <div class="field" style="min-width:260px"><label>Ø¨Ø­Ø«</label><input id="journalSearch" placeholder="Ø±Ù‚Ù…/Ø¨ÙŠØ§Ù†/Ø­Ø³Ø§Ø¨/Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ©..."></div>
                <div class="field"><label>Ù…Ù†</label><input type="date" id="journalFrom"></div>
                <div class="field"><label>Ø¥Ù„Ù‰</label><input type="date" id="journalTo"></div>
                <div class="field" style="min-width:160px"><label>&nbsp;</label><button class="btn" id="btnJournalFilter">ÙÙ„ØªØ±Ø©</button></div>
              </div>
              <div class="hr"></div>
              <div style="overflow:auto">
                <table id="journalTable">
                  <thead><tr>
                    <th style="min-width:90px">Ø±Ù‚Ù…</th>
                    <th style="min-width:120px">ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                    <th style="min-width:120px">Ù…Ø¯ÙŠÙ†</th>
                    <th style="min-width:120px">Ø¯Ø§Ø¦Ù†</th>
                    <th style="min-width:150px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                  </tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card hide" id="panelVouchers">
            <div class="hd">
              <div>
                <div class="h">ğŸ’³ Ø³Ù†Ø¯Ø§Øª Ù‚Ø¨Ø¶/ØµØ±Ù</div>
                <div class="sub">Ù‚ÙŠØ¯ Ø¢Ù„ÙŠ + Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ©</div>
              </div>
              <div class="row">
                <button class="btn good" id="btnReceipt">+ Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</button>
                <button class="btn danger" id="btnPayment">+ Ø³Ù†Ø¯ ØµØ±Ù</button>
              </div>
            </div>
            <div class="bd">
              <div style="overflow:auto">
                <table id="vouchersTable">
                  <thead><tr>
                    <th style="min-width:110px">Ø±Ù‚Ù…</th><th style="min-width:120px">ØªØ§Ø±ÙŠØ®</th><th style="min-width:90px">Ø§Ù„Ù†ÙˆØ¹</th>
                    <th>Ø§Ù„Ø·Ø±Ù</th><th style="min-width:120px">Ø§Ù„Ù…Ø¨Ù„Øº</th><th style="min-width:190px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                  </tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card hide" id="panelReports">
            <div class="hd">
              <div>
                <div class="h">ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
                <div class="sub">Ù…ÙŠØ²Ø§Ù† Ù…Ø±Ø§Ø¬Ø¹Ø© + Ø£Ø±Ø¨Ø§Ø­ ÙˆØ®Ø³Ø§Ø¦Ø± + ØªÙ‚Ø±ÙŠØ± Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ© + Ø£ÙˆØ§Ù…Ø± Ø¥Ù†ØªØ§Ø¬</div>
              </div>
              <div class="row"><button class="btn good" id="btnRunReports">ØªØ´ØºÙŠÙ„</button></div>
            </div>
            <div class="bd">
              <div class="row">
                <div class="field"><label>Ù…Ù†</label><input type="date" id="repFrom"></div>
                <div class="field"><label>Ø¥Ù„Ù‰</label><input type="date" id="repTo"></div>
                <div class="field" style="min-width:220px">
                  <label>Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
                  <select id="repType">
                    <option value="tb">Ù…ÙŠØ²Ø§Ù† Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                    <option value="pl">Ø£Ø±Ø¨Ø§Ø­ ÙˆØ®Ø³Ø§Ø¦Ø±</option>
                    <option value="cc">ØªÙ‚Ø±ÙŠØ± Ù…Ø±Ø§ÙƒØ² ÙƒÙ„ÙØ©</option>
                    <option value="wip">ØªÙ‚Ø±ÙŠØ± Ø£ÙˆØ§Ù…Ø± Ø¥Ù†ØªØ§Ø¬</option>
                    <option value="stmt_customer">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¹Ù…ÙŠÙ„</option>
                    <option value="stmt_vendor">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ù…ÙˆØ±Ø¯</option>
                    <option value="gl">Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° (Ø­Ø³Ø§Ø¨)</option>
                  </select>
                </div>
                <div class="field" style="min-width:220px">
                  <label>Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ©</label>
                  <select id="repCC"></select>
                </div>
                <div class="field" style="min-width:260px" id="repCustomerWrap">
                  <label>Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <select id="repCustomer"></select>
                </div>
                <div class="field" style="min-width:260px" id="repVendorWrap">
                  <label>Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                  <select id="repVendor"></select>
                </div>
                <div class="field" style="min-width:260px" id="repAccWrap">
                  <label>Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                  <select id="repAcc"></select>
                </div>
                </div>
              </div>
              <div class="hr"></div>
              <div id="reportArea" style="overflow:auto"></div>
            </div>
          </div>

        </div>

        <div class="grid">
          <div class="card" id="panelSettings">
            <div class="hd">
              <div>
                <div class="h">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
                <div class="sub">Ø§Ù„Ø´Ø±ÙƒØ© + Ø§Ù„Ø¹Ù…Ù„Ø© + Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
              </div>
              <span class="badge">Offline</span>
            </div>
            <div class="bd">
              <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label><input id="setCompany" placeholder="Ù…Ø«Ø§Ù„: Ù…ØµÙ†Ø¹ Ø§Ù„Ù†Ø¬Ø§Ø­"></div>
              <div class="row">
                <div class="field"><label>Ø§Ù„Ø¹Ù…Ù„Ø©</label><input id="setCurrency" placeholder="EGP"></div>
                <div class="field"><label>Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</label><input id="setFY" placeholder="2026"></div>
              </div>
              <div class="hr"></div>
              <div style="color:var(--muted);font-size:12px;line-height:1.7">
                Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªØµÙ†ÙŠØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:<br>
                <span class="mono">1311</span> Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… â€¢ <span class="mono">1312</span> WIP â€¢ <span class="mono">1313</span> FG<br>
                <span class="mono">5110</span> COGS â€¢ <span class="mono">4100</span> Ù…Ø¨ÙŠØ¹Ø§Øª â€¢ <span class="mono">1210</span> Ø¹Ù…Ù„Ø§Ø¡ â€¢ <span class="mono">2110</span> Ù…ÙˆØ±Ø¯ÙŠÙ†
              </div>
              <div class="hr"></div>
              <div class="row">
                <button class="btn primary" id="btnSaveSettings" style="flex:1">Ø­ÙØ¸</button>
              </div>
            </div>
          </div>

          <div class="card" id="panelQuick" style="background:rgba(255,255,255,.03);box-shadow:none">
            <div class="hd" style="border-bottom:1px solid var(--line)">
              <div>
                <div class="h">âš¡ ØªØ´ØºÙŠÙ„ Ø³Ø±ÙŠØ¹</div>
                <div class="sub">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø«Ù… Ø¬Ø±Ù‘Ø¨ Ø´Ø±Ø§Ø¡ â†’ ØªØµÙ†ÙŠØ¹ â†’ Ø¨ÙŠØ¹</div>
              </div>
            </div>
            <div class="bd" style="color:var(--muted);font-size:12px;line-height:1.8">
              1) Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â˜° Ø§ÙØªØ­: <b>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</b> ÙˆØ£Ø¶Ù (Ù…ÙˆØ±Ø¯/Ø¹Ù…ÙŠÙ„/Ø£ØµÙ†Ø§Ù RM Ùˆ FG + Ù…Ø±Ø§ÙƒØ² ÙƒÙ„ÙØ©).<br>
              2) Ø§ÙØªØ­: <b>Ø§Ù„Ø´Ø±Ø§Ø¡</b> ÙˆØ£Ø¯Ø®Ù„ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ù…ÙˆØ§Ø¯ (RM).<br>
              3) Ø§ÙØªØ­: <b>Ø§Ù„ØªØµÙ†ÙŠØ¹</b> ÙˆØ£Ù†Ø´Ø¦ BOM Ø«Ù… Ø£Ù…Ø± Ø¥Ù†ØªØ§Ø¬ØŒ Ø«Ù… (ØµØ±Ù Ù…ÙˆØ§Ø¯ + ØªØ­Ù…ÙŠÙ„ ØªØ´ØºÙŠÙ„ + ØªØ³ÙŠÙŠÙ„).<br>
              4) Ø§ÙØªØ­: <b>Ø§Ù„Ø¨ÙŠØ¹</b> ÙˆØ£Ù†Ø´Ø¦ ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹ (FG) ÙˆØ³ÙŠÙØ³Ø¬Ù‘Ù„ COGS ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.<br>
              5) Ø§ÙØªØ­: <b>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</b> Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="footerbar">
    <div class="inner">
      <div class="hint">ğŸ’¾ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠÙ‹Ø§. Ø§Ø³ØªØ®Ø¯Ù… Backup JSON Ø¯Ø§Ø¦Ù…Ù‹Ø§.</div>
      <div class="hint">v3.0 â€¢ Ù…Ø­Ø§Ø³Ø¨Ø© + ØªØµÙ†ÙŠØ¹ + Ù…Ø±Ø§ÙƒØ² ÙƒÙ„ÙØ© â€¢ Frontend ÙÙ‚Ø·</div>
    </div>
  </div>

  <div class="toast hide" id="toast"><div class="msg" id="toastMsg">ØªÙ…</div></div>

<script>
/* ================= ERP Lite v3 (Frontend-only) =================
   - Accounting double-entry
   - Cost Centers per line
   - Purchases (RM) moving average
   - Manufacturing (BOM + Work Orders + WIP/FG postings)
   - Sales (FG) with COGS
   - Vouchers (Receipt/Payment)
   - Reports: TB / P&L / CC / Work Orders
   - Backup/Restore + Excel + PDF
================================================================ */

const LS_KEY = "ERP_LITE_V3";
const SESSION_KEY = "ERP_SESSION_V3";

const $ = (s)=>document.querySelector(s);
const fmt = (n)=> (Number(n||0)).toLocaleString("ar-EG",{maximumFractionDigits:2});
const todayISO = ()=> new Date().toISOString().slice(0,10);
const uid = ()=> Math.random().toString(16).slice(2) + Date.now().toString(16);

function toast(msg, type=""){
  const t=$("#toast"), m=$("#toastMsg");
  m.textContent=msg;
  t.classList.remove("hide");
  m.style.borderColor = type==="bad" ? "rgba(251,113,133,.35)" :
                        type==="good" ? "rgba(52,211,153,.35)" :
                        type==="warn" ? "rgba(251,191,36,.35)" :
                        "rgba(255,255,255,.18)";
  setTimeout(()=>t.classList.add("hide"), 2300);
}

function setDrawer(open){
  const ov=$("#drawerOverlay"), dr=$("#drawer");
  if(open){ ov.classList.remove("hide"); dr.classList.remove("hide"); document.body.style.overflow="hidden"; }
  else{ ov.classList.add("hide"); dr.classList.add("hide"); document.body.style.overflow=""; }
}

function downloadText(filename, text){
  const blob = new Blob([text], {type:"application/json;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
  URL.revokeObjectURL(a.href);
}
function pickFile(accept=".json"){
  return new Promise((resolve)=>{
    const i=document.createElement("input");
    i.type="file"; i.accept=accept;
    i.onchange=()=>resolve(i.files?.[0]||null);
    i.click();
  });
}

/* ---------------- Default Data ---------------- */
function defaultData(){
  const now=todayISO();
  const accounts = [
    {id:"1000", name:"Ø§Ù„Ø£ØµÙˆÙ„", type:"root", parent:null},
    {id:"1100", name:"Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©", type:"group", parent:"1000"},
    {id:"1110", name:"Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚", type:"asset", parent:"1100"},
    {id:"1120", name:"Ø§Ù„Ø¨Ù†Ùƒ", type:"asset", parent:"1100"},
    {id:"1200", name:"Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø°Ù…Ù… Ù…Ø¯ÙŠÙ†Ø©)", type:"group", parent:"1000"},
    {id:"1210", name:"Ø¹Ù…Ù„Ø§Ø¡", type:"asset", parent:"1200"},

    {id:"1300", name:"Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", type:"group", parent:"1000"},
    {id:"1310", name:"Ù…Ø®Ø²ÙˆÙ†", type:"group", parent:"1300"},
    {id:"1311", name:"Ù…ÙˆØ§Ø¯ Ø®Ø§Ù… (RM)", type:"asset", parent:"1310"},
    {id:"1312", name:"ØªØ­Øª Ø§Ù„ØªØ´ØºÙŠÙ„ (WIP)", type:"asset", parent:"1310"},
    {id:"1313", name:"Ø¥Ù†ØªØ§Ø¬ ØªØ§Ù… (FG)", type:"asset", parent:"1310"},

    {id:"2000", name:"Ø§Ù„Ø®ØµÙˆÙ…", type:"root", parent:null},
    {id:"2100", name:"Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Ø°Ù…Ù… Ø¯Ø§Ø¦Ù†Ø©)", type:"group", parent:"2000"},
    {id:"2110", name:"Ù…ÙˆØ±Ø¯ÙŠÙ†", type:"liability", parent:"2100"},

    {id:"3000", name:"Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©", type:"root", parent:null},
    {id:"3100", name:"Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„", type:"equity", parent:"3000"},
    {id:"3200", name:"Ø£Ø±Ø¨Ø§Ø­ Ù…Ø­ØªØ¬Ø²Ø©", type:"equity", parent:"3000"},

    {id:"4000", name:"Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª", type:"root", parent:null},
    {id:"4100", name:"Ù…Ø¨ÙŠØ¹Ø§Øª", type:"revenue", parent:"4000"},

    {id:"5000", name:"Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª", type:"root", parent:null},
    {id:"5100", name:"ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", type:"group", parent:"5000"},
    {id:"5110", name:"ØªÙƒÙ„ÙØ© Ù…Ø¨ÙŠØ¹Ø§Øª (COGS)", type:"expense", parent:"5100"},
    {id:"5200", name:"Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„", type:"group", parent:"5000"},
    {id:"5210", name:"Ø£Ø¬ÙˆØ±/ØªØ´ØºÙŠÙ„ (ØªØ­Ù…ÙŠÙ„ Ø¹Ù„Ù‰ WIP)", type:"expense", parent:"5200"},
    {id:"5220", name:"Ù…ØµØ±ÙˆÙØ§Øª Ø¹Ø§Ù…Ø©", type:"expense", parent:"5200"},
  ];

  return {
    meta:{company:"Ù…ØµÙ†Ø¹Ù€ÙŠ", currency:"EGP", fiscalYear:String(new Date().getFullYear()), createdAt:now, version:"3.0"},
    users:[{id:"u_admin", username:"admin", password:"admin123", role:"admin", name:"Ø§Ù„Ù…Ø¯ÙŠØ±"}],

    customers:[],
    vendors:[],
    items:[], // {id,name,type(RM/FG/SRV),unit, stock, avgCost, price}
    costCenters:[{id:"CC-00", name:"Ø¨Ø¯ÙˆÙ† Ù…Ø±ÙƒØ²"}],
    accounts,

    journal:[],   // {id,no,date,memo,lines:[{accId,accName,debit,credit,ccId,ccName}], source:{type,id}}
    sales:[],
    purchases:[],
    vouchers:[],

    boms:[],      // {id, productItemId, productName, unit, components:[{itemId,name,qty}], stdCost}
    workOrders:[] // {id,no,date,ccId,ccName,productItemId,productName,qty,status,matCost,ohCost,totalCost, notes, postings}
  };
}

/* ---------------- Storage ---------------- */
let DB=null;
function loadDB(){
  const raw=localStorage.getItem(LS_KEY);
  if(!raw){ DB=defaultData(); saveDB(); return; }
  try{ DB=JSON.parse(raw); }
  catch(e){ DB=defaultData(); saveDB(); }
}
function saveDB(){ localStorage.setItem(LS_KEY, JSON.stringify(DB)); }
function setSession(user){ localStorage.setItem(SESSION_KEY, JSON.stringify({userId:user.id, at:Date.now()})); }
function getSession(){ try{return JSON.parse(localStorage.getItem(SESSION_KEY)||"null");}catch(e){return null;} }
function clearSession(){ localStorage.removeItem(SESSION_KEY); }

/* ---------------- Accounting Engine ---------------- */
function nextNo(prefix, list, pad=5){
  const max=(list||[]).reduce((m,x)=>{
    const no=String(x.no||"");
    const n=parseInt(no.replace(prefix,""))||0;
    return Math.max(m,n);
  },0);
  return prefix + String(max+1).padStart(pad,"0");
}
function getAccName(id){ const a=DB.accounts.find(x=>x.id===id); return a?a.name:"â€”"; }
function getCCName(id){ const c=DB.costCenters.find(x=>x.id===id); return c?c.name:"â€”"; }

function sumLines(lines){
  let d=0,c=0;
  for(const l of lines){ d+=Number(l.debit||0); c+=Number(l.credit||0); }
  return {debit:d, credit:c};
}
function addJournalEntry({date,memo,lines,source=null}){
  const s=sumLines(lines);
  if(Math.abs(s.debit-s.credit)>0.0001) throw new Error("Ø§Ù„Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªØ²Ù†: Ø§Ù„Ù…Ø¯ÙŠÙ† Ù„Ø§ ÙŠØ³Ø§ÙˆÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù†");
  if(s.debit<=0) throw new Error("Ø§Ù„Ù‚ÙŠØ¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¨Ø§Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±");
  const entry={
    id:uid(),
    no:nextNo("JV", DB.journal),
    date:date||todayISO(),
    memo:memo||"",
    lines:lines.map(l=>({
      accId:l.accId,
      accName:getAccName(l.accId),
      ccId:l.ccId||"CC-00",
      ccName:getCCName(l.ccId||"CC-00"),
      debit:Number(l.debit||0),
      credit:Number(l.credit||0),
    })),
    source
  };
  DB.journal.unshift(entry);
  saveDB();
  return entry.id;
}
function deleteJournalEntry(journalId){
  DB.journal = DB.journal.filter(j=>j.id!==journalId);
  DB.sales.forEach(s=>{ if(s.journalId===journalId) s.journalId=null; });
  DB.purchases.forEach(p=>{ if(p.journalId===journalId) p.journalId=null; });
  DB.vouchers.forEach(v=>{ if(v.journalId===journalId) v.journalId=null; });
  DB.workOrders.forEach(w=>{
    const p=w.postings||{};
    for(const k of ["issueJv","ohJv","finishJv"]) if(p[k]===journalId) p[k]=null;
    w.postings=p;
  });
  saveDB();
}
function journalInRange(from,to){
  const f=from?new Date(from):null, t=to?new Date(to):null;
  return DB.journal.filter(j=>{
    const d=new Date(j.date);
    if(f&&d<f) return false;
    if(t&&d>t) return false;
    return true;
  });
}
function accountBalances(from,to, ccId=null){
  const bal={};
  const entries=journalInRange(from,to);
  for(const j of entries){
    for(const l of j.lines){
      if(ccId && l.ccId!==ccId) continue;
      if(!bal[l.accId]) bal[l.accId]={debit:0, credit:0};
      bal[l.accId].debit += Number(l.debit||0);
      bal[l.accId].credit += Number(l.credit||0);
    }
  }
  return bal;
}
function netPL(from,to, ccId=null){
  const bal=accountBalances(from,to,ccId);
  let rev=0, exp=0;
  for(const acc of DB.accounts){
    if(!bal[acc.id]) continue;
    const d=bal[acc.id].debit, c=bal[acc.id].credit;
    if(acc.type==="revenue") rev += (c-d);
    if(acc.type==="expense") exp += (d-c);
  }
  return {rev, exp, net: rev-exp};
}

/* ---------------- Inventory ---------------- */
function itemById(id){ return DB.items.find(x=>x.id===id); }
function ensureItemFields(it){
  if(it.stock==null) it.stock=0;
  if(it.avgCost==null) it.avgCost=0;
  if(!it.unit) it.unit="ÙˆØ­Ø¯Ø©";
  if(it.price==null) it.price=0;
}
function invValueForType(type){
  return DB.items.filter(i=>i.type===type).reduce((s,i)=> s + Number(i.stock||0)*Number(i.avgCost||0), 0);
}
function receiveIntoInventory(itemId, qty, unitCost){
  const it=itemById(itemId);
  if(!it) return;
  ensureItemFields(it);
  const q0=Number(it.stock||0), c0=Number(it.avgCost||0);
  const q1=q0 + Number(qty||0);
  const totalCost = (q0*c0) + (Number(qty||0)*Number(unitCost||0));
  it.stock = q1;
  it.avgCost = q1>0 ? (totalCost/q1) : c0;
}
function issueFromInventory(itemId, qty){
  const it=itemById(itemId);
  if(!it) return {unitCost:0, cost:0};
  ensureItemFields(it);
  const q=Number(qty||0);
  const unitCost=Number(it.avgCost||0);
  it.stock = Number(it.stock||0) - q;
  return {unitCost, cost: q*unitCost};
}

/* ---------------- Navigation (Panels) ---------------- */
const PANELS = {
  dashboard: ["panelDashboard","panelSettings","panelQuick"],
  masters: ["panelMasters"],
  coa: ["panelCOA"],
  purchases: ["panelPurchases"],
  mfg: ["panelMFG"],
  sales: ["panelSales"],
  journal: ["panelJournal"],
  vouchers: ["panelVouchers"],
  reports: ["panelReports"]
};
let ACTIVE="dashboard";

function hideAllPanels(){
  Object.values(PANELS).flat().forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.classList.add("hide");
  });
}
function setPanel(key){
  ACTIVE=key;
  hideAllPanels();
  (PANELS[key]||[]).forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.classList.remove("hide");
  });
  // refresh relevant
  if(key==="dashboard") refreshDashboard();
  if(key==="masters") renderMasters();
  if(key==="coa") renderCOA();
  if(key==="purchases") renderPurchasesTable();
  if(key==="sales") renderSalesTable();
  if(key==="journal") renderJournalTable();
  if(key==="vouchers") renderVouchersTable();
  if(key==="mfg"){ fillCCSelects(); renderBOMs(); renderWOs(); }
  if(key==="reports"){ fillCCSelects(); }
}

function showLogin(){
  document.getElementById("viewLogin").classList.remove("hide");
  document.getElementById("viewApp").classList.add("hide");
  document.getElementById("userPill").innerHTML=`<span>ğŸ”’</span><span class="muted">ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>`;
  document.getElementById("drawerUser").textContent="ØºÙŠØ± Ù…Ø³Ø¬Ù„";
}
let CURRENT_USER=null;
function showApp(){
  document.getElementById("viewLogin").classList.add("hide");
  document.getElementById("viewApp").classList.remove("hide");
  document.getElementById("userPill").innerHTML=`<span>âœ…</span><span>${CURRENT_USER?.name||CURRENT_USER?.username}</span><span class="muted">(${CURRENT_USER?.role})</span>`;
  document.getElementById("drawerUser").textContent=`${CURRENT_USER?.name||CURRENT_USER?.username} (${CURRENT_USER?.role})`;
  loadSettingsToUI();
  setPanel("dashboard");
}

/* ---------------- Settings ---------------- */
function loadSettingsToUI(){
  $("#setCompany").value=DB.meta.company||"";
  $("#setCurrency").value=DB.meta.currency||"EGP";
  $("#setFY").value=DB.meta.fiscalYear||"";
  $("#appTitle").textContent=`ERP â€“ ${DB.meta.company||"Ù…Ø­Ø§Ø³Ø¨Ø© + ØªØµÙ†ÙŠØ¹"}`;
  $("#curBadge").textContent=`Ø§Ù„Ø¹Ù…Ù„Ø©: ${DB.meta.currency||"â€”"}`;
  $("#fyBadge").textContent=`Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©: ${DB.meta.fiscalYear||"â€”"}`;
}
$("#btnSaveSettings").onclick=()=>{
  DB.meta.company=($("#setCompany").value||"Ù…ØµÙ†Ø¹Ù€ÙŠ").trim();
  DB.meta.currency=($("#setCurrency").value||"EGP").trim().toUpperCase();
  DB.meta.fiscalYear=($("#setFY").value||String(new Date().getFullYear())).trim();
  saveDB();
  loadSettingsToUI();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª","good");
};

/* ---------------- Dashboard ---------------- */
function refreshDashboard(){
  const from=$("#dashFrom").value;
  const to=$("#dashTo").value;
  const {rev,exp,net}=netPL(from,to,null);
  $("#kpiRevenue").textContent=fmt(rev)+" "+DB.meta.currency;
  $("#kpiExpense").textContent=fmt(exp)+" "+DB.meta.currency;
  $("#kpiNet").textContent=fmt(net)+" "+DB.meta.currency;

  $("#kpiRM").textContent=fmt(invValueForType("RM"))+" "+DB.meta.currency;
  $("#kpiFG").textContent=fmt(invValueForType("FG"))+" "+DB.meta.currency;
  $("#kpiWO").textContent=String(DB.workOrders.filter(w=>w.status!=="Ù…ØºÙ„Ù‚").length);
}
$("#btnDashRefresh").onclick=refreshDashboard;

/* ---------------- Masters ---------------- */
function upsertParty(listName, label){
  const name=prompt(`Ø§Ø³Ù… ${label}:`);
  if(!name) return;
  DB[listName].push({id:uid(), name:name.trim()});
  saveDB(); toast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${label}`,"good"); renderMasters();
}
$("#btnAddCustomer").onclick=()=>upsertParty("customers","Ø¹Ù…ÙŠÙ„");
$("#btnAddVendor").onclick=()=>upsertParty("vendors","Ù…ÙˆØ±Ø¯");

$("#btnAddItem").onclick=()=>{
  const name=prompt("Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù:");
  if(!name) return;
  const type=(prompt("Ù†ÙˆØ¹ Ø§Ù„ØµÙ†Ù: RM=Ù…ÙˆØ§Ø¯ Ø®Ø§Ù…, FG=Ù…Ù†ØªØ¬ ØªØ§Ù…, SRV=Ø®Ø¯Ù…Ø©", "RM")||"RM").trim().toUpperCase();
  const unit=(prompt("ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³:", "ÙˆØ­Ø¯Ø©")||"ÙˆØ­Ø¯Ø©").trim();
  const price=Number(prompt("Ø³Ø¹Ø± Ø¨ÙŠØ¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):","0")||0);
  DB.items.push({id:uid(), name:name.trim(), type, unit, stock:0, avgCost:0, price});
  saveDB(); toast("ØªÙ… Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù","good"); renderMasters(); fillCCSelects();
};

$("#btnAddCC").onclick=()=>{
  const id=(prompt("ÙƒÙˆØ¯ Ù…Ø±ÙƒØ² Ø§Ù„ÙƒÙ„ÙØ© (Ù…Ø«Ø§Ù„ CC-PRD):","CC-")||"").trim();
  if(!id) return;
  if(DB.costCenters.some(c=>c.id===id)) return toast("Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯","bad");
  const name=(prompt("Ø§Ø³Ù… Ù…Ø±ÙƒØ² Ø§Ù„ÙƒÙ„ÙØ©:","Ø¥Ù†ØªØ§Ø¬")||"").trim();
  if(!name) return;
  DB.costCenters.push({id, name});
  saveDB(); toast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ©","good"); renderMasters(); fillCCSelects();
};

function partyBalance(partyType, partyId){
  let bal=0;
  if(partyType==="customer"){
    DB.sales.forEach(s=>{ if(s.customerId===partyId) bal += Number(s.total||0); });
    DB.vouchers.forEach(v=>{ if(v.type==="receipt" && v.partyType==="customer" && v.partyId===partyId) bal -= Number(v.amount||0); });
  } else {
    DB.purchases.forEach(p=>{ if(p.vendorId===partyId) bal += Number(p.total||0); });
    DB.vouchers.forEach(v=>{ if(v.type==="payment" && v.partyType==="vendor" && v.partyId===partyId) bal -= Number(v.amount||0); });
  }
  return bal;
}

function renderMasters(){
  const q=($("#masterSearch").value||"").trim();
  const match=(s)=> !q || (s||"").includes(q);

  const cT=$("#customersTable tbody"); cT.innerHTML="";
  DB.customers.filter(c=>match(c.name)).forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${c.name}</td><td>${fmt(partyBalance("customer",c.id))} ${DB.meta.currency}</td>
      <td><button class="btn" data-e>ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn danger" data-d>Ø­Ø°Ù</button></td>`;
    tr.querySelector("[data-e]").onclick=()=>{ const n=prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…:", c.name); if(!n) return; c.name=n.trim(); saveDB(); renderMasters(); toast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„","good"); };
    tr.querySelector("[data-d]").onclick=()=>{ if(!confirm("Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ")) return; DB.customers=DB.customers.filter(x=>x.id!==c.id); saveDB(); renderMasters(); toast("ØªÙ… Ø§Ù„Ø­Ø°Ù","bad"); };
    cT.appendChild(tr);
  });

  const vT=$("#vendorsTable tbody"); vT.innerHTML="";
  DB.vendors.filter(v=>match(v.name)).forEach(v=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${v.name}</td><td>${fmt(partyBalance("vendor",v.id))} ${DB.meta.currency}</td>
      <td><button class="btn" data-e>ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn danger" data-d>Ø­Ø°Ù</button></td>`;
    tr.querySelector("[data-e]").onclick=()=>{ const n=prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…:", v.name); if(!n) return; v.name=n.trim(); saveDB(); renderMasters(); toast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„","good"); };
    tr.querySelector("[data-d]").onclick=()=>{ if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ±Ø¯ØŸ")) return; DB.vendors=DB.vendors.filter(x=>x.id!==v.id); saveDB(); renderMasters(); toast("ØªÙ… Ø§Ù„Ø­Ø°Ù","bad"); };
    vT.appendChild(tr);
  });

  const iT=$("#itemsTable tbody"); iT.innerHTML="";
  DB.items.filter(i=>match(i.name)).forEach(i=>{
    ensureItemFields(i);
    const tr=document.createElement("tr");
    const typeLabel = i.type==="RM"?"Ù…ÙˆØ§Ø¯": i.type==="FG"?"ØªØ§Ù…": i.type==="SRV"?"Ø®Ø¯Ù…Ø©": i.type;
    tr.innerHTML=`
      <td>${i.name}<div style="color:var(--muted);font-size:12px;line-height:1.6">Ù…ØªÙˆØ³Ø· ØªÙƒÙ„ÙØ©: ${fmt(i.avgCost)} â€¢ Ø³Ø¹Ø±: ${fmt(i.price||0)} ${DB.meta.currency}</div></td>
      <td>${typeLabel}</td>
      <td>${fmt(i.stock)} ${i.unit||"ÙˆØ­Ø¯Ø©"}</td>
      <td><button class="btn" data-e>ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn danger" data-d>Ø­Ø°Ù</button></td>`;
    tr.querySelector("[data-e]").onclick=()=>{
      const n=prompt("Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù:", i.name); if(!n) return;
      const t=prompt("Ù†ÙˆØ¹: RM/FG/SRV", i.type)||i.type;
      const u=prompt("Ø§Ù„ÙˆØ­Ø¯Ø©:", i.unit||"ÙˆØ­Ø¯Ø©")||"ÙˆØ­Ø¯Ø©";
      const p=Number(prompt("Ø³Ø¹Ø± Ø¨ÙŠØ¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ:", i.price||0) || i.price || 0);
      i.name=n.trim(); i.type=t.trim().toUpperCase(); i.unit=u.trim(); i.price=p;
      saveDB(); renderMasters(); toast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„","good");
    };
    tr.querySelector("[data-d]").onclick=()=>{ if(!confirm("Ø­Ø°Ù Ø§Ù„ØµÙ†ÙØŸ")) return; DB.items=DB.items.filter(x=>x.id!==i.id); saveDB(); renderMasters(); toast("ØªÙ… Ø§Ù„Ø­Ø°Ù","bad"); };
    iT.appendChild(tr);
  });

  const ccT=$("#ccTable tbody"); ccT.innerHTML="";
  DB.costCenters.filter(c=> match(c.id) || match(c.name)).forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="mono">${c.id}</td><td>${c.name}</td>
      <td>${c.id==="CC-00" ? "<span class='badge'>Ø§ÙØªØ±Ø§Ø¶ÙŠ</span>" : "<button class='btn' data-e>ØªØ¹Ø¯ÙŠÙ„</button> <button class='btn danger' data-d>Ø­Ø°Ù</button>"}</td>`;
    if(c.id!=="CC-00"){
      tr.querySelector("[data-e]").onclick=()=>{ const n=prompt("Ø§Ø³Ù… Ù…Ø±ÙƒØ² Ø§Ù„ÙƒÙ„ÙØ©:", c.name); if(!n) return; c.name=n.trim(); saveDB(); renderMasters(); fillCCSelects(); toast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„","good"); };
      tr.querySelector("[data-d]").onclick=()=>{
        if(!confirm("Ø­Ø°Ù Ù…Ø±ÙƒØ² Ø§Ù„ÙƒÙ„ÙØ©ØŸ")) return;
        if(DB.journal.some(j=> j.lines.some(l=>l.ccId===c.id))) return toast("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø°Ù: Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚ÙŠÙˆØ¯","bad");
        if(DB.workOrders.some(w=>w.ccId===c.id)) return toast("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø°Ù: Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø£ÙˆØ§Ù…Ø± Ø¥Ù†ØªØ§Ø¬","bad");
        DB.costCenters=DB.costCenters.filter(x=>x.id!==c.id);
        saveDB(); renderMasters(); fillCCSelects(); toast("ØªÙ… Ø§Ù„Ø­Ø°Ù","bad");
      };
    }
    ccT.appendChild(tr);
  });
}
$("#masterSearch").addEventListener("input", renderMasters);

/* ---------------- COA ---------------- */
function isLeafAccount(id){ return !DB.accounts.some(a=>a.parent===id); }
function renderCOA(){
  const q=($("#coaSearch").value||"").trim();
  const nodes=JSON.parse(JSON.stringify(DB.accounts));
  const byId=Object.fromEntries(nodes.map(n=>[n.id,n]));
  nodes.forEach(n=>n.children=[]);
  nodes.forEach(n=>{ if(n.parent && byId[n.parent]) byId[n.parent].children.push(n); });
  const roots=nodes.filter(n=>!n.parent);

  function nodeHtml(n, depth=0){
    const hit=!q || n.id.includes(q) || n.name.includes(q);
    const child=n.children.map(c=>nodeHtml(c, depth+1)).join("");
    const childHasHit=q && child.includes('data-hit="1"');
    const show=hit || childHasHit || !q;
    if(!show) return "";
    const pad=depth*14;
    const canDelete = isLeafAccount(n.id) && !DB.journal.some(j=>j.lines.some(l=>l.accId===n.id))
      && !["1000","2000","3000","4000","5000","1110","1120","1210","2110","1311","1312","1313","4100","5110","5210","5220"].includes(n.id);
    const canAdd=true;
    return `
      <div style="margin:6px 0; padding-right:${pad}px" data-hit="${hit?1:0}">
        <div class="row" style="justify-content:space-between">
          <div>
            <span class="badge"><span class="mono">${n.id}</span></span>
            <b style="margin-right:8px">${n.name}</b>
            <span style="color:var(--muted);font-size:12px">(${n.type})</span>
          </div>
          <div class="row">
            ${canAdd ? `<button class="btn" data-add="${n.id}">+ ÙØ±Ø¹ÙŠ</button>` : ``}
            ${canDelete ? `<button class="btn danger" data-del="${n.id}">Ø­Ø°Ù</button>` : ``}
          </div>
        </div>
        ${child? `<div style="margin-top:6px">${child}</div>`:""}
      </div>
    `;
  }
  $("#coaTree").innerHTML = roots.map(r=>nodeHtml(r,0)).join("") || `<div style="color:var(--muted)">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>`;

  $("#coaTree").querySelectorAll("[data-add]").forEach(b=>{
    b.onclick=()=>{
      const parentId=b.getAttribute("data-add");
      const id=(prompt("Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ (Ù…Ø«Ø§Ù„ 1314):","")||"").trim();
      if(!id) return;
      if(DB.accounts.some(a=>a.id===id)) return toast("Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯","bad");
      const name=(prompt("Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:","")||"").trim();
      if(!name) return;
      const parent=DB.accounts.find(a=>a.id===parentId);
      const type = (parent?.type==="root" || parent?.type==="group") ? "group" : parent?.type || "group";
      DB.accounts.push({id, name, type, parent:parentId});
      saveDB(); renderCOA(); toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©","good");
    };
  });
  $("#coaTree").querySelectorAll("[data-del]").forEach(b=>{
    b.onclick=()=>{
      const id=b.getAttribute("data-del");
      if(!confirm("Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ")) return;
      DB.accounts=DB.accounts.filter(a=>a.id!==id);
      saveDB(); renderCOA(); toast("ØªÙ… Ø§Ù„Ø­Ø°Ù","bad");
    };
  });
}
$("#coaSearch").addEventListener("input", renderCOA);
$("#btnAddAccount").onclick=()=>{
  const id=(prompt("Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:","")||"").trim();
  if(!id) return;
  if(DB.accounts.some(a=>a.id===id)) return toast("Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯","bad");
  const name=(prompt("Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:","")||"").trim();
  if(!name) return;
  const parent=(prompt("Ø±Ù‚Ù… Ø§Ù„Ø£Ø¨ (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº Ù„Ø¬Ø°Ø±):","1000")||"").trim();
  const type=(prompt("Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨ (asset/liability/equity/revenue/expense/group/root):","group")||"group").trim();
  DB.accounts.push({id, name, type, parent: parent || null});
  saveDB(); renderCOA(); toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©","good");
};

/* ---------------- Pickers ---------------- */
function pickFrom(list,label){
  if(!list.length){ alert(`Ù„Ø§ ÙŠÙˆØ¬Ø¯ ${label}. Ø£Ø¶Ù Ù…Ù† (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©).`); return null; }
  const msg=list.map((x,i)=> `${i+1}) ${x.name}`).join("\n");
  const idx=Number(prompt(`Ø§Ø®ØªØ± Ø±Ù‚Ù… ${label}:\n${msg}`,"1")||0);
  if(!idx || idx<1 || idx>list.length) return null;
  return list[idx-1];
}
function pickItemByType(type, label){
  const list=DB.items.filter(i=>i.type===type);
  if(!list.length){ alert(`Ù„Ø§ ÙŠÙˆØ¬Ø¯ ${label}. Ø£Ø¶Ù Ø£ØµÙ†Ø§Ù Ù†ÙˆØ¹ ${type} Ù…Ù† (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©).`); return null; }
  const msg=list.map((x,i)=> `${i+1}) ${x.name} (Ù…ØªÙˆØ³Ø·: ${fmt(x.avgCost)} | Ù…Ø®Ø²ÙˆÙ†: ${fmt(x.stock)} ${x.unit||"ÙˆØ­Ø¯Ø©"})`).join("\n");
  const idx=Number(prompt(`Ø§Ø®ØªØ± ${label}:\n${msg}`,"1")||0);
  if(!idx || idx<1 || idx>list.length) return null;
  return list[idx-1];
}
function pickCC(label="Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ©"){
  const list=DB.costCenters;
  const msg=list.map((x,i)=> `${i+1}) ${x.id} - ${x.name}`).join("\n");
  const idx=Number(prompt(`Ø§Ø®ØªØ± ${label}:\n${msg}`,"1")||0);
  if(!idx || idx<1 || idx>list.length) return list[0];
  return list[idx-1];
}

/* ---------------- Purchases ---------------- */
function filterByDate(list, from,to){
  const f=from?new Date(from):null, t=to?new Date(to):null;
  return list.filter(x=>{
    const d=new Date(x.date);
    if(f&&d<f) return false;
    if(t&&d>t) return false;
    return true;
  });
}
function newPurchase(){
  const vendor=pickFrom(DB.vendors,"Ø§Ù„Ù…ÙˆØ±Ø¯");
  if(!vendor) return;
  const date=prompt("ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", todayISO()) || todayISO();

  const items=[];
  while(true){
    const it=pickItemByType("RM","Ù…Ø§Ø¯Ø© Ø®Ø§Ù…");
    if(!it) break;
    const qty=Number(prompt("Ø§Ù„ÙƒÙ…ÙŠØ©:","1")||1);
    const unitCost=Number(prompt("ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© (Ø´Ø±Ø§Ø¡):", String(it.avgCost||0))||0);
    items.push({itemId:it.id, name:it.name, qty, unitCost, total: qty*unitCost});
    if(!confirm("Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø£Ø®Ø±Ù‰ØŸ")) break;
  }
  if(!items.length) return toast("Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§Ø¯","bad");
  const total=items.reduce((s,x)=>s+Number(x.total||0),0);
  const note=prompt("Ù…Ù„Ø§Ø­Ø¸Ø©:", "")||"";

  items.forEach(l=> receiveIntoInventory(l.itemId, l.qty, l.unitCost));

  const jvId=addJournalEntry({
    date, memo:`Ø´Ø±Ø§Ø¡ Ù…ÙˆØ§Ø¯ Ù…Ù† ${vendor.name}`,
    lines:[
      {accId:"1311", debit:total, credit:0, ccId:"CC-00"},
      {accId:"2110", debit:0, credit:total, ccId:"CC-00"},
    ],
    source:{type:"purchase", id:null}
  });

  const inv={id:uid(), no:nextNo("PI", DB.purchases), date, vendorId:vendor.id, vendorName:vendor.name, items, total, note, journalId:jvId};
  DB.journal.find(j=>j.id===jvId).source.id=inv.id;
  DB.purchases.unshift(inv);
  saveDB();
  toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø±Ø§Ø¡ + ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ÙˆØ§Ø¯","good");
  renderPurchasesTable(); renderMasters(); refreshDashboard(); renderJournalTable();
}
$("#btnNewPurchase").onclick=()=>{ setDrawer(false); newPurchase(); };

function renderPurchasesTable(){
  const q=($("#purSearch").value||"").trim();
  const from=$("#purFrom").value;
  const to=$("#purTo").value;
  let rows=filterByDate(DB.purchases,from,to);
  if(q) rows=rows.filter(p=> (p.no||"").includes(q) || (p.vendorName||"").includes(q));
  const tb=$("#purchasesTable tbody"); tb.innerHTML="";
  rows.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="mono">${p.no}</td>
      <td>${p.date}</td>
      <td>${p.vendorName}</td>
      <td>${fmt(p.total)} ${DB.meta.currency}</td>
      <td>
        <button class="btn" data-view>Ø¹Ø±Ø¶</button>
        <button class="btn danger" data-del>Ø­Ø°Ù</button>
      </td>`;
    tr.querySelector("[data-view]").onclick=()=>{
      const lines=p.items.map(x=>`- ${x.name} | ${x.qty} Ã— ${fmt(x.unitCost)} = ${fmt(x.total)}`).join("\n");
      alert(`Ø´Ø±Ø§Ø¡: ${p.no}\nØªØ§Ø±ÙŠØ®: ${p.date}\nÙ…ÙˆØ±Ø¯: ${p.vendorName}\n\nÙ…ÙˆØ§Ø¯:\n${lines}\n\nØ¥Ø¬Ù…Ø§Ù„ÙŠ: ${fmt(p.total)} ${DB.meta.currency}\nÙ…Ù„Ø§Ø­Ø¸Ø©: ${p.note||"â€”"}`);
    };
    tr.querySelector("[data-del]").onclick=()=>{
      if(!confirm("Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ØŸ (Ù„Ù† ÙŠØªÙ… Ø¹ÙƒØ³ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)")) return;
      DB.purchases=DB.purchases.filter(x=>x.id!==p.id);
      saveDB(); renderPurchasesTable(); toast("ØªÙ… Ø§Ù„Ø­Ø°Ù","bad");
    };
    tb.appendChild(tr);
  });
}
$("#btnPurFilter").onclick=renderPurchasesTable;
$("#purSearch").addEventListener("input", renderPurchasesTable);

/* ---------------- Manufacturing ---------------- */
function computeBOMStdCost(bom){
  let cost=0;
  for(const c of (bom.components||[])){
    const it=itemById(c.itemId);
    const unitCost = it ? Number(it.avgCost||0) : 0;
    cost += Number(c.qty||0) * unitCost;
  }
  return cost;
}
function renderBOMs(){
  const q=($("#mfgSearch").value||"").trim();
  const tb=$("#bomTable tbody"); tb.innerHTML="";
  let rows=DB.boms.slice();
  if(q) rows=rows.filter(b=> (b.productName||"").includes(q));
  rows.forEach(b=>{
    b.stdCost = computeBOMStdCost(b);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${b.productName}</td>
      <td>${b.unit||"ÙˆØ­Ø¯Ø©"}</td>
      <td>${fmt(b.stdCost)} ${DB.meta.currency}</td>
      <td>
        <button class="btn" data-view>ØªÙØ§ØµÙŠÙ„</button>
        <button class="btn danger" data-del>Ø­Ø°Ù</button>
      </td>`;
    tr.querySelector("[data-view]").onclick=()=>{
      const lines=(b.components||[]).map(x=>`- ${x.name} | ÙƒÙ…ÙŠØ©: ${x.qty}`).join("\n");
      alert(`BOM Ù„Ù„Ù…Ù†ØªØ¬: ${b.productName}\n\nÙ…ÙƒÙˆÙ†Ø§Øª:\n${lines || "â€”"}\n\nØªÙƒÙ„ÙØ© Ù…Ø¹ÙŠØ§Ø±ÙŠØ©: ${fmt(b.stdCost)} ${DB.meta.currency}`);
    };
    tr.querySelector("[data-del]").onclick=()=>{
      if(!confirm("Ø­Ø°Ù BOMØŸ")) return;
      if(DB.workOrders.some(w=>w.productItemId===b.productItemId)) return toast("Ù„Ø§ ÙŠÙ…ÙƒÙ†: Ù…Ø±ØªØ¨Ø· Ø¨Ø£ÙˆØ§Ù…Ø± Ø¥Ù†ØªØ§Ø¬","bad");
      DB.boms=DB.boms.filter(x=>x.id!==b.id);
      saveDB(); renderBOMs(); toast("ØªÙ… Ø§Ù„Ø­Ø°Ù","bad");
    };
    tb.appendChild(tr);
  });
}
function addBOM(){
  const prod=pickItemByType("FG","Ù…Ù†ØªØ¬ ØªØ§Ù…");
  if(!prod) return;
  if(DB.boms.some(b=>b.productItemId===prod.id)) return toast("ÙŠÙˆØ¬Ø¯ BOM Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬","bad");
  const unit=prompt("ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ù†ØªØ¬:", prod.unit||"ÙˆØ­Ø¯Ø©") || (prod.unit||"ÙˆØ­Ø¯Ø©");
  const components=[];
  while(true){
    const rm=pickItemByType("RM","Ù…Ø§Ø¯Ø© Ø®Ø§Ù…");
    if(!rm) break;
    const qty=Number(prompt(`ÙƒÙ…ÙŠØ© ${rm.name} Ù„ÙƒÙ„ 1 ${unit}:`,"1")||1);
    components.push({itemId:rm.id, name:rm.name, qty});
    if(!confirm("Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø£Ø®Ø±Ù‰ØŸ")) break;
  }
  if(!components.length) return toast("Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ÙƒÙˆÙ†Ø§Øª","bad");
  const bom={id:uid(), productItemId:prod.id, productName:prod.name, unit, components, stdCost:0};
  bom.stdCost=computeBOMStdCost(bom);
  DB.boms.unshift(bom);
  saveDB(); toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ BOM","good");
  renderBOMs();
}
$("#btnAddBOM").onclick=()=>{ setDrawer(false); addBOM(); };

function newWorkOrder(){
  if(!DB.boms.length){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ BOM. Ø£Ù†Ø´Ø¦ BOM Ø£ÙˆÙ„Ø§Ù‹."); return; }
  const msg=DB.boms.map((b,i)=> `${i+1}) ${b.productName}`).join("\n");
  const idx=Number(prompt(`Ø§Ø®ØªØ± BOM Ù„Ù„Ù…Ù†ØªØ¬:\n${msg}`,"1")||0);
  if(!idx || idx<1 || idx>DB.boms.length) return;
  const bom=DB.boms[idx-1];

  const qty=Number(prompt("ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ù†ØªØ§Ø¬:", "1")||1);
  const cc=pickCC("Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ© Ù„Ù„Ø£Ù…Ø±");
  const date=prompt("ØªØ§Ø±ÙŠØ® Ø£Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬:", todayISO()) || todayISO();
  const notes=prompt("Ù…Ù„Ø§Ø­Ø¸Ø§Øª:", "")||"";

  const wo={
    id:uid(),
    no:nextNo("WO", DB.workOrders),
    date,
    ccId:cc.id, ccName:cc.name,
    productItemId:bom.productItemId,
    productName:bom.productName,
    qty,
    status:"Ù…ÙØªÙˆØ­",
    matCost:0, ohCost:0, totalCost:0,
    notes,
    postings:{issueJv:null, ohJv:null, finishJv:null}
  };
  DB.workOrders.unshift(wo);
  saveDB();
  toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù…Ø± Ø¥Ù†ØªØ§Ø¬","good");
  renderWOs(); refreshDashboard();
}
$("#btnNewWO").onclick=()=>{ setDrawer(false); newWorkOrder(); };

function woById(id){ return DB.workOrders.find(w=>w.id===id); }
function bomByProduct(productItemId){ return DB.boms.find(b=>b.productItemId===productItemId); }

function issueMaterialsToWO(woId){
  const wo=woById(woId); if(!wo) return;
  if(wo.status==="Ù…ØºÙ„Ù‚") return toast("Ø§Ù„Ø£Ù…Ø± Ù…ØºÙ„Ù‚","bad");
  const bom=bomByProduct(wo.productItemId);
  if(!bom) return toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ BOM","bad");

  let totalMatCost=0;
  for(const comp of (bom.components||[])){
    const needQty = Number(comp.qty||0) * Number(wo.qty||0);
    const {cost} = issueFromInventory(comp.itemId, needQty);
    totalMatCost += cost;
  }
  wo.matCost += totalMatCost;
  wo.totalCost = wo.matCost + wo.ohCost;

  const jvId = addJournalEntry({
    date: todayISO(),
    memo:`ØµØ±Ù Ù…ÙˆØ§Ø¯ Ù„Ø£Ù…Ø± Ø¥Ù†ØªØ§Ø¬ ${wo.no} (${wo.productName})`,
    lines:[
      {accId:"1312", debit:totalMatCost, credit:0, ccId:wo.ccId},
      {accId:"1311", debit:0, credit:totalMatCost, ccId:wo.ccId},
    ],
    source:{type:"wo-issue", id:wo.id}
  });
  wo.postings.issueJv = jvId;
  saveDB();
  toast("ØªÙ… ØµØ±Ù Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¹Ù„Ù‰ WIP","good");
  renderWOs(); renderMasters(); renderJournalTable(); refreshDashboard();
}
function addOverheadToWO(woId){
  const wo=woById(woId); if(!wo) return;
  if(wo.status==="Ù…ØºÙ„Ù‚") return toast("Ø§Ù„Ø£Ù…Ø± Ù…ØºÙ„Ù‚","bad");
  const amt=Number(prompt("Ù…Ø¨Ù„Øº ØªÙƒØ§Ù„ÙŠÙ ØªØ´ØºÙŠÙ„/Ø£Ø¬ÙˆØ± Ù„ØªØ­Ù…ÙŠÙ„Ù‡ Ø¹Ù„Ù‰ WIP:", "0")||0);
  if(amt<=0) return toast("Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­","bad");

  const jvId=addJournalEntry({
    date: todayISO(),
    memo:`ØªØ­Ù…ÙŠÙ„ ØªÙƒØ§Ù„ÙŠÙ ØªØ´ØºÙŠÙ„ Ù„Ø£Ù…Ø± ${wo.no}`,
    lines:[
      {accId:"1312", debit:amt, credit:0, ccId:wo.ccId},
      {accId:"5210", debit:0, credit:amt, ccId:wo.ccId},
    ],
    source:{type:"wo-oh", id:wo.id}
  });

  wo.ohCost += amt;
  wo.totalCost = wo.matCost + wo.ohCost;
  wo.postings.ohJv = jvId;
  saveDB();
  toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø¹Ù„Ù‰ WIP","good");
  renderWOs(); renderJournalTable(); refreshDashboard();
}
function finishWO(woId){
  const wo=woById(woId); if(!wo) return;
  if(wo.status==="Ù…ØºÙ„Ù‚") return toast("Ø§Ù„Ø£Ù…Ø± Ù…ØºÙ„Ù‚","bad");
  if(wo.totalCost<=0) return toast("Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙƒÙ„ÙØ© Ù…Ø­Ù…Ù„Ø©. Ø§ØµØ±Ù Ù…ÙˆØ§Ø¯/Ø­Ù…Ù‘Ù„ ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.","bad");

  const unitCost = wo.totalCost / Number(wo.qty||1);
  receiveIntoInventory(wo.productItemId, wo.qty, unitCost);

  const jvId=addJournalEntry({
    date: todayISO(),
    memo:`ØªØ³ÙŠÙŠÙ„ Ø£Ù…Ø± Ø¥Ù†ØªØ§Ø¬ ${wo.no} Ø¥Ù„Ù‰ Ù…Ø®Ø²ÙˆÙ† Ø¥Ù†ØªØ§Ø¬ ØªØ§Ù…`,
    lines:[
      {accId:"1313", debit:wo.totalCost, credit:0, ccId:wo.ccId},
      {accId:"1312", debit:0, credit:wo.totalCost, ccId:wo.ccId},
    ],
    source:{type:"wo-finish", id:wo.id}
  });

  wo.postings.finishJv = jvId;
  wo.status="Ù…ØºÙ„Ù‚";
  saveDB();
  toast("ØªÙ… Ø¥Ù‚ÙØ§Ù„ Ø£Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØªØ§Ù… Ù„Ù„Ù…Ø®Ø²ÙˆÙ†","good");
  renderWOs(); renderMasters(); renderJournalTable(); refreshDashboard();
}
function renderWOs(){
  const q=($("#mfgSearch").value||"").trim();
  const ccFilter=$("#mfgCCFilter").value || "";
  let rows=DB.workOrders.slice();
  if(ccFilter && ccFilter!=="ALL") rows=rows.filter(w=>w.ccId===ccFilter);
  if(q) rows=rows.filter(w=> (w.no||"").includes(q) || (w.productName||"").includes(q));

  const tb=$("#woTable tbody"); tb.innerHTML="";
  rows.forEach(w=>{
    const tr=document.createElement("tr");
    const statusBadge = w.status==="Ù…ØºÙ„Ù‚" ? `<span class="badge">Ù…ØºÙ„Ù‚</span>` : `<span class="badge">Ù…ÙØªÙˆØ­</span>`;
    tr.innerHTML=`
      <td class="mono">${w.no}</td>
      <td>${w.date}</td>
      <td>${w.productName}<div style="color:var(--muted);font-size:12px;line-height:1.6">Ù…Ø±ÙƒØ²: <span class="mono">${w.ccId}</span> ${w.ccName}</div></td>
      <td>${fmt(w.qty)}</td>
      <td>${statusBadge}<div style="color:var(--muted);font-size:12px;line-height:1.6">ØªÙƒÙ„ÙØ©: ${fmt(w.totalCost)} ${DB.meta.currency}</div></td>
      <td>
        <button class="btn" data-view>Ø¹Ø±Ø¶</button>
        <button class="btn warn" data-issue>ØµØ±Ù Ù…ÙˆØ§Ø¯</button>
        <button class="btn" data-oh>ØªØ­Ù…ÙŠÙ„ ØªØ´ØºÙŠÙ„</button>
        <button class="btn good" data-finish>ØªØ³ÙŠÙŠÙ„/Ø¥ØºÙ„Ø§Ù‚</button>
      </td>`;
    tr.querySelector("[data-view]").onclick=()=>{
      const p=w.postings||{};
      alert(`Ø£Ù…Ø± Ø¥Ù†ØªØ§Ø¬: ${w.no}\nØªØ§Ø±ÙŠØ®: ${w.date}\nØ§Ù„Ù…Ù†ØªØ¬: ${w.productName}\nÙƒÙ…ÙŠØ©: ${w.qty}\nÙ…Ø±ÙƒØ² ÙƒÙ„ÙØ©: ${w.ccId} - ${w.ccName}\nØ­Ø§Ù„Ø©: ${w.status}\n\nØªÙƒÙ„ÙØ© Ù…ÙˆØ§Ø¯: ${fmt(w.matCost)}\nØªÙƒÙ„ÙØ© ØªØ´ØºÙŠÙ„: ${fmt(w.ohCost)}\nØ¥Ø¬Ù…Ø§Ù„ÙŠ: ${fmt(w.totalCost)} ${DB.meta.currency}\n\nÙ‚ÙŠÙˆØ¯:\nØµØ±Ù Ù…ÙˆØ§Ø¯: ${p.issueJv? "Ù†Ø¹Ù…":"â€”"}\nØªØ­Ù…ÙŠÙ„ ØªØ´ØºÙŠÙ„: ${p.ohJv? "Ù†Ø¹Ù…":"â€”"}\nØªØ³ÙŠÙŠÙ„: ${p.finishJv? "Ù†Ø¹Ù…":"â€”"}`);
    };
    tr.querySelector("[data-issue]").onclick=()=> issueMaterialsToWO(w.id);
    tr.querySelector("[data-oh]").onclick=()=> addOverheadToWO(w.id);
    tr.querySelector("[data-finish]").onclick=()=> finishWO(w.id);
    tb.appendChild(tr);
  });
}
$("#btnMfgFilter").onclick=()=>{ renderBOMs(); renderWOs(); };
$("#mfgSearch").addEventListener("input", ()=>{ renderBOMs(); renderWOs(); });

/* ---------------- Sales ---------------- */
function newSale(){
  const customer=pickFrom(DB.customers,"Ø§Ù„Ø¹Ù…ÙŠÙ„"); if(!customer) return;
  const date=prompt("ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", todayISO())||todayISO();
  const cc=pickCC("Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ© Ù„Ù„Ø¨ÙŠØ¹");

  const items=[];
  while(true){
    const it=pickItemByType("FG","Ù…Ù†ØªØ¬ ØªØ§Ù…");
    if(!it) break;
    ensureItemFields(it);
    const qty=Number(prompt("Ø§Ù„ÙƒÙ…ÙŠØ©:", "1")||1);
    const price=Number(prompt("Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù„ÙˆØ­Ø¯Ø©:", String(it.price||0))||0);
    items.push({itemId:it.id, name:it.name, qty, price, total:qty*price, unitCost:Number(it.avgCost||0)});
    if(!confirm("Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¢Ø®Ø±ØŸ")) break;
  }
  if(!items.length) return toast("Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª","bad");

  const total=items.reduce((s,x)=>s+Number(x.total||0),0);
  const note=prompt("Ù…Ù„Ø§Ø­Ø¸Ø©:", "")||"";

  let cogs=0;
  for(const l of items){
    const {cost} = issueFromInventory(l.itemId, l.qty);
    cogs += cost;
  }

  const jvSales=addJournalEntry({
    date, memo:`ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹ ${customer.name}`,
    lines:[
      {accId:"1210", debit:total, credit:0, ccId:cc.id},
      {accId:"4100", debit:0, credit:total, ccId:cc.id},
    ],
    source:{type:"sale", id:null}
  });

  if(cogs>0){
    addJournalEntry({
      date, memo:`ØªÙƒÙ„ÙØ© Ù…Ø¨ÙŠØ¹Ø§Øª Ù„ÙØ§ØªÙˆØ±Ø© ${customer.name}`,
      lines:[
        {accId:"5110", debit:cogs, credit:0, ccId:cc.id},
        {accId:"1313", debit:0, credit:cogs, ccId:cc.id},
      ],
      source:{type:"cogs", id:jvSales}
    });
  }

  const inv={id:uid(), no:nextNo("SI", DB.sales), date, customerId:customer.id, customerName:customer.name, items, total, note, journalId:jvSales, ccId:cc.id, ccName:cc.name, cogs};
  DB.journal.find(j=>j.id===jvSales).source.id=inv.id;
  DB.sales.unshift(inv);
  saveDB();
  toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ¹ + Ù‚ÙŠØ¯ Ø¢Ù„ÙŠ + ØªÙƒÙ„ÙØ© Ù…Ø¨ÙŠØ¹Ø§Øª","good");
  renderSalesTable(); renderJournalTable(); renderMasters(); refreshDashboard();
}
$("#btnNewSale").onclick=()=>{ setDrawer(false); newSale(); };

function renderSalesTable(){
  const q=($("#saleSearch").value||"").trim();
  const from=$("#saleFrom").value;
  const to=$("#saleTo").value;
  let rows=filterByDate(DB.sales,from,to);
  if(q) rows=rows.filter(s=> (s.no||"").includes(q) || (s.customerName||"").includes(q));
  const tb=$("#salesTable tbody"); tb.innerHTML="";
  rows.forEach(s=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="mono">${s.no}</td>
      <td>${s.date}</td>
      <td>${s.customerName}<div style="color:var(--muted);font-size:12px;line-height:1.6">Ù…Ø±ÙƒØ²: <span class="mono">${s.ccId||"CC-00"}</span> ${s.ccName||""}</div></td>
      <td>${fmt(s.total)} ${DB.meta.currency}</td>
      <td>
        <button class="btn" data-view>Ø¹Ø±Ø¶</button>
        <button class="btn good" data-pdf>PDF</button>
        <button class="btn danger" data-del>Ø­Ø°Ù</button>
      </td>`;
    tr.querySelector("[data-view]").onclick=()=>{
      const lines=s.items.map(x=>`- ${x.name} | ${x.qty} Ã— ${fmt(x.price)} = ${fmt(x.total)}`).join("\n");
      alert(`Ø¨ÙŠØ¹: ${s.no}\nØªØ§Ø±ÙŠØ®: ${s.date}\nØ¹Ù…ÙŠÙ„: ${s.customerName}\nÙ…Ø±ÙƒØ² ÙƒÙ„ÙØ©: ${s.ccId} - ${s.ccName}\n\nØ¨Ù†ÙˆØ¯:\n${lines}\n\nØ¥Ø¬Ù…Ø§Ù„ÙŠ: ${fmt(s.total)} ${DB.meta.currency}\nØªÙƒÙ„ÙØ© Ù…Ø¨ÙŠØ¹Ø§Øª: ${fmt(s.cogs||0)}\nÙ…Ù„Ø§Ø­Ø¸Ø©: ${s.note||"â€”"}`);
    };
    tr.querySelector("[data-pdf]").onclick=()=> printInvoicePDF("sale", s.id);
    tr.querySelector("[data-del]").onclick=()=>{
      if(!confirm("Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹ØŸ (Ù„Ù† ÙŠØªÙ… Ø¹ÙƒØ³ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)")) return;
      DB.sales=DB.sales.filter(x=>x.id!==s.id); saveDB(); renderSalesTable(); toast("ØªÙ… Ø§Ù„Ø­Ø°Ù","bad");
    };
    tb.appendChild(tr);
  });
}
$("#btnSaleFilter").onclick=renderSalesTable;
$("#saleSearch").addEventListener("input", renderSalesTable);

/* ---------------- Journal UI ---------------- */
function renderJournalTable(){
  const q=($("#journalSearch").value||"").trim();
  const from=$("#journalFrom").value;
  const to=$("#journalTo").value;
  let rows=journalInRange(from,to);
  if(q){
    rows=rows.filter(j=>{
      const inLines=j.lines.some(l=> l.accId.includes(q) || (l.accName||"").includes(q) || (l.ccId||"").includes(q) || (l.ccName||"").includes(q));
      return (j.no||"").includes(q) || (j.memo||"").includes(q) || inLines;
    });
  }
  const tb=$("#journalTable tbody"); tb.innerHTML="";
  rows.forEach(j=>{
    const s=sumLines(j.lines);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="mono">${j.no}</td>
      <td>${j.date}</td>
      <td>${j.memo || "<span style='color:var(--muted)'>â€”</span>"}<div style="color:var(--muted);font-size:12px;line-height:1.6">Ù…ØµØ¯Ø±: ${(j.source?.type)||"â€”"}</div></td>
      <td>${fmt(s.debit)}</td>
      <td>${fmt(s.credit)}</td>
      <td>
        <button class="btn" data-view>ØªÙØ§ØµÙŠÙ„</button>
        <button class="btn danger" data-del>Ø­Ø°Ù</button>
      </td>`;
    tr.querySelector("[data-view]").onclick=()=>{
      const lines=j.lines.map(l=>`- ${l.accId} ${l.accName} | CC: ${l.ccId} ${l.ccName} | Ù…Ø¯ÙŠÙ†: ${fmt(l.debit)} | Ø¯Ø§Ø¦Ù†: ${fmt(l.credit)}`).join("\n");
      alert(`Ù‚ÙŠØ¯: ${j.no}\nØªØ§Ø±ÙŠØ®: ${j.date}\nØ¨ÙŠØ§Ù†: ${j.memo||"â€”"}\n\n${lines}`);
    };
    tr.querySelector("[data-del]").onclick=()=>{
      if(!confirm("Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ¯ØŸ")) return;
      deleteJournalEntry(j.id);
      saveDB();
      toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ¯","bad");
      renderJournalTable(); refreshDashboard(); renderMasters();
    };
    tb.appendChild(tr);
  });
}
$("#btnJournalFilter").onclick=renderJournalTable;
$("#journalSearch").addEventListener("input", renderJournalTable);

$("#btnAddJournal").onclick=()=>{
  const date=prompt("ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚ÙŠØ¯:", todayISO())||todayISO();
  const memo=prompt("Ø§Ù„Ø¨ÙŠØ§Ù†:", "Ù‚ÙŠØ¯ ÙŠØ¯ÙˆÙŠ")||"";
  const dAcc=(prompt("Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠÙ† (Ù…Ø«Ø§Ù„ 1110):","1110")||"").trim(); if(!dAcc) return;
  const cAcc=(prompt("Ø­Ø³Ø§Ø¨ Ø¯Ø§Ø¦Ù† (Ù…Ø«Ø§Ù„ 4100):","4100")||"").trim(); if(!cAcc) return;
  const amt=Number(prompt("Ø§Ù„Ù…Ø¨Ù„Øº:","0")||0);
  if(amt<=0) return toast("Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­","bad");
  const cc=pickCC("Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ© Ù„Ù„Ù‚ÙŠØ¯");
  try{
    addJournalEntry({
      date, memo,
      lines:[
        {accId:dAcc, debit:amt, credit:0, ccId:cc.id},
        {accId:cAcc, debit:0, credit:amt, ccId:cc.id},
      ],
      source:{type:"manual", id:null}
    });
    toast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯","good");
    renderJournalTable(); refreshDashboard(); renderMasters();
  }catch(e){ toast(e.message||"Ø®Ø·Ø£","bad"); }
};

/* ---------------- Vouchers ---------------- */
$("#btnReceipt").onclick=()=> newVoucher("receipt");
$("#btnPayment").onclick=()=> newVoucher("payment");

function newVoucher(type){
  const isReceipt=type==="receipt";
  const party=isReceipt?pickFrom(DB.customers,"Ø§Ù„Ø¹Ù…ÙŠÙ„"):pickFrom(DB.vendors,"Ø§Ù„Ù…ÙˆØ±Ø¯");
  if(!party) return;
  const date=prompt("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ù†Ø¯:", todayISO())||todayISO();
  const amount=Number(prompt("Ø§Ù„Ù…Ø¨Ù„Øº:","0")||0);
  if(amount<=0) return toast("Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­","bad");
  const note=prompt("Ø§Ù„Ø¨ÙŠØ§Ù†:", "")||"";
  const cc=pickCC("Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ© Ù„Ù„Ø³Ù†Ø¯");
  const cashAcc=(prompt("Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© (1110 ØµÙ†Ø¯ÙˆÙ‚ / 1120 Ø¨Ù†Ùƒ):", "1110")||"1110").trim();

  try{
    const jvId = isReceipt
      ? addJournalEntry({
          date, memo:`Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ Ù…Ù† ${party.name}`,
          lines:[
            {accId:cashAcc, debit:amount, credit:0, ccId:cc.id},
            {accId:"1210", debit:0, credit:amount, ccId:cc.id},
          ],
          source:{type:"receipt", id:null}
        })
      : addJournalEntry({
          date, memo:`Ø³Ù†Ø¯ ØµØ±Ù Ø¥Ù„Ù‰ ${party.name}`,
          lines:[
            {accId:"2110", debit:amount, credit:0, ccId:cc.id},
            {accId:cashAcc, debit:0, credit:amount, ccId:cc.id},
          ],
          source:{type:"payment", id:null}
        });

    const v={id:uid(), no:nextNo(isReceipt?"RC":"PM", DB.vouchers), date, type, partyType:isReceipt?"customer":"vendor", partyId:party.id, partyName:party.name, amount, note, ccId:cc.id, ccName:cc.name, journalId:jvId};
    DB.journal.find(j=>j.id===jvId).source.id=v.id;
    DB.vouchers.unshift(v);
    saveDB();
    toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ù†Ø¯","good");
    renderVouchersTable(); renderJournalTable(); refreshDashboard(); renderMasters();
  }catch(e){ toast(e.message||"Ø®Ø·Ø£","bad"); }
}

function renderVouchersTable(){
  const tb=$("#vouchersTable tbody"); tb.innerHTML="";
  DB.vouchers.forEach(v=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="mono">${v.no}</td>
      <td>${v.date}</td>
      <td>${v.type==="receipt"?"Ù‚Ø¨Ø¶":"ØµØ±Ù"}</td>
      <td>${v.partyName}<div style="color:var(--muted);font-size:12px;line-height:1.6">CC: <span class="mono">${v.ccId||"CC-00"}</span> ${v.ccName||""}</div></td>
      <td>${fmt(v.amount)} ${DB.meta.currency}</td>
      <td>
        <button class="btn" data-view>Ø¹Ø±Ø¶</button>
        <button class="btn good" data-pdf>PDF</button>
        <button class="btn danger" data-del>Ø­Ø°Ù</button>
      </td>`;
    tr.querySelector("[data-view]").onclick=()=>{ alert(`Ø³Ù†Ø¯: ${v.no}\nØªØ§Ø±ÙŠØ®: ${v.date}\nÙ†ÙˆØ¹: ${v.type==="receipt"?"Ù‚Ø¨Ø¶":"ØµØ±Ù"}\nØ§Ù„Ø·Ø±Ù: ${v.partyName}\nÙ…Ø±ÙƒØ²: ${v.ccId} - ${v.ccName}\nØ§Ù„Ù…Ø¨Ù„Øº: ${fmt(v.amount)} ${DB.meta.currency}\nØ¨ÙŠØ§Ù†: ${v.note||"â€”"}`); };
    tr.querySelector("[data-pdf]").onclick=()=> printVoucherPDF(v.id);
    tr.querySelector("[data-del]").onclick=()=>{ if(!confirm("Ø­Ø°Ù Ø§Ù„Ø³Ù†Ø¯ØŸ")) return; DB.vouchers=DB.vouchers.filter(x=>x.id!==v.id); saveDB(); renderVouchersTable(); toast("ØªÙ… Ø§Ù„Ø­Ø°Ù","bad"); };
    tb.appendChild(tr);
  });
}

/* ---------------- Reports ---------------- */
function fillCCSelects(){
  const repCC=$("#repCC"), mfg=$("#mfgCCFilter");
  const all = [{id:"ALL", name:"Ø§Ù„ÙƒÙ„"}].concat(DB.costCenters);

  if(repCC){
    repCC.innerHTML="";
    all.forEach(c=>{
      const o=document.createElement("option");
      o.value=c.id;
      o.textContent = `${c.id} - ${c.name}`;
      repCC.appendChild(o);
    });
    repCC.value="ALL";
  }

  if(mfg){
    mfg.innerHTML="";
    all.forEach(c=>{
      const o=document.createElement("option");
      o.value=c.id; o.textContent=`${c.id} - ${c.name}`;
      mfg.appendChild(o);
    });
    mfg.value="ALL";
  }

  fillReportSelectors();
  setReportUiByType();
}
$("#btnRunReports").onclick=()=>{
  const from=$("#repFrom").value;
  const to=$("#repTo").value;
  const type=$("#repType").value;
  const ccId=$("#repCC").value || "ALL";

  if(type==="tb") return renderTrialBalance(from,to,null);
  if(type==="pl") return renderPL(from,to,null);
  if(type==="cc") return renderCCReport(from,to,ccId==="ALL"?"CC-00":ccId);
  if(type==="wip") return renderWOReport();

  if(type==="stmt_customer"){
    const cid = $("#repCustomer").value;
    return renderPartyStatement("customer", cid, from, to, ccId);
  }
  if(type==="stmt_vendor"){
    const vid = $("#repVendor").value;
    return renderPartyStatement("vendor", vid, from, to, ccId);
  }
  if(type==="gl"){
    const accId = $("#repAcc").value;
    return renderGeneralLedger(accId, from, to, ccId);
  }
};

function renderTrialBalance(from,to,ccId){
  const bal=accountBalances(from,to,ccId);
  const leaf = DB.accounts.filter(a=> !DB.accounts.some(x=>x.parent===a.id) && !["root","group"].includes(a.type));
  const rows=leaf.map(a=>{
    const b=bal[a.id]||{debit:0, credit:0};
    return {id:a.id, name:a.name, debit:b.debit, credit:b.credit};
  }).filter(r=> (r.debit||0)!==0 || (r.credit||0)!==0);

  const totalD=rows.reduce((s,r)=>s+Number(r.debit||0),0);
  const totalC=rows.reduce((s,r)=>s+Number(r.credit||0),0);

  $("#reportArea").innerHTML=`
    <div class="row" style="justify-content:space-between">
      <div class="badge">Ù…ÙŠØ²Ø§Ù† Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
      <div class="badge">Ù…Ù†: ${from||"Ø¨Ø¯Ø§ÙŠØ©"} â€¢ Ø¥Ù„Ù‰: ${to||"Ù†Ù‡Ø§ÙŠØ©"}</div>
    </div>
    <div class="hr"></div>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th style="min-width:130px">Ù…Ø¯ÙŠÙ†</th><th style="min-width:130px">Ø¯Ø§Ø¦Ù†</th></tr></thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td><span class="mono">${r.id}</span> â€” ${r.name}</td>
              <td>${fmt(r.debit)}</td>
              <td>${fmt(r.credit)}</td>
            </tr>`).join("")}
          <tr><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>${fmt(totalD)}</th><th>${fmt(totalC)}</th></tr>
        </tbody>
      </table>
    </div>
  `;
}
function renderPL(from,to,ccId){
  const {rev,exp,net}=netPL(from,to,ccId);
  $("#reportArea").innerHTML=`
    <div class="row" style="justify-content:space-between">
      <div class="badge">Ø£Ø±Ø¨Ø§Ø­ ÙˆØ®Ø³Ø§Ø¦Ø±</div>
      <div class="badge">Ù…Ù†: ${from||"Ø¨Ø¯Ø§ÙŠØ©"} â€¢ Ø¥Ù„Ù‰: ${to||"Ù†Ù‡Ø§ÙŠØ©"}</div>
    </div>
    <div class="hr"></div>
    <div class="kpi">
      <div class="box"><small>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</small><b>${fmt(rev)} ${DB.meta.currency}</b></div>
      <div class="box"><small>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</small><b>${fmt(exp)} ${DB.meta.currency}</b></div>
      <div class="box"><small>Ø§Ù„ØµØ§ÙÙŠ</small><b>${fmt(net)} ${DB.meta.currency}</b></div>
    </div>
  `;
}
function renderCCReport(from,to,ccId){
  const cc = DB.costCenters.find(c=>c.id===ccId) || {id:"CC-00", name:"Ø¨Ø¯ÙˆÙ† Ù…Ø±ÙƒØ²"};
  const bal = accountBalances(from,to,ccId);
  const {rev,exp,net}=netPL(from,to,ccId);

  const rows = Object.entries(bal).map(([accId,v])=>{
    const acc = DB.accounts.find(a=>a.id===accId);
    return {accId, name: acc?acc.name:"â€”", debit:v.debit, credit:v.credit};
  }).filter(r=> (r.debit||0)!==0 || (r.credit||0)!==0);

  $("#reportArea").innerHTML=`
    <div class="row" style="justify-content:space-between">
      <div class="badge">ØªÙ‚Ø±ÙŠØ± Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ©</div>
      <div class="badge">CC: <span class="mono">${cc.id}</span> ${cc.name}</div>
    </div>
    <div class="hr"></div>
    <div class="kpi">
      <div class="box"><small>Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²</small><b>${fmt(rev)} ${DB.meta.currency}</b></div>
      <div class="box"><small>Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø±ÙƒØ²</small><b>${fmt(exp)} ${DB.meta.currency}</b></div>
      <div class="box"><small>ØµØ§ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ²</small><b>${fmt(net)} ${DB.meta.currency}</b></div>
    </div>
    <div class="hr"></div>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th style="min-width:120px">Ù…Ø¯ÙŠÙ†</th><th style="min-width:120px">Ø¯Ø§Ø¦Ù†</th></tr></thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td><span class="mono">${r.accId}</span> â€” ${r.name}</td>
              <td>${fmt(r.debit)}</td>
              <td>${fmt(r.credit)}</td>
            </tr>`).join("")}
        </tbody>
      </table>
    </div>
  `;
}
function renderWOReport(){
  const rows = DB.workOrders.slice().sort((a,b)=> (a.no>b.no?1:-1));
  $("#reportArea").innerHTML=`
    <div class="row" style="justify-content:space-between">
      <div class="badge">ØªÙ‚Ø±ÙŠØ± Ø£ÙˆØ§Ù…Ø± Ø¥Ù†ØªØ§Ø¬ (ØªÙƒÙ„ÙØ© ÙØ¹Ù„ÙŠØ©)</div>
      <div class="badge">Ø¹Ø¯Ø¯: ${rows.length}</div>
    </div>
    <div class="hr"></div>
    <div style="overflow:auto">
      <table>
        <thead><tr>
          <th>Ø±Ù‚Ù…</th><th>ØªØ§Ø±ÙŠØ®</th><th>Ù…Ù†ØªØ¬</th><th>ÙƒÙ…ÙŠØ©</th><th>Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ©</th><th>Ù…ÙˆØ§Ø¯</th><th>ØªØ´ØºÙŠÙ„</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø­Ø§Ù„Ø©</th>
        </tr></thead>
        <tbody>
          ${rows.map(w=>`
            <tr>
              <td class="mono">${w.no}</td>
              <td>${w.date}</td>
              <td>${w.productName}</td>
              <td>${fmt(w.qty)}</td>
              <td><span class="mono">${w.ccId}</span> ${w.ccName}</td>
              <td>${fmt(w.matCost)}</td>
              <td>${fmt(w.ohCost)}</td>
              <td>${fmt(w.totalCost)} ${DB.meta.currency}</td>
              <td>${w.status}</td>
            </tr>`).join("")}
        </tbody>
      </table>
    </div>
  `;

/* ---------------- Statements & Ledger ---------------- */
function fillReportSelectors(){
  // Customers
  const cSel = $("#repCustomer");
  if(cSel){
    cSel.innerHTML="";
    (DB.customers||[]).forEach(c=>{
      const o=document.createElement("option");
      o.value=c.id; o.textContent=c.name;
      cSel.appendChild(o);
    });
  }
  // Vendors
  const vSel = $("#repVendor");
  if(vSel){
    vSel.innerHTML="";
    (DB.vendors||[]).forEach(v=>{
      const o=document.createElement("option");
      o.value=v.id; o.textContent=v.name;
      vSel.appendChild(o);
    });
  }
  // Accounts (leaf accounts)
  const aSel = $("#repAcc");
  if(aSel){
    aSel.innerHTML="";
    const leaf = DB.accounts
      .filter(a=> !DB.accounts.some(x=>x.parent===a.id) && !["root","group"].includes(a.type));
    leaf.sort((a,b)=> (a.id>b.id?1:-1));
    leaf.forEach(a=>{
      const o=document.createElement("option");
      o.value=a.id; o.textContent=`${a.id} â€” ${a.name}`;
      aSel.appendChild(o);
    });
  }
}

function setReportUiByType(){
  const t = $("#repType").value;
  const show = (id, on)=> { const el=$(id); if(!el) return; el.classList.toggle("hide", !on); };

  show("#repCustomerWrap", t==="stmt_customer");
  show("#repVendorWrap", t==="stmt_vendor");
  show("#repAccWrap", t==="gl");
}

function inDateRange(d, from, to){
  const dt = new Date(d);
  if(from){ const f=new Date(from); if(dt < f) return false; }
  if(to){ const t=new Date(to); if(dt > t) return false; }
  return true;
}

function renderPartyStatement(partyType, partyId, from, to, ccIdFilter="ALL"){
  const party = partyType==="customer"
    ? DB.customers.find(c=>c.id===partyId)
    : DB.vendors.find(v=>v.id===partyId);

  if(!party) return $("#reportArea").innerHTML = `<div class="badge">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>`;

  const rows = [];

  if(partyType==="customer"){
    (DB.sales||[]).forEach(s=>{
      if(s.customerId!==partyId) return;
      if(!inDateRange(s.date, from, to)) return;
      if(ccIdFilter && ccIdFilter!=="ALL" && (s.ccId||"CC-00")!==ccIdFilter) return;
      rows.push({
        date:s.date, ref:s.no,
        desc:`ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹ â€” ${s.note||""}`.trim(),
        debit:Number(s.total||0), credit:0,
        ccId:(s.ccId||"CC-00"), ccName:(s.ccName||getCCName(s.ccId||"CC-00"))
      });
    });
    (DB.vouchers||[]).forEach(v=>{
      if(v.type!=="receipt") return;
      if(v.partyType!=="customer") return;
      if(v.partyId!==partyId) return;
      if(!inDateRange(v.date, from, to)) return;
      if(ccIdFilter && ccIdFilter!=="ALL" && (v.ccId||"CC-00")!==ccIdFilter) return;
      rows.push({
        date:v.date, ref:v.no,
        desc:`Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ â€” ${v.note||""}`.trim(),
        debit:0, credit:Number(v.amount||0),
        ccId:(v.ccId||"CC-00"), ccName:(v.ccName||getCCName(v.ccId||"CC-00"))
      });
    });

    rows.sort((a,b)=> (a.date>b.date?1:(a.date<b.date?-1:(a.ref>b.ref?1:-1))));
    let bal=0, td=0, tc=0;
    const body = rows.map(r=>{
      bal += (r.debit - r.credit);
      td += r.debit; tc += r.credit;
      const balLabel = bal>=0 ? `Ø¹Ù„ÙŠÙ‡: ${fmt(bal)}` : `Ù„Ù‡: ${fmt(Math.abs(bal))}`;
      return `<tr>
        <td>${r.date}</td>
        <td class="mono">${r.ref}</td>
        <td>${r.desc||"<span style='color:var(--muted)'>â€”</span>"}<div style="color:var(--muted);font-size:12px;line-height:1.6">CC: <span class="mono">${r.ccId}</span> ${r.ccName||""}</div></td>
        <td>${fmt(r.debit)}</td>
        <td>${fmt(r.credit)}</td>
        <td>${balLabel}</td>
      </tr>`;
    }).join("");

    const finalLabel = bal>=0 ? `Ø¹Ù„ÙŠÙ‡: ${fmt(bal)} ${DB.meta.currency}` : `Ù„Ù‡: ${fmt(Math.abs(bal))} ${DB.meta.currency}`;
    $("#reportArea").innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div class="badge">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¹Ù…ÙŠÙ„</div>
        <div class="badge">Ø§Ù„Ø¹Ù…ÙŠÙ„: ${party.name}</div>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <div class="badge">Ù…Ù†: ${from||"Ø¨Ø¯Ø§ÙŠØ©"} â€¢ Ø¥Ù„Ù‰: ${to||"Ù†Ù‡Ø§ÙŠØ©"}</div>
        <div class="badge">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${finalLabel}</div>
      </div>
      <div class="hr"></div>
      <div style="overflow:auto">
        <table>
          <thead><tr>
            <th style="min-width:110px">ØªØ§Ø±ÙŠØ®</th>
            <th style="min-width:90px">Ù…Ø±Ø¬Ø¹</th>
            <th>Ø§Ù„ÙˆØµÙ</th>
            <th style="min-width:120px">Ù…Ø¯ÙŠÙ†</th>
            <th style="min-width:120px">Ø¯Ø§Ø¦Ù†</th>
            <th style="min-width:140px">Ø§Ù„Ø±ØµÙŠØ¯</th>
          </tr></thead>
          <tbody>
            ${body || `<tr><td colspan="6" style="color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ©</td></tr>`}
            <tr>
              <th colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th>${fmt(td)}</th>
              <th>${fmt(tc)}</th>
              <th>${finalLabel}</th>
            </tr>
          </tbody>
        </table>
      </div>
    `;
    return;
  }

  (DB.purchases||[]).forEach(p=>{
    if(p.vendorId!==partyId) return;
    if(!inDateRange(p.date, from, to)) return;
    if(ccIdFilter && ccIdFilter!=="ALL" && ccIdFilter!=="CC-00") return;
    rows.push({
      date:p.date, ref:p.no,
      desc:`ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ â€” ${p.note||""}`.trim(),
      debit:0, credit:Number(p.total||0),
      ccId:"CC-00", ccName:getCCName("CC-00")
    });
  });
  (DB.vouchers||[]).forEach(v=>{
    if(v.type!=="payment") return;
    if(v.partyType!=="vendor") return;
    if(v.partyId!==partyId) return;
    if(!inDateRange(v.date, from, to)) return;
    if(ccIdFilter && ccIdFilter!=="ALL" && (v.ccId||"CC-00")!==ccIdFilter) return;
    rows.push({
      date:v.date, ref:v.no,
      desc:`Ø³Ù†Ø¯ ØµØ±Ù â€” ${v.note||""}`.trim(),
      debit:Number(v.amount||0), credit:0,
      ccId:(v.ccId||"CC-00"), ccName:(v.ccName||getCCName(v.ccId||"CC-00"))
    });
  });

  rows.sort((a,b)=> (a.date>b.date?1:(a.date<b.date?-1:(a.ref>b.ref?1:-1))));
  let bal=0, td=0, tc=0;
  const body = rows.map(r=>{
    bal += (r.credit - r.debit); // vendor: we owe
    td += r.debit; tc += r.credit;
    const balLabel = bal>=0 ? `Ù„Ù‡: ${fmt(bal)}` : `Ø¹Ù„ÙŠÙ‡: ${fmt(Math.abs(bal))}`;
    return `<tr>
      <td>${r.date}</td>
      <td class="mono">${r.ref}</td>
      <td>${r.desc||"<span style='color:var(--muted)'>â€”</span>"}<div style="color:var(--muted);font-size:12px;line-height:1.6">CC: <span class="mono">${r.ccId}</span> ${r.ccName||""}</div></td>
      <td>${fmt(r.debit)}</td>
      <td>${fmt(r.credit)}</td>
      <td>${balLabel}</td>
    </tr>`;
  }).join("");

  const finalLabel = bal>=0 ? `Ù„Ù‡: ${fmt(bal)} ${DB.meta.currency}` : `Ø¹Ù„ÙŠÙ‡: ${fmt(Math.abs(bal))} ${DB.meta.currency}`;
  $("#reportArea").innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div class="badge">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ù…ÙˆØ±Ø¯</div>
      <div class="badge">Ø§Ù„Ù…ÙˆØ±Ø¯: ${party.name}</div>
    </div>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <div class="badge">Ù…Ù†: ${from||"Ø¨Ø¯Ø§ÙŠØ©"} â€¢ Ø¥Ù„Ù‰: ${to||"Ù†Ù‡Ø§ÙŠØ©"}</div>
      <div class="badge">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${finalLabel}</div>
    </div>
    <div class="hr"></div>
    <div style="overflow:auto">
      <table>
        <thead><tr>
          <th style="min-width:110px">ØªØ§Ø±ÙŠØ®</th>
          <th style="min-width:90px">Ù…Ø±Ø¬Ø¹</th>
          <th>Ø§Ù„ÙˆØµÙ</th>
          <th style="min-width:120px">Ù…Ø¯ÙŠÙ†</th>
          <th style="min-width:120px">Ø¯Ø§Ø¦Ù†</th>
          <th style="min-width:140px">Ø§Ù„Ø±ØµÙŠØ¯</th>
        </tr></thead>
        <tbody>
          ${body || `<tr><td colspan="6" style="color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ©</td></tr>`}
          <tr>
            <th colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th>${fmt(td)}</th>
            <th>${fmt(tc)}</th>
            <th>${finalLabel}</th>
          </tr>
        </tbody>
      </table>
    </div>
  `;
}

function renderGeneralLedger(accId, from, to, ccIdFilter="ALL"){
  const acc = DB.accounts.find(a=>a.id===accId);
  if(!acc) return $("#reportArea").innerHTML = `<div class="badge">Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>`;

  const debitNormal = ["asset","expense"].includes(acc.type);
  const lines = [];
  journalInRange(from,to).forEach(j=>{
    j.lines.forEach(l=>{
      if(l.accId!==accId) return;
      if(ccIdFilter && ccIdFilter!=="ALL" && (l.ccId||"CC-00")!==ccIdFilter) return;
      lines.push({
        date:j.date, ref:j.no, memo:j.memo||"",
        ccId:l.ccId||"CC-00", ccName:l.ccName||getCCName(l.ccId||"CC-00"),
        debit:Number(l.debit||0), credit:Number(l.credit||0)
      });
    });
  });

  lines.sort((a,b)=> (a.date>b.date?1:(a.date<b.date?-1:(a.ref>b.ref?1:-1))));
  let bal=0, td=0, tc=0;
  const body = lines.map(r=>{
    td += r.debit; tc += r.credit;
    bal += debitNormal ? (r.debit - r.credit) : (r.credit - r.debit);
    const balLabel = bal>=0 ? fmt(bal) : `-${fmt(Math.abs(bal))}`;
    return `<tr>
      <td>${r.date}</td>
      <td class="mono">${r.ref}</td>
      <td>${r.memo || "<span style='color:var(--muted)'>â€”</span>"}<div style="color:var(--muted);font-size:12px;line-height:1.6">CC: <span class="mono">${r.ccId}</span> ${r.ccName}</div></td>
      <td>${fmt(r.debit)}</td>
      <td>${fmt(r.credit)}</td>
      <td>${balLabel}</td>
    </tr>`;
  }).join("");

  const nature = debitNormal ? "Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨: Ù…Ø¯ÙŠÙ†" : "Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨: Ø¯Ø§Ø¦Ù†";
  $("#reportArea").innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div class="badge">Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</div>
      <div class="badge"><span class="mono">${acc.id}</span> â€” ${acc.name}</div>
    </div>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <div class="badge">${nature}</div>
      <div class="badge">Ù…Ù†: ${from||"Ø¨Ø¯Ø§ÙŠØ©"} â€¢ Ø¥Ù„Ù‰: ${to||"Ù†Ù‡Ø§ÙŠØ©"}</div>
    </div>
    <div class="hr"></div>
    <div style="overflow:auto">
      <table>
        <thead><tr>
          <th style="min-width:110px">ØªØ§Ø±ÙŠØ®</th>
          <th style="min-width:90px">Ù‚ÙŠØ¯</th>
          <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
          <th style="min-width:120px">Ù…Ø¯ÙŠÙ†</th>
          <th style="min-width:120px">Ø¯Ø§Ø¦Ù†</th>
          <th style="min-width:140px">Ø§Ù„Ø±ØµÙŠØ¯</th>
        </tr></thead>
        <tbody>
          ${body || `<tr><td colspan="6" style="color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ©</td></tr>`}
          <tr>
            <th colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th>${fmt(td)}</th>
            <th>${fmt(tc)}</th>
            <th>${bal>=0?fmt(bal):`-${fmt(Math.abs(bal))}`}</th>
          </tr>
        </tbody>
      </table>
    </div>
  `;
}

}

/* ---------------- PDF ---------------- */
function printInvoicePDF(type, id){
  const inv = (type==="sale" ? DB.sales : DB.purchases).find(x=>x.id===id);
  if(!inv) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});
  const W = doc.internal.pageSize.getWidth();

  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text(DB.meta.company || "Ø´Ø±ÙƒØªÙŠ", W-40, 50, {align:"right"});
  doc.setFontSize(12);
  doc.setFont("helvetica","normal");
  doc.text(type==="sale" ? "ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹" : "ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡", W-40, 72, {align:"right"});

  doc.text(`Ø±Ù‚Ù…: ${inv.no}`, W-40, 98, {align:"right"});
  doc.text(`ØªØ§Ø±ÙŠØ®: ${inv.date}`, W-40, 118, {align:"right"});
  doc.text(`Ø§Ù„Ø·Ø±Ù: ${type==="sale"?inv.customerName:inv.vendorName}`, W-40, 138, {align:"right"});
  if(inv.ccId) doc.text(`Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ©: ${inv.ccId} - ${inv.ccName}`, W-40, 158, {align:"right"});

  let y=190;
  doc.setFont("helvetica","bold");
  doc.text("Ø§Ù„ØµÙ†Ù", W-40, y, {align:"right"});
  doc.text("Ø§Ù„ÙƒÙ…ÙŠØ©", W-180, y, {align:"right"});
  doc.text("Ø§Ù„Ø³Ø¹Ø±", W-270, y, {align:"right"});
  doc.text("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", W-360, y, {align:"right"});
  doc.setFont("helvetica","normal");
  y+=14; doc.line(40,y, W-40, y); y+=18;

  (inv.items||[]).forEach(it=>{
    doc.text(String(it.name), W-40, y, {align:"right"});
    doc.text(String(it.qty), W-180, y, {align:"right"});
    doc.text(String(fmt(it.price||it.unitCost||0)), W-270, y, {align:"right"});
    doc.text(String(fmt(it.total||0)), W-360, y, {align:"right"});
    y+=18; if(y>740){ doc.addPage(); y=60; }
  });

  y+=10; doc.line(40,y, W-40, y); y+=24;
  doc.setFont("helvetica","bold");
  doc.text(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${fmt(inv.total)} ${DB.meta.currency}`, W-40, y, {align:"right"});
  doc.setFont("helvetica","normal");
  y+=22;
  if(inv.cogs!=null) doc.text(`ØªÙƒÙ„ÙØ© Ù…Ø¨ÙŠØ¹Ø§Øª: ${fmt(inv.cogs)} ${DB.meta.currency}`, W-40, y, {align:"right"});
  y+=22;
  doc.text(`Ù…Ù„Ø§Ø­Ø¸Ø©: ${inv.note||"â€”"}`, W-40, y, {align:"right"});
  doc.save(`${inv.no}.pdf`);
}
function printVoucherPDF(id){
  const v=DB.vouchers.find(x=>x.id===id); if(!v) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});
  const W = doc.internal.pageSize.getWidth();

  doc.setFont("helvetica","bold"); doc.setFontSize(16);
  doc.text(DB.meta.company || "Ø´Ø±ÙƒØªÙŠ", W-40, 50, {align:"right"});
  doc.setFontSize(12); doc.setFont("helvetica","normal");
  doc.text(v.type==="receipt" ? "Ø³Ù†Ø¯ Ù‚Ø¨Ø¶" : "Ø³Ù†Ø¯ ØµØ±Ù", W-40, 72, {align:"right"});
  doc.text(`Ø±Ù‚Ù…: ${v.no}`, W-40, 98, {align:"right"});
  doc.text(`ØªØ§Ø±ÙŠØ®: ${v.date}`, W-40, 118, {align:"right"});
  doc.text(`Ø§Ù„Ø·Ø±Ù: ${v.partyName}`, W-40, 138, {align:"right"});
  doc.text(`Ù…Ø±ÙƒØ² ÙƒÙ„ÙØ©: ${v.ccId} - ${v.ccName}`, W-40, 158, {align:"right"});
  doc.setFont("helvetica","bold");
  doc.text(`Ø§Ù„Ù…Ø¨Ù„Øº: ${fmt(v.amount)} ${DB.meta.currency}`, W-40, 186, {align:"right"});
  doc.setFont("helvetica","normal");
  doc.text(`Ø§Ù„Ø¨ÙŠØ§Ù†: ${v.note||"â€”"}`, W-40, 212, {align:"right"});
  doc.save(`${v.no}.pdf`);
}

/* ---------------- Backup / Restore / Excel ---------------- */
$("#btnBackup").onclick=()=>{
  if(!CURRENT_USER) return toast("Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹","bad");
  setDrawer(false);
  downloadText(`backup_${(DB.meta.company||"company").replace(/\s+/g,"_")}_${todayISO()}.json`, JSON.stringify(DB,null,2));
  toast("ØªÙ… ØªÙ†Ø²ÙŠÙ„ Backup","good");
};
$("#btnRestore").onclick=async()=>{
  if(!CURRENT_USER) return toast("Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹","bad");
  setDrawer(false);
  const f=await pickFile(".json"); if(!f) return;
  try{
    const obj=JSON.parse(await f.text());
    if(!obj?.meta || !obj?.accounts) throw new Error("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
    DB=obj; saveDB();
    loadSettingsToUI();
    toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯","good");
    setPanel(ACTIVE);
    fillCCSelects();
  }catch(e){ toast(e.message||"ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯","bad"); }
};
$("#btnExportXlsx").onclick=()=>{
  if(!CURRENT_USER) return toast("Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹","bad");
  setDrawer(false);
  const wb = XLSX.utils.book_new();
  const addSheet=(name, rows)=>{
    const ws=XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, name);
  };
  addSheet("Settings", [DB.meta]);
  addSheet("CostCenters", DB.costCenters);
  addSheet("Items", DB.items);
  addSheet("Customers", DB.customers);
  addSheet("Vendors", DB.vendors);
  addSheet("Accounts", DB.accounts);
  addSheet("Journal", DB.journal.map(j=>({
    no:j.no,date:j.date,memo:j.memo,source:(j.source?.type||""),
    debit:sumLines(j.lines).debit, credit:sumLines(j.lines).credit
  })));
  addSheet("JournalLines", DB.journal.flatMap(j=> j.lines.map(l=>({
    jv_no:j.no, date:j.date, memo:j.memo, accId:l.accId, accName:l.accName, ccId:l.ccId, ccName:l.ccName, debit:l.debit, credit:l.credit
  }))));
  addSheet("BOMs", DB.boms.map(b=>({product:b.productName, unit:b.unit, stdCost:b.stdCost})));
  addSheet("BOMComponents", DB.boms.flatMap(b=> (b.components||[]).map(c=>({product:b.productName, item:c.name, qty:c.qty})) ));
  addSheet("WorkOrders", DB.workOrders);
  XLSX.writeFile(wb, `ERP_Export_${todayISO()}.xlsx`);
  toast("ØªÙ… ØªØµØ¯ÙŠØ± Excel","good");
};

/* ---------------- Login/Logout ---------------- */
$("#btnLogout").onclick=()=>{
  setDrawer(false);
  clearSession(); CURRENT_USER=null; showLogin(); toast("ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬");
};
$("#btnLogin").onclick=()=>{
  const u=($("#loginUser").value||"").trim();
  const p=($("#loginPass").value||"").trim();
  const user=DB.users.find(x=>x.username===u && x.password===p);
  if(!user) return toast("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©","bad");
  CURRENT_USER=user; setSession(user);
  showApp();
  toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„","good");
};
function autoLoginIfSession(){
  const s=getSession(); if(!s) return false;
  const user=DB.users.find(x=>x.id===s.userId); if(!user) return false;
  CURRENT_USER=user; return true;
}

/* ---------------- Drawer wiring ---------------- */
$("#btnMenu").onclick=()=> setDrawer(true);
$("#btnCloseDrawer").onclick=()=> setDrawer(false);
$("#drawerOverlay").onclick=()=> setDrawer(false);
window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") setDrawer(false); });
document.querySelectorAll("[data-nav]").forEach(b=>{
  b.onclick=()=>{
    const key=b.getAttribute("data-nav");
    setDrawer(false);
    setPanel(key);
  };
});

$("#repType").addEventListener("change", setReportUiByType);

/* ---------------- Init ---------------- */
function initDates(){
  const d=todayISO();
  ["dashFrom","dashTo","journalFrom","journalTo","saleFrom","saleTo","purFrom","purTo","repFrom","repTo"].forEach(id=>{ if($("#"+id)) $("#"+id).value=""; });
  const now=new Date();
  const first=new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10);
  $("#dashFrom").value=first; $("#dashTo").value=d;
}
(function boot(){
  loadDB();
  initDates();
  fillCCSelects();

  if(autoLoginIfSession()){
    showApp();
  }else{
    showLogin();
  }

  // initial renders
  renderMasters();
  renderCOA();
  renderPurchasesTable();
  renderSalesTable();
  renderVouchersTable();
  renderBOMs();
  renderWOs();
  renderJournalTable();
  refreshDashboard();
})();
</script>
</body>
</html>

<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | Admin</title>
<style>
:root{
  --bg:#0b1220;
  --card:#0f1a33;
  --line:rgba(255,255,255,.10);
  --text:#eef3ff;
  --muted:#a6b6ea;
  --blue:#2b6bff;
  --green:#18c37e;
  --red:#ff4d4d;
  --amber:#ffb020;
  --shadow: 0 14px 34px rgba(0,0,0,.35);
  --r:18px;
  --r2:22px;
  --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic","Noto Sans Arabic", Tahoma, Arial;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--font);
  color:var(--text);
  background:
    radial-gradient(1100px 650px at 10% 0%, rgba(43,107,255,.22), transparent 55%),
    radial-gradient(900px 650px at 100% 10%, rgba(24,195,126,.12), transparent 55%),
    radial-gradient(800px 520px at 40% 90%, rgba(255,176,32,.10), transparent 60%),
    var(--bg);
  direction:rtl;
}
a{color:inherit}
button,input,select,textarea{font-family:inherit}
.container{max-width:1180px; margin:0 auto; padding:16px}
.topbar{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:12px 14px;
  border:1px solid var(--line);
  border-radius:var(--r2);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow:var(--shadow);
  position:sticky; top:12px; z-index:30; backdrop-filter: blur(10px);
}
.brand{display:flex; align-items:center; gap:10px; min-width:0}
.logo{
  width:44px;height:44px;border-radius:14px;
  border:1px solid var(--line);
  background:linear-gradient(135deg, rgba(43,107,255,.35), rgba(24,195,126,.20));
  overflow:hidden; display:grid; place-items:center;
}
.logo img{width:100%;height:100%;object-fit:cover}
.brand .txt{display:flex;flex-direction:column;min-width:0}
.brand .txt b{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.brand .txt span{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
.pill{
  padding:8px 10px; border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  font-size:12px; color:var(--muted);
}
.btn{
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:10px 12px;
  border-radius:14px;
  cursor:pointer;
  font-weight:900;
  display:inline-flex; align-items:center; gap:8px;
}
.btn:active{transform:translateY(1px)}
.btn.primary{background:linear-gradient(135deg, rgba(43,107,255,.95), rgba(43,107,255,.70)); border-color:rgba(43,107,255,.35)}
.btn.green{background:linear-gradient(135deg, rgba(24,195,126,.95), rgba(24,195,126,.70)); border-color:rgba(24,195,126,.35)}
.btn.red{background:linear-gradient(135deg, rgba(255,77,77,.95), rgba(255,77,77,.70)); border-color:rgba(255,77,77,.35)}
.btn.ghost{background:transparent}
.grid{display:grid; gap:14px}
@media(min-width:920px){ .grid.cols2{grid-template-columns: 1.2fr .8fr} }
.card{
  border:1px solid var(--line);
  border-radius:var(--r2);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow:var(--shadow);
  overflow:hidden;
}
.card .hd{padding:14px 14px 10px; border-bottom:1px solid var(--line); display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
.card .hd h2{margin:0; font-size:14px}
.card .hd p{margin:6px 0 0; font-size:12px; color:var(--muted)}
.card .bd{padding:14px}
.row{display:grid; gap:10px}
@media(min-width:820px){
  .row.cols2{grid-template-columns:1fr 1fr}
  .row.cols3{grid-template-columns:1fr 1fr 1fr}
  .row.cols4{grid-template-columns:1fr 1fr 1fr 1fr}
  .row.cols5{grid-template-columns:1fr 1fr 1fr 1fr 1fr}
}
.field{display:flex; flex-direction:column; gap:6px}
label{font-size:12px; color:var(--muted)}
input,select,textarea{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(10,16,30,.55);
  color:var(--text);
  outline:none;
}
textarea{min-height:96px; resize:vertical}
.small{font-size:12px; color:var(--muted)}
hr.sep{border:none;border-top:1px solid var(--line); margin:12px 0}
.tableWrap{overflow:auto; border:1px solid var(--line); border-radius:16px}
table{width:100%; border-collapse:collapse; min-width:860px; background:rgba(0,0,0,.15)}
th,td{padding:10px; border-bottom:1px solid var(--line); text-align:right; font-size:12px}
th{color:var(--muted); font-weight:900; background:rgba(255,255,255,.04); position:sticky; top:0}
tr:hover td{background:rgba(255,255,255,.03)}
.tag{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;border:1px solid var(--line);
  background:rgba(255,255,255,.03); font-size:12px; color:var(--muted)
}
.tag.good{color:#bff7df; border-color:rgba(24,195,126,.30); background:rgba(24,195,126,.10)}
.tag.bad{color:#ffc0c0; border-color:rgba(255,77,77,.30); background:rgba(255,77,77,.10)}
.tag.warn{color:#ffe0b3; border-color:rgba(255,176,32,.30); background:rgba(255,176,32,.10)}
.toast{
  position:fixed; inset:auto 14px 14px 14px; max-width:720px; margin:0 auto;
  display:none; gap:10px; align-items:flex-start;
  background:rgba(10,16,30,.92);
  border:1px solid var(--line);
  border-radius:18px; padding:12px;
  box-shadow:var(--shadow);
  z-index:120;
}
.toast.show{display:flex}
.toast .dot{width:10px;height:10px;border-radius:999px;background:var(--green); margin-top:6px}
.toast .msg{font-size:13px; line-height:1.4}
.drawerOverlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:60}
.drawerOverlay.show{display:block}
.drawer{
  position:fixed; inset:0 auto 0 0; width:min(320px, 88vw);
  background:linear-gradient(180deg, rgba(15,26,51,.98), rgba(11,18,32,.98));
  border-right:1px solid var(--line);
  transform:translateX(-105%); transition:transform .25s ease;
  z-index:70;
  padding:14px;
  display:flex; flex-direction:column; gap:12px;
}
.drawer.show{transform:translateX(0)}
.nav{display:flex; flex-direction:column; gap:8px}
.nav button{
  width:100%;
  text-align:right;
  padding:12px;
  border-radius:16px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  color:var(--text);
  cursor:pointer;
  font-weight:900;
}
.nav button.active{border-color:rgba(43,107,255,.55); background:rgba(43,107,255,.15)}
.kpis{display:grid; gap:10px}
@media(min-width:820px){.kpis{grid-template-columns:repeat(4,1fr)}}
.kpi{padding:12px;border:1px solid var(--line); border-radius:18px; background:rgba(255,255,255,.03)}
.kpi b{display:block; font-size:12px; color:var(--muted)}
.kpi span{display:block; font-size:18px; font-weight:1000; margin-top:6px}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  border:1px solid var(--line); border-radius:16px; padding:10px 12px;
  background:rgba(255,255,255,.03);
  font-size:12px; color:var(--muted)
}
.loginTabs{display:flex; gap:10px; flex-wrap:wrap}
.loginTabs .btn{flex:1}
.hint{font-size:12px;color:var(--muted)}
.printArea{direction:rtl; font-family:var(--font); color:#111}
.printTitle{font-size:20px;font-weight:900;margin:0 0 10px}
.printSub{margin:0 0 10px; color:#333}
.printBox{border:1px solid #ddd; border-radius:12px; padding:12px}
.printTable{width:100%; border-collapse:collapse}
.printTable th,.printTable td{border-bottom:1px solid #eee; padding:8px; font-size:12px; text-align:right}

.nav button.danger{background:rgba(255,77,77,.12); border-color:rgba(255,77,77,.35)}
.nav button.danger:hover{background:rgba(255,77,77,.18)}

</style>
<script>
/* ====== Payroll App (Static / LocalStorage) ====== */
const APP_KEY = "payrollApp_v1";

function deepClone(v){ return JSON.parse(JSON.stringify(v)); }
function uid(prefix="id"){ return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`; }
function toast(msg, type="ok"){
  const el = document.getElementById("toast");
  if(!el) return;
  const dot = el.querySelector(".dot");
  dot.style.background = type==="bad" ? "var(--red)" : (type==="warn" ? "var(--amber)" : "var(--green)");
  el.querySelector(".msg").textContent = msg;
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>el.classList.remove("show"), 2600);
}
function fmtMoney(n){
  n = Number(n);
  if(!isFinite(n)) n = 0;
  return (Math.round(n*100)/100).toLocaleString('ar-EG', {minimumFractionDigits:2, maximumFractionDigits:2});
}
function nowISODate(){
  const d=new Date();
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function yyyymm(d=new Date()){
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0');
  return `${yyyy}-${mm}`;
}
function prevYYYYMM(ym){
  const [y,m]=ym.split('-').map(Number);
  const d=new Date(y, m-1, 1);
  d.setMonth(d.getMonth()-1);
  return yyyymm(d);
}
function parseTimeToMinutes(hhmm){
  if(!hhmm) return null;
  const m=/^(\d{1,2}):(\d{2})$/.exec(String(hhmm).trim());
  if(!m) return null;
  const h=Number(m[1]), mi=Number(m[2]);
  if(h<0||h>23||mi<0||mi>59) return null;
  return h*60+mi;
}
function minutesToHHMM(min){
  min = Math.max(0, Math.floor(min));
  const h=Math.floor(min/60), m=min%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

function getApp(){
  try{
    const raw = localStorage.getItem(APP_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function setApp(obj){ localStorage.setItem(APP_KEY, JSON.stringify(obj)); }
function ensureApp(){
  let app = getApp();
  const ym = yyyymm();
  if(!app){
    app = {
      company:{ companyName:"", companyLogo:"" },
      departments:[],
      employees:[],
      managers:[{ id: uid("mgr"), username:"manager", password:"manager123" }],
      monthSettings:{},
      attendance:{},
      advances:{},
      advancesList:[]
    };
  }
  if(!Array.isArray(app.managers) || !app.managers.find(m=>m.username==="manager")){
    app.managers = Array.isArray(app.managers) ? app.managers : [];
    app.managers.push({ id: uid("mgr"), username:"manager", password:"manager123" });
  }
  if(!app.monthSettings) app.monthSettings = {};
  if(!app.monthSettings[ym]){
    const d=new Date();
    const daysInMonth = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    app.monthSettings[ym] = {
      daysInMonth,
      workHoursInMonth: 176,
      shiftStart:"09:00",
      shiftEnd:"17:00",
      lateGraceMinutes: 10,
      earlyLeaveGraceMinutes: 10,
      latePenaltyMultiplier: 1.5,
      earlyPenaltyMultiplier: 1.5,
      overtimeMultiplier: 1.5
    };
  }
  if(!app.attendance) app.attendance = {};
  if(!app.advances) app.advances = {};

  if(!Array.isArray(app.advancesList)) app.advancesList = [];
  // Migration from legacy structure app.advances[ym][empId]={amount,note}
  if(app.advances && Object.keys(app.advances).length && app.advancesList.length===0){
    try{
      for(const ymKey of Object.keys(app.advances||{})){
        const m = app.advances[ymKey]||{};
        for(const empId of Object.keys(m||{})){
          const a = m[empId]||{};
          const amount = Number(a.amount||0);
          if(!amount) continue;
          app.advancesList.push({
            id: uid("adv"),
            date: `${ymKey}-01`,
            ym: ymKey,
            employeeId: empId,
            amount,
            note: (a.note||"").trim() || "â€” (Ù…Ù‡Ø§Ø¬Ø±Ø© Ù…Ù† Ù†Ø³Ø®Ø© Ù‚Ø¯ÙŠÙ…Ø©)"
          });
        }
      }
    }catch(e){}
  }

  if(!app.departments) app.departments = [];
  if(!app.employees) app.employees = [];
  if(!app.company) app.company = { companyName:"", companyLogo:"" };
  setApp(app);
  return app;
}
function updateApp(mutator){
  const app = ensureApp();
  const draft = deepClone(app);
  mutator(draft);
  setApp(draft);
  return draft;
}

function sessionSet(obj){ sessionStorage.setItem(`${APP_KEY}:session`, JSON.stringify(obj)); }
function sessionGet(){ try{ return JSON.parse(sessionStorage.getItem(`${APP_KEY}:session`)||"null"); }catch(e){ return null; } }
function sessionClear(){ sessionStorage.removeItem(`${APP_KEY}:session`); }

function requireRole(roles){
  const s = sessionGet();
  if(!s || !roles.includes(s.role)) return null;
  return s;
}

function csvParse(text){
  const rows = [];
  const lines = String(text||"").replace(/\r/g,"").split("\n").filter(l=>l.trim().length);
  if(!lines.length) return rows;
  const sep = (lines[0].includes(";") && !lines[0].includes(",")) ? ";" : ",";
  for(const line of lines){
    const out=[];
    let cur="", inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){
        if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
        else inQ = !inQ;
      }else if(ch===sep && !inQ){
        out.push(cur.trim()); cur="";
      }else cur+=ch;
    }
    out.push(cur.trim());
    rows.push(out);
  }
  return rows;
}
function csvStringify(rows){
  return rows.map(r => r.map(v=>{
    const s=String(v??"");
    if(/[",\n;]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }).join(",")).join("\n");
}
function downloadText(filename, text, mime="text/plain;charset=utf-8"){
  const blob=new Blob([text],{type:mime});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
}
function downloadJSON(filename, obj){ downloadText(filename, JSON.stringify(obj,null,2), "application/json;charset=utf-8"); }

async function readFileText(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(String(fr.result||""));
    fr.onerror=()=>rej(fr.error||new Error("FileReader error"));
    fr.readAsText(file,"utf-8");
  });
}

/* ====== Payroll Logic ====== */
function computeDayMetrics(settings, rec){
  // returns {lateMinutes, earlyLeaveMinutes, overtimeMinutes, absent}
  const s=settings;
  const start = parseTimeToMinutes(s.shiftStart);
  const end = parseTimeToMinutes(s.shiftEnd);
  const checkIn = parseTimeToMinutes(rec.checkIn);
  const checkOut = parseTimeToMinutes(rec.checkOut);

  const excuse = rec.excuseType || "none";
  const hasTimes = (checkIn!=null && checkOut!=null);

  let late=0, early=0, ot=0, absent=false;

  if(!hasTimes){
    // no in/out -> absent
    absent=true;
  }else{
    if(checkIn>start){
      late = Math.max(0, checkIn - start - Number(s.lateGraceMinutes||0));
    }
    if(checkOut<end){
      early = Math.max(0, end - checkOut - Number(s.earlyLeaveGraceMinutes||0));
    }
    if(checkOut>end){
      ot = Math.max(0, checkOut - end);
    }
  }

  if(excuse==="late_excused") late=0;
  if(excuse==="early_excused") early=0;
  if(excuse==="absent_excused"){ absent=true; late=0; early=0; ot=0; }

  return { lateMinutes:late, earlyLeaveMinutes:early, overtimeMinutes:ot, absent };
}

function computePayrollForEmployee(app, emp, ym){
  const settings = app.monthSettings[ym] || app.monthSettings[yyyymm()] || {};
  const workHoursInMonth = Number(settings.workHoursInMonth||176);
  const hourValue = (Number(emp.monthlySalary||0) / (workHoursInMonth || 1));

  // advances (multiple records by date)
  const advances = sumAdvancesForMonth(app, ym, emp.id);
// attendance records for month
  let lateMin=0, earlyMin=0, otMin=0;
  let absentExcusedDays=0, absentNoExcuseDays=0;
  const rows = [];

  for(const dateKey of Object.keys(app.attendance||{})){
    if(!dateKey.startsWith(ym+"-")) continue;
    const day = app.attendance[dateKey] || {};
    const rec = day[emp.id];
    if(!rec) continue;

    const m = computeDayMetrics(settings, rec);
    lateMin += m.lateMinutes;
    earlyMin += m.earlyLeaveMinutes;
    otMin += m.overtimeMinutes;

    if(m.absent){
      if((rec.excuseType||"none")==="absent_excused") absentExcusedDays += 1;
      else if(!rec.checkIn && !rec.checkOut) absentNoExcuseDays += 1;
    }

    rows.push({
      date: dateKey,
      checkIn: rec.checkIn || "",
      checkOut: rec.checkOut || "",
      excuseType: rec.excuseType || "none",
      outOfFactory: !!rec.outOfFactory,
      note: rec.note || "",
      advancesOnDate: sumAdvancesOnDate(app, dateKey, emp.id),
      ...m
    });
  }

  // Deduction & additions
  const lateDeduction = (lateMin/60) * hourValue * Number(settings.latePenaltyMultiplier||1.5);
  const earlyDeduction = (earlyMin/60) * hourValue * Number(settings.earlyPenaltyMultiplier||1.5);
  const otValue = (otMin/60) * hourValue * Number(settings.overtimeMultiplier||1.5);

  // absent without excuse -> deduct full day based on salary/daysInMonth, multiplier
  const daysInMonth = Number(settings.daysInMonth||30);
  const dayValue = (Number(emp.monthlySalary||0) / (daysInMonth || 1));
  const absenceNoExcuseFactor = Number((settings.absenceNoExcuseFactor ?? 1.0));
  const absenceNoExcuseDeduction = absentNoExcuseDays * dayValue * absenceNoExcuseFactor;

  const base = Number(emp.monthlySalary||0);

  // if employee has no attendance at all in month => net=0 (as requested in spec)
  const hasAny = rows.length > 0;
  let net = base + otValue - lateDeduction - earlyDeduction - absenceNoExcuseDeduction - advances;
  if(!hasAny) net = 0;

  return {
    ym,
    hourValue,
    baseSalary: base,
    totals:{
      baseSalary: base,
      lateMinutes: lateMin,
      earlyLeaveMinutes: earlyMin,
      overtimeMinutes: otMin,
      absentExcusedDays,
      absentNoExcuseDays,
      advances,
      lateDeduction,
      earlyDeduction,
      overtimeValue: otValue,
      absenceNoExcuseDeduction,
      net
    },
    rows: rows.sort((a,b)=>a.date.localeCompare(b.date))
  };
}

/* ====== Printing (Receipt PDF via Print) ====== */
function openReceiptPrintWindow(app, emp, ym){
  const dept = (app.departments||[]).find(d=>d.id===emp.departmentId);
  const payroll = computePayrollForEmployee(app, emp, ym);
  const companyName = (app.company?.companyName || "").trim() || "â€”";
  const logo = app.company?.companyLogo || "";

  const rowsHtml = payroll.rows.map(r=>{
    const exMap = {
      none:"Ø¨Ø¯ÙˆÙ†",
      late_excused:"ØªØ£Ø®ÙŠØ± Ø¨Ø¹Ø°Ø±",
      early_excused:"Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ± Ø¨Ø¹Ø°Ø±",
      absent_excused:"ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±"
    };
    return `<tr>
      <td>${r.date}</td>
      <td>${arDayName(r.date)}</td>
      <td>${r.checkIn||"â€”"}</td>
      <td>${r.checkOut||"â€”"}</td>
      <td>${((r.overtimeMinutes||0)/60).toFixed(2)}</td>
      <td>${((r.lateMinutes||0)/60).toFixed(2)}</td>
      <td>${((r.earlyLeaveMinutes||0)/60).toFixed(2)}</td>
      <td>${fmtMoney(r.advancesOnDate||0)}</td>
      <td>${exMap[r.excuseType]||"Ø¨Ø¯ÙˆÙ†"}</td>
      <td>${r.outOfFactory?"Ù†Ø¹Ù…":"Ù„Ø§"}</td>
      <td>${(r.note||"").replace(/</g,"&lt;")}</td>
    </tr>`;
  }).join("");

  const html = `<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ØµÙƒ Ù‚Ø¨Ø¶ - ${emp.name}</title>
  <style>
    body{font-family: ui-sans-serif, system-ui, "Noto Kufi Arabic","Noto Sans Arabic", Tahoma, Arial; background:#fff; color:#111; margin:0; padding:18px}
    .row{display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .box{border:1px solid #e6e6e6; border-radius:14px; padding:14px}
    .logo{width:54px;height:54px;border-radius:14px; overflow:hidden; border:1px solid #eee; display:grid; place-items:center}
    .logo img{width:100%;height:100%;object-fit:cover}
    h1{margin:0; font-size:20px}
    p{margin:6px 0 0; color:#333; font-size:12px}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{border-bottom:1px solid #eee; padding:8px; font-size:12px; text-align:right}
    th{background:#fafafa}
    .k{color:#666; font-size:12px}
    .v{font-weight:800}
    .sig{display:flex; gap:14px; margin-top:16px}
    .sig .s{flex:1; border-top:1px dashed #bbb; padding-top:10px; text-align:center; color:#333}
    @media print{ body{padding:0} .noPrint{display:none} }
  </style>
  </head><body>
    <div class="noPrint" style="margin-bottom:10px">
      <button onclick="window.print()" style="padding:10px 12px; border-radius:12px; border:1px solid #ddd; background:#0b1220; color:#fff; font-weight:800; cursor:pointer">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
    </div>

    <div class="box">
      <div class="row">
        <div class="row" style="gap:10px">
          <div class="logo">${logo ? `<img src="${logo}"/>` : `<span style="font-weight:900;color:#0b1220">ğŸ¢</span>`}</div>
          <div>
            <h1>ØµÙƒ Ù‚Ø¨Ø¶ Ø±Ø§ØªØ¨</h1>
            <p>${companyName}</p>
          </div>
        </div>
        <div style="text-align:left">
          <div class="k">Ø§Ù„Ø´Ù‡Ø±</div>
          <div class="v">${ym}</div>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <div><span class="k">Ø§Ù„Ù…ÙˆØ¸Ù:</span> <span class="v">${emp.name}</span></div>
        <div><span class="k">Ø§Ù„Ù‚Ø³Ù…:</span> <span class="v">${dept?dept.name:"â€”"}</span></div>
        <div><span class="k">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:</span> <span class="v">${fmtMoney(payroll.totals.baseSalary)}</span></div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¯Ø®ÙˆÙ„</th><th>Ø§Ù„Ø®Ø±ÙˆØ¬</th><th>Ø§Ù„Ø¹Ø°Ø±</th><th>Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ØµÙ†Ø¹</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml || `<tr><td colspan="6" style="text-align:center;color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</td></tr>`}
        </tbody>
      </table>

      <div class="row" style="margin-top:12px">
        <div><span class="k">Ø¥Ø¶Ø§ÙÙŠ (Ø¯Ù‚Ø§Ø¦Ù‚):</span> <span class="v">${payroll.totals.overtimeMinutes}</span></div>
        <div><span class="k">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ:</span> <span class="v">${fmtMoney(payroll.totals.overtimeValue)}</span></div>
        <div><span class="k">ØªØ£Ø®ÙŠØ± (Ø¯Ù‚Ø§Ø¦Ù‚):</span> <span class="v">${payroll.totals.lateMinutes}</span></div>
        <div><span class="k">Ø®ØµÙ… Ø§Ù„ØªØ£Ø®ÙŠØ±:</span> <span class="v">${fmtMoney(payroll.totals.lateDeduction)}</span></div>
        <div><span class="k">Ù…Ø¨ÙƒØ± (Ø¯Ù‚Ø§Ø¦Ù‚):</span> <span class="v">${payroll.totals.earlyLeaveMinutes}</span></div>
        <div><span class="k">Ø®ØµÙ… Ø§Ù„Ù…Ø¨ÙƒØ±:</span> <span class="v">${fmtMoney(payroll.totals.earlyDeduction)}</span></div>
        <div><span class="k">ØºÙŠØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø± (Ø£ÙŠØ§Ù…):</span> <span class="v">${payroll.totals.absentNoExcuseDays}</span></div>
        <div><span class="k">Ø®ØµÙ… Ø§Ù„ØºÙŠØ§Ø¨:</span> <span class="v">${fmtMoney(payroll.totals.absenceNoExcuseDeduction)}</span></div>
        <div><span class="k">Ø§Ù„Ø³Ù„Ù:</span> <span class="v">${fmtMoney(payroll.totals.advances)}</span></div>
        <div style="flex:1"></div>
        <div style="min-width:220px"><span class="k">Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span> <span class="v" style="font-size:16px">${fmtMoney(payroll.totals.net)}</span></div>
      </div>

      <div class="sig">
        <div class="s">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸Ù</div>
        <div class="s">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
      </div>
    </div>
  </body></html>`;

  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* ====== UI helpers ====== */
function setBrandFromCompany(){
  const app = ensureApp();
  const name = (app.company?.companyName||"").trim() || "Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ù… ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨";
  const elName = document.querySelector("[data-company-name]");
  if(elName) elName.textContent = name;
  const img = document.querySelector("[data-company-logo]");
  if(img){
    if(app.company?.companyLogo){
      img.src = app.company.companyLogo;
      img.style.display="block";
    }else{
      img.removeAttribute("src");
      img.style.display="none";
    }
  }
}
function drawerInit(){
  const overlay = document.getElementById("drawerOverlay");
  const drawer = document.getElementById("drawer");
  const btn = document.getElementById("btnMenu");
  function close(){ overlay?.classList.remove("show"); drawer?.classList.remove("show"); }
  function open(){ overlay?.classList.add("show"); drawer?.classList.add("show"); }
  btn?.addEventListener("click", open);
  overlay?.addEventListener("click", close);
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") close(); });
  return {open,close};
}
function switchSection(id){
  document.querySelectorAll("[data-section]").forEach(el=>el.style.display="none");
  const target = document.querySelector(`[data-section="${id}"]`);
  if(target) target.style.display="block";
  document.querySelectorAll("[data-nav]").forEach(b=>{
    b.classList.toggle("active", b.getAttribute("data-nav")===id);
  });
  sessionStorage.setItem(`${APP_KEY}:lastSection`, id);
}
function restoreLastSection(defaultId){
  const id = sessionStorage.getItem(`${APP_KEY}:lastSection`) || defaultId;
  switchSection(id);
}

</script>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">
      <div class="logo"><img data-company-logo style="display:none"/></div>
      <div class="txt">
        <b data-company-name>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ù… ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</b>
        <span>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€¢ Admin</span>
      </div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="btnMenu">â˜°</button>
</div>
  </div>

  <div id="drawerOverlay" class="drawerOverlay"></div>
  <aside id="drawer" class="drawer" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
    <div class="brand" style="justify-content:space-between">
      <div class="txt">
        <b>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</b>
        <span>Admin</span>
      </div>
      <button class="btn ghost" id="btnCloseDrawer">âœ•</button>
    </div>
    <div class="nav">
      <button data-nav="company" class="active">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</button>
      <button data-nav="departments">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
      <button data-nav="employees">Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</button>
      <button data-nav="managers">Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡</button>
      <button data-nav="settings">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±</button>
      <button data-nav="attendance">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù…</button>
      <button data-nav="advances">Ø§Ù„Ø³Ù„Ù</button>
      <button data-nav="payroll">Ø§Ù„Ø±ÙˆØ§ØªØ¨</button>
      <button data-nav="report">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>
      <button data-nav="importexport">Excel / CSV</button>
    </div>
      <button id="btnLogout" class="danger">Ø®Ø±ÙˆØ¬</button>
    <div class="small">Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ (LocalStorage) â€” Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·.</div>
  </aside>

  <div style="height:14px"></div>

  <!-- COMPANY -->
  <section data-section="company" class="card">
    <div class="hd">
      <div>
        <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</h2>
        <p>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© + Ø´Ø¹Ø§Ø± ÙŠØ¸Ù‡Ø± ÙÙŠ ØµÙƒ Ø§Ù„Ù‚Ø¨Ø¶ ÙˆØ¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¸Ù.</p>
      </div>
      <span class="tag good">Ù…Ù‡Ù…</span>
    </div>
    <div class="bd">
      <div class="row cols2">
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label>
          <input id="companyName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©"/>
        </div>
        <div class="field">
          <label>Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© (ØµÙˆØ±Ø©)</label>
          <input id="companyLogo" type="file" accept="image/*"/>
          <div class="small">ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¯Ø§Ø®Ù„ LocalStorage (Base64).</div>
        </div>
      </div>
      <div class="row cols2" style="margin-top:10px">
        <div class="field">
          <label>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¹Ø§Ø±</label>
          <div class="card" style="padding:10px; border-radius:18px">
            <div class="logo" style="width:76px;height:76px"><img id="logoPreview" style="display:none"/></div>
          </div>
        </div>
        <div class="field" style="justify-content:flex-end">
          <label>&nbsp;</label>
          <button class="btn primary" id="saveCompany">Ø­ÙØ¸</button>
        </div>
      </div>
    </div>
  </section>

  <!-- DEPARTMENTS -->
  <section data-section="departments" class="card" style="display:none">
    <div class="hd">
      <div>
        <h2>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
        <p>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù.</p>
      </div>
    </div>
    <div class="bd">
      <div class="row cols2">
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</label>
          <input id="deptName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¨ÙŠØ¹Ø§Øª"/>
        </div>
        <div class="field" style="justify-content:flex-end">
          <label>&nbsp;</label>
          <button class="btn green" id="addDept">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="tableWrap">
        <table>
          <thead><tr><th>#</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
          <tbody id="deptTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- EMPLOYEES -->
  <section data-section="employees" class="card" style="display:none">
    <div class="hd">
      <div>
        <h2>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</h2>
        <p>Ø§Ù„Ø§Ø³Ù… ÙØ±ÙŠØ¯ + Ø§Ù„Ù‚Ø³Ù… + Ø§Ù„Ø±Ø§ØªØ¨ + Ø§Ù„Ø­Ø§Ù„Ø©.</p>
      </div>
    </div>
    <div class="bd">
      <div class="row cols5">
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù (ÙØ±ÙŠØ¯)</label>
          <input id="empNameNew" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù"/>
        </div>
        <div class="field">
          <label>Ø§Ù„Ù‚Ø³Ù…</label>
          <select id="empDept"></select>
        </div>
        <div class="field">
          <label>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</label>
          <input id="empSalary" type="number" min="0" step="0.01" placeholder="0"/>
        </div>
        <div class="field">
          <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="empActive">
            <option value="1" selected>Ù†Ø´Ø·</option>
            <option value="0">ØºÙŠØ± Ù†Ø´Ø·</option>
          </select>
        </div>
      </div>
      <div class="row cols2" style="margin-top:10px">
        <div class="field" style="grid-column:1/-1">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="empNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø¯Ø§Ø®Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
        </div>
      </div>
      <div class="row cols2">
        <button class="btn green" id="addEmp">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
        <button class="btn ghost" id="clearEmpForm">ØªÙØ±ÙŠØº</button>
      </div>

      <div style="height:10px"></div>
      <div class="tableWrap">
        <table>
          <thead><tr>
            <th>Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø±Ø§ØªØ¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr></thead>
          <tbody id="empTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- MANAGERS -->
  <section data-section="managers" class="card" style="display:none">
    <div class="hd">
      <div>
        <h2>Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡</h2>
        <p>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù (Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ù…Ø¯ÙŠØ± Ø§ÙØªØ±Ø§Ø¶ÙŠ).</p>
      </div>
    </div>
    <div class="bd">
      <div class="row cols3">
        <div class="field">
          <label>Username</label>
          <input id="mgrUsername" placeholder="manager2"/>
        </div>
        <div class="field">
          <label>Password</label>
          <input id="mgrPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
        </div>
        <div class="field" style="justify-content:flex-end">
          <label>&nbsp;</label>
          <button class="btn green" id="addMgr">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="tableWrap">
        <table>
          <thead><tr><th>Ù…</th><th>Username</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
          <tbody id="mgrTable"></tbody>
        </table>
      </div>
      <div class="small">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù…Ø¯ÙŠØ± <code class="inline">manager</code> Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±Ù‡).</div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section data-section="settings" class="card" style="display:none">
    <div class="hd">
      <div>
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±</h2>
        <p>Ù„ÙƒÙ„ Ø´Ù‡Ø± (YYYY-MM) â€” ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.</p>
      </div>
    </div>
    <div class="bd">
      <div class="row cols4">
        <div class="field">
          <label>Ø§Ù„Ø´Ù‡Ø± (YYYY-MM)</label>
          <input id="setMonth" placeholder="2026-02"/>
        </div>
        <div class="field">
          <label>Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø´Ù‡Ø±</label>
          <select id="daysInMonth">
            <option>28</option><option>29</option><option selected>30</option><option>31</option>
          </select>
        </div>
        <div class="field">
          <label>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø§Ù„Ø´Ù‡Ø±</label>
          <input id="workHoursInMonth" type="number" min="1" step="1"/>
        </div>
        <div class="field">
          <label>ÙˆÙ‚Øª Ø§Ù„Ø¯ÙˆØ§Ù…</label>
          <div class="row cols2">
            <input id="shiftStart" placeholder="09:00"/>
            <input id="shiftEnd" placeholder="17:00"/>
          </div>
        </div>
      </div>

      <div class="row cols4" style="margin-top:10px">
        <div class="field">
          <label>Ø³Ù…Ø§Ø­ Ø§Ù„ØªØ£Ø®ÙŠØ± (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
          <input id="lateGraceMinutes" type="number" min="0" step="1"/>
        </div>
        <div class="field">
          <label>Ø³Ù…Ø§Ø­ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ± (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
          <input id="earlyLeaveGraceMinutes" type="number" min="0" step="1"/>
        </div>
        <div class="field">
          <label>Ù…Ø¹Ø§Ù…Ù„ Ø®ØµÙ… Ø§Ù„ØªØ£Ø®ÙŠØ±</label>
          <input id="latePenaltyMultiplier" type="number" min="0" step="0.1"/>
        </div>
        <div class="field">
          <label>Ù…Ø¹Ø§Ù…Ù„ Ø®ØµÙ… Ø§Ù„Ù…Ø¨ÙƒØ±</label>
          <input id="earlyPenaltyMultiplier" type="number" min="0" step="0.1"/>
        </div>
      </div>

      <div class="row cols3" style="margin-top:10px">
        <div class="field">
          <label>Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</label>
          <input id="overtimeMultiplier" type="number" min="0" step="0.1"/>
        </div>
        <div class="field">
          <label>Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø± â­</label>
          <input id="absenceNoExcuseFactor" type="number" min="0" step="0.1" placeholder="1.0"/>
        </div>
        <div class="field" style="justify-content:flex-end">
          <label>&nbsp;</label>
          <button class="btn primary" id="saveSettings">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
      </div>

      <div class="small">â­ Ø¥Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù… ÙŠØ¯Ø§ÙˆÙ… ÙˆÙ„Ø§ ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø´Ù‡Ø± â†’ Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ = 0.</div>
    </div>
  </section>

  <!-- ATTENDANCE -->
  <section data-section="attendance" class="card" style="display:none">
    <div class="hd">
      <div>
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù…</h2>
        <p>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬ + Ø£Ø¹Ø°Ø§Ø± + Ù…Ø´ÙˆØ§Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ØµÙ†Ø¹.</p>
      </div>
    </div>
    <div class="bd">
      <div class="row cols4">
        <div class="field">
          <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
          <select id="attEmp"></select>
        </div>
        <div class="field">
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input id="attDate" type="date"/>
        </div>
        <div class="field">
          <label>Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
          <input id="attIn" placeholder="09:00"/>
        </div>
        <div class="field">
          <label>Ø§Ù„Ø®Ø±ÙˆØ¬</label>
          <input id="attOut" placeholder="17:00"/>
        </div>
      </div>

      <div class="row cols3" style="margin-top:10px">
        <div class="field">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø°Ø±</label>
          <select id="excuseType">
            <option value="none" selected>Ø¨Ø¯ÙˆÙ†</option>
            <option value="late_excused">ØªØ£Ø®ÙŠØ± Ø¨Ø¹Ø°Ø±</option>
            <option value="early_excused">Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ± Ø¨Ø¹Ø°Ø±</option>
            <option value="absent_excused">ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±</option>
          </select>
        </div>
        <div class="field">
          <label>Ù…Ø´ÙˆØ§Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ØµÙ†Ø¹</label>
          <select id="outOfFactory">
            <option value="0" selected>Ù„Ø§</option>
            <option value="1">Ù†Ø¹Ù…</option>
          </select>
        </div>
        <div class="field">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ø¯Ø§Ø®Ù„ÙŠØ©</label>
          <input id="attNote" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"/>
        </div>
      </div>

      <div class="row cols2" style="margin-top:10px">
        <button class="btn green" id="saveAttendance">Ø­ÙØ¸</button>
        <button class="btn red" id="deleteAttendance">Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„</button>
      </div>

      <hr class="sep"/>
      <div class="row cols3">
        <div class="field">
          <label>Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø´Ù‡Ø±</label>
          <input id="attMonthFilter" placeholder="YYYY-MM"/>
        </div>
        <div class="field" style="justify-content:flex-end">
          <label>&nbsp;</label>
          <button class="btn ghost" id="refreshAttTable">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
        </div>
        <div class="field" style="justify-content:flex-end">
          <label>&nbsp;</label>
          <button class="btn primary" id="exportAttCsv">ØªØµØ¯ÙŠØ± CSV Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="tableWrap">
        <table>
          <thead><tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø¯Ø®ÙˆÙ„</th><th>Ø§Ù„Ø®Ø±ÙˆØ¬</th><th>Ø¥Ø¶Ø§ÙÙŠ</th><th>ØªØ£Ø®ÙŠØ±</th><th>Ù…Ø¨ÙƒØ±</th><th>Ø³Ù„Ù</th><th>Ø§Ù„Ø¹Ø°Ø±</th><th>Ø®Ø§Ø±Ø¬</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
          </tr></thead>
          <tbody id="attTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ADVANCES -->
  <section data-section="advances" class="card" style="display:none">
    <div class="hd">
      <div>
        <h2>Ø§Ù„Ø³Ù„Ù</h2>
        <p>ØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.</p>
      </div>
    </div>
    <div class="bd">
      <div class="row cols4">
        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ù„ÙØ©</label>
          <input id="advDate" type="date"/>
        </div>
        <div class="field">
          <label>Ø§Ù„Ø´Ù‡Ø±</label>
          <input id="advMonth" placeholder="YYYY-MM" inputmode="numeric"/>
        </div>
        <div class="field">
          <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
          <select id="advEmp"></select>
        </div>
        <div class="field">
          <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
          <input id="advAmount" type="number" min="0" step="0.01" placeholder="0"/>
        </div>
        <div class="field">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
          <input id="advNote" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"/>
        </div>
      </div>
      <div class="row cols2" style="margin-top:10px">
        <button class="btn green" id="saveAdvance">Ø­ÙØ¸</button>
        <button class="btn red" id="deleteAdvance">Ø­Ø°Ù</button>
      </div>

      <div class="row cols3" style="margin-top:10px">
        <div class="field">
          <label>ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù</label>
          <select id="advFilter"></select>
        </div>
        <div class="field">
          <label>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</label>
          <input id="advSearch" placeholder="Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù…"/>
        </div>
        <div class="field" style="justify-content:flex-end">
          <label>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ù„Ù (Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©)</label>
          <div class="pill"><b id="advTotal">0</b></div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="tableWrap">
        <table>
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead>
          <tbody id="advTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PAYROLL -->
  <section data-section="payroll" class="card" style="display:none">
    <div class="hd">
      <div>
        <h2>Ø§Ù„Ø±ÙˆØ§ØªØ¨</h2>
        <p>Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø± ÙˆØ³Ø¬Ù„Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ù… ÙˆØ§Ù„Ø³Ù„Ù.</p>
      </div>
      <span class="tag warn">ØµÙƒ Ù‚Ø¨Ø¶ PDF</span>
    </div>
    <div class="bd">
      <div class="row cols3">
        <div class="field">
          <label>Ø§Ù„Ø´Ù‡Ø± (YYYY-MM)</label>
          <input id="payMonth" placeholder="YYYY-MM"/>
        </div>
        <div class="field" style="justify-content:flex-end">
          <label>&nbsp;</label>
          <button class="btn primary" id="calcPayroll">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆØ§ØªØ¨</button>
        </div>
        <div class="field" style="justify-content:flex-end">
          <label>&nbsp;</label>
          <button class="btn ghost" id="exportPayrollCsv">ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø±ÙˆØ§ØªØ¨ CSV</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="tableWrap">
        <table>
          <thead><tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th><th>Ø¥Ø¶Ø§ÙÙŠ</th><th>ØªØ£Ø®ÙŠØ±</th><th>Ù…Ø¨ÙƒØ±</th><th>ØºÙŠØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±</th><th>Ø§Ù„Ø³Ù„Ù</th><th>Ø§Ù„Ù…Ø³ØªØ­Ù‚</th><th>PDF</th>
          </tr></thead>
          <tbody id="payTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- REPORT -->
  <section data-section="report" class="card" style="display:none">
    <div class="hd">
      <div>
        <h2>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</h2>
        <p>Ø¬Ø¯ÙˆÙ„ Ø´Ø§Ù…Ù„ + Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ø¬Ù…ÙŠØ¹.</p>
      </div>
    </div>
    <div class="bd">
      <div class="row cols3">
        <div class="field">
          <label>Ø§Ù„Ø´Ù‡Ø± (YYYY-MM)</label>
          <input id="repMonth" placeholder="YYYY-MM"/>
        </div>
        <div class="field" style="justify-content:flex-end">
          <label>&nbsp;</label>
          <button class="btn primary" id="buildReport">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
        <div class="field">
          <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª</label>
          <input id="repTotal" readonly/>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="tableWrap">
        <table>
          <thead><tr>
            <th>Ù…</th><th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th><th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
            <th>ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±</th><th>Ù‚ÙŠÙ…Ø©</th>
            <th>ØºÙŠØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±</th><th>Ù‚ÙŠÙ…Ø©</th>
            <th>Ø¥Ø¶Ø§ÙÙŠ</th><th>Ù‚ÙŠÙ…Ø©</th>
            <th>ØªØ£Ø®ÙŠØ±</th><th>Ù‚ÙŠÙ…Ø©</th>
            <th>Ù…Ø¨ÙƒØ±</th><th>Ù‚ÙŠÙ…Ø©</th>
            <th>Ø³Ù„Ù</th><th>Ø§Ù„Ù…Ø³ØªØ­Ù‚</th>
          </tr></thead>
          <tbody id="repTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- IMPORT/EXPORT -->
  <section data-section="importexport" class="card" style="display:none">
    <div class="hd">
      <div>
        <h2>Import / Export</h2>
        <p>JSON Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© + CSV Ù…ÙˆØ¸ÙÙŠÙ†/Ø¯ÙˆØ§Ù….</p>
      </div>
    </div>
    <div class="bd">
      <div class="row cols2">
        <div class="card" style="padding:14px; border-radius:18px">
          <b>Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø© (JSON)</b>
          <div style="height:10px"></div>
          <div class="row cols2">
            <button class="btn primary" id="exportJson">ØªØµØ¯ÙŠØ± JSON</button>
            <label class="btn green" style="cursor:pointer">
              Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON
              <input id="importJson" type="file" accept="application/json" style="display:none"/>
            </label>
          </div>
        </div>

        <div class="card" style="padding:14px; border-radius:18px">
          <b>CSV (ÙŠÙØªØ­ ÙÙŠ Excel)</b>
          <div style="height:10px"></div>
          <div class="row cols2">
            <button class="btn ghost" id="exportEmployeesCsv">ØªØµØ¯ÙŠØ± Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
            <label class="btn green" style="cursor:pointer">
              Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV Ù…ÙˆØ¸ÙÙŠÙ†
              <input id="importEmployeesCsv" type="file" accept=".csv,text/csv" style="display:none"/>
            </label>
          </div>
          <div style="height:10px"></div>
          <div class="row cols2">
            <button class="btn ghost" id="exportMonthAttendanceCsv">ØªØµØ¯ÙŠØ± Ø¯ÙˆØ§Ù… Ø´Ù‡Ø±</button>
            <label class="btn green" style="cursor:pointer">
              Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV Ø¯ÙˆØ§Ù…
              <input id="importAttendanceCsv" type="file" accept=".csv,text/csv" style="display:none"/>
            </label>
          </div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="small">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙŠØ¹Ù…Ù„ Upsert Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù… (ÙŠØ¹Ø¯Ù‘Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙŠØ¶ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯).</div>
    </div>
  </section>

</div>

<script>
const s = requireRole(["admin"]);
if(!s){ location.href="index.html"; }

ensureApp();
setBrandFromCompany();

// drawer
const dr = drawerInit();
document.getElementById("btnCloseDrawer").addEventListener("click", ()=>{ 
  document.getElementById("drawerOverlay").classList.remove("show");
  document.getElementById("drawer").classList.remove("show");
});
document.querySelectorAll("[data-nav]").forEach(b=>{
  b.addEventListener("click", ()=>{
    switchSection(b.getAttribute("data-nav"));
    document.getElementById("drawerOverlay").classList.remove("show");
    document.getElementById("drawer").classList.remove("show");
  });
});
restoreLastSection("company");

document.getElementById("btnLogout").addEventListener("click", ()=>{
  sessionClear(); location.href="index.html";
});

/* ===== Company ===== */
function renderCompany(){
  const app = ensureApp();
  document.getElementById("companyName").value = app.company.companyName || "";
  const img = document.getElementById("logoPreview");
  if(app.company.companyLogo){
    img.src = app.company.companyLogo; img.style.display="block";
  }else{
    img.removeAttribute("src"); img.style.display="none";
  }
}
renderCompany();

document.getElementById("saveCompany").addEventListener("click", async ()=>{
  const name = document.getElementById("companyName").value.trim();
  const file = document.getElementById("companyLogo").files[0];
  if(file){
    const data = await (new Promise((res,rej)=>{
      const fr=new FileReader();
      fr.onload=()=>res(String(fr.result||""));
      fr.onerror=()=>rej(fr.error||new Error("FileReader error"));
      fr.readAsDataURL(file);
    }));
    updateApp(app=>{
      app.company.companyName = name;
      app.company.companyLogo = data;
    });
  }else{
    updateApp(app=>{
      app.company.companyName = name;
    });
  }
  setBrandFromCompany();
  renderCompany();
  toast("ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©.");
});

/* ===== Departments ===== */
function renderDepartments(){
  const app = ensureApp();
  const tb = document.getElementById("deptTable");
  tb.innerHTML = "";
  app.departments.forEach((d,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td>
      <td>${d.name}</td>
      <td>
        <button class="btn ghost" data-edit="${d.id}">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn red" data-del="${d.id}">Ø­Ø°Ù</button>
      </td>`;
    tb.appendChild(tr);
  });

  // selects
  const deptSel = document.getElementById("empDept");
  deptSel.innerHTML = `<option value="">â€”</option>` + app.departments.map(d=>`<option value="${d.id}">${d.name}</option>`).join("");
  document.getElementById("attEmp").innerHTML = app.employees.filter(e=>e.active!==false).map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
  document.getElementById("advEmp").innerHTML = app.employees.filter(e=>e.active!==false).map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
}
renderDepartments();

document.getElementById("addDept").addEventListener("click", ()=>{
  const name = document.getElementById("deptName").value.trim();
  if(!name){ toast("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù….", "warn"); return; }
  updateApp(app=>{
    if(app.departments.some(d=>d.name===name)) return;
    app.departments.push({id:uid("dep"), name});
  });
  document.getElementById("deptName").value="";
  renderDepartments(); renderEmployees();
  toast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù….");
});

document.getElementById("deptTable").addEventListener("click", (e)=>{
  const id = e.target.getAttribute("data-del") || e.target.getAttribute("data-edit");
  if(!id) return;
  if(e.target.hasAttribute("data-del")){
    if(!confirm("Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…ØŸ")) return;
    updateApp(app=>{
      app.departments = app.departments.filter(d=>d.id!==id);
      // detach department from employees
      app.employees.forEach(emp=>{ if(emp.departmentId===id) emp.departmentId=""; });
    });
    renderDepartments(); renderEmployees();
    toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù….", "warn");
  }else{
    const app = ensureApp();
    const d = app.departments.find(x=>x.id===id);
    const name = prompt("Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…:", d?.name || "");
    if(name==null) return;
    updateApp(app=>{
      const dd = app.departments.find(x=>x.id===id);
      if(dd) dd.name = name.trim();
    });
    renderDepartments(); renderEmployees();
    toast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.");
  }
});

/* ===== Employees ===== */
let editingEmpId = null;

function renderEmployees(){
  const app = ensureApp();
  const tb = document.getElementById("empTable");
  tb.innerHTML="";
  const deptById = Object.fromEntries(app.departments.map(d=>[d.id,d.name]));
  app.employees.forEach((emp,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td>
      <td>${emp.name}</td>
      <td>${deptById[emp.departmentId] || "â€”"}</td>
      <td>${fmtMoney(emp.monthlySalary||0)}</td>
      <td>${emp.active===false ? `<span class="tag bad">ØºÙŠØ± Ù†Ø´Ø·</span>` : `<span class="tag good">Ù†Ø´Ø·</span>`}</td>
      <td>${(emp.notes||"")}</td>
      <td>
        <button class="btn ghost" data-edit="${emp.id}">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn red" data-del="${emp.id}">Ø­Ø°Ù</button>
      </td>`;
    tb.appendChild(tr);
  });
  // refresh employee selects (attendance/advances)
  document.getElementById("attEmp").innerHTML = app.employees.filter(e=>e.active!==false).map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
  document.getElementById("advEmp").innerHTML = app.employees.filter(e=>e.active!==false).map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
}
renderEmployees();

function clearEmpForm(){
  editingEmpId=null;
  document.getElementById("empNameNew").value="";
  document.getElementById("empDept").value="";
  document.getElementById("empSalary").value="";
  document.getElementById("empActive").value="1";
  document.getElementById("empNote").value="";
}
document.getElementById("clearEmpForm").addEventListener("click", clearEmpForm);

document.getElementById("addEmp").addEventListener("click", ()=>{
  const name = document.getElementById("empNameNew").value.trim();
  const departmentId = document.getElementById("empDept").value;
  const monthlySalary = Number(document.getElementById("empSalary").value||0);
  const active = document.getElementById("empActive").value==="1";
  const notes = document.getElementById("empNote").value.trim();
  if(!name){ toast("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù.", "warn"); return; }

  updateApp(app=>{
    // unique by name
    const existing = app.employees.find(e=>e.name===name);
    if(editingEmpId){
      const emp = app.employees.find(e=>e.id===editingEmpId);
      if(!emp) return;
      // if changing name ensure unique
      if(existing && existing.id!==editingEmpId) { throw new Error("Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„."); }
      emp.name=name; emp.departmentId=departmentId; emp.monthlySalary=monthlySalary; emp.active=active; emp.notes=notes;
    }else{
      if(existing) { throw new Error("Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„."); }
      app.employees.push({ id:uid("emp"), name, departmentId, monthlySalary, active, notes });
    }
  });
  clearEmpForm();
  renderEmployees();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù.");
});

document.getElementById("empTable").addEventListener("click", (e)=>{
  const id = e.target.getAttribute("data-edit") || e.target.getAttribute("data-del");
  if(!id) return;
  if(e.target.hasAttribute("data-del")){
    if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙØŸ Ø³ÙŠØ¸Ù„ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙˆØ§Ù… Ù…Ø­ÙÙˆØ¸Ù‹Ø§ Ù„ÙƒÙ†Ù‡ Ù„Ù† ÙŠØ¸Ù‡Ø± Ø¨Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª.")) return;
    updateApp(app=>{
      app.employees = app.employees.filter(x=>x.id!==id);
      // also remove advances entries for that employee
      for(const ym of Object.keys(app.advances||{})){
        if(app.advances[ym]) delete app.advances[ym][id];
      }
      // remove attendance entries
      for(const dateKey of Object.keys(app.attendance||{})){
        if(app.attendance[dateKey]) delete app.attendance[dateKey][id];
      }
    });
    renderEmployees(); renderDepartments();
    toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù.", "warn");
  }else{
    const app=ensureApp();
    const emp = app.employees.find(x=>x.id===id);
    if(!emp) return;
    editingEmpId = id;
    document.getElementById("empNameNew").value = emp.name;
    document.getElementById("empDept").value = emp.departmentId || "";
    document.getElementById("empSalary").value = emp.monthlySalary ?? 0;
    document.getElementById("empActive").value = emp.active===false ? "0" : "1";
    document.getElementById("empNote").value = emp.notes || "";
    toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù„ØªØ¹Ø¯ÙŠÙ„.");
  }
});

/* ===== Managers ===== */
function renderManagers(){
  const app = ensureApp();
  const tb = document.getElementById("mgrTable");
  tb.innerHTML="";
  app.managers.forEach((m,i)=>{
    const cannotDelete = m.username==="manager";
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td>
      <td>${m.username}</td>
      <td>
        <button class="btn ghost" data-edit="${m.id}">ØªØ¹Ø¯ÙŠÙ„</button>
        ${cannotDelete ? `<span class="tag warn">Ø§ÙØªØ±Ø§Ø¶ÙŠ</span>` : `<button class="btn red" data-del="${m.id}">Ø­Ø°Ù</button>`}
      </td>`;
    tb.appendChild(tr);
  });
}
renderManagers();

document.getElementById("addMgr").addEventListener("click", ()=>{
  const u = document.getElementById("mgrUsername").value.trim();
  const p = document.getElementById("mgrPassword").value;
  if(!u || !p){ toast("Ø§ÙƒØªØ¨ username Ùˆ password.", "warn"); return; }
  if(u==="admin"){ toast("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… username=admin.", "bad"); return; }
  updateApp(app=>{
    if(app.managers.some(m=>m.username===u)) throw new Error("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯.");
    app.managers.push({id:uid("mgr"), username:u, password:p});
  });
  document.getElementById("mgrUsername").value="";
  document.getElementById("mgrPassword").value="";
  renderManagers();
  toast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯ÙŠØ±.");
});

document.getElementById("mgrTable").addEventListener("click", (e)=>{
  const editId = e.target.getAttribute("data-edit");
  const delId = e.target.getAttribute("data-del");
  if(editId){
    const app=ensureApp();
    const m=app.managers.find(x=>x.id===editId);
    const newPass = prompt(`ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù€ ${m.username}:`, m.password);
    if(newPass==null) return;
    updateApp(app=>{
      const mm=app.managers.find(x=>x.id===editId);
      if(mm) mm.password = newPass;
    });
    renderManagers();
    toast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
  }
  if(delId){
    if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø¯ÙŠØ±ØŸ")) return;
    updateApp(app=>{
      app.managers = app.managers.filter(x=>x.id!==delId);
    });
    renderManagers();
    toast("ØªÙ… Ø§Ù„Ø­Ø°Ù.", "warn");
  }
});

/* ===== Month Settings ===== */
function loadSettingsForm(){
  const app=ensureApp();
  const ym = yyyymm();
  document.getElementById("setMonth").value = ym;
  const s = app.monthSettings[ym] || {};
  document.getElementById("daysInMonth").value = String(s.daysInMonth||30);
  document.getElementById("workHoursInMonth").value = s.workHoursInMonth ?? 176;
  document.getElementById("shiftStart").value = s.shiftStart || "09:00";
  document.getElementById("shiftEnd").value = s.shiftEnd || "17:00";
  document.getElementById("lateGraceMinutes").value = s.lateGraceMinutes ?? 10;
  document.getElementById("earlyLeaveGraceMinutes").value = s.earlyLeaveGraceMinutes ?? 10;
  document.getElementById("latePenaltyMultiplier").value = s.latePenaltyMultiplier ?? 1.5;
  document.getElementById("earlyPenaltyMultiplier").value = s.earlyPenaltyMultiplier ?? 1.5;
  document.getElementById("overtimeMultiplier").value = s.overtimeMultiplier ?? 1.5;
  document.getElementById("absenceNoExcuseFactor").value = s.absenceNoExcuseFactor ?? 1.0;
}
loadSettingsForm();

document.getElementById("saveSettings").addEventListener("click", ()=>{
  const ym = document.getElementById("setMonth").value.trim();
  if(!/^\d{4}-\d{2}$/.test(ym)){ toast("Ø§ÙƒØªØ¨ Ø§Ù„Ø´Ù‡Ø± Ø¨ØµÙŠØºØ© YYYY-MM.", "warn"); return; }
  const obj = {
    daysInMonth: Number(document.getElementById("daysInMonth").value),
    workHoursInMonth: Number(document.getElementById("workHoursInMonth").value||176),
    shiftStart: document.getElementById("shiftStart").value.trim(),
    shiftEnd: document.getElementById("shiftEnd").value.trim(),
    lateGraceMinutes: Number(document.getElementById("lateGraceMinutes").value||0),
    earlyLeaveGraceMinutes: Number(document.getElementById("earlyLeaveGraceMinutes").value||0),
    latePenaltyMultiplier: Number(document.getElementById("latePenaltyMultiplier").value||1.5),
    earlyPenaltyMultiplier: Number(document.getElementById("earlyPenaltyMultiplier").value||1.5),
    overtimeMultiplier: Number(document.getElementById("overtimeMultiplier").value||1.5),
    absenceNoExcuseFactor: Number(document.getElementById("absenceNoExcuseFactor").value||1.0)
  };
  // validate times
  if(parseTimeToMinutes(obj.shiftStart)==null || parseTimeToMinutes(obj.shiftEnd)==null){
    toast("ÙˆÙ‚Øª Ø§Ù„Ø¯ÙˆØ§Ù… ØºÙŠØ± ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„ 09:00).", "bad"); return;
  }
  updateApp(app=>{
    app.monthSettings[ym] = obj;
  });
  toast("ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±.");
});

/* ===== Attendance ===== */
document.getElementById("attDate").value = nowISODate();
document.getElementById("attMonthFilter").value = yyyymm();

function getEmpNameById(id){
  const app=ensureApp();
  const e=(app.employees||[]).find(x=>x.id===id);
  return e?e.name:"â€”";
}

function arDayName(dateStr){
  try{
    const d = new Date(dateStr+"T00:00:00");
    const names = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
    return names[d.getDay()] || "";
  }catch(e){ return ""; }
}
function sumAdvancesForMonth(app, ym, empId){
  return (app.advancesList||[]).filter(a=>a.ym===ym && a.employeeId===empId).reduce((s,a)=>s+Number(a.amount||0),0);
}
function sumAdvancesOnDate(app, dateStr, empId){
  return (app.advancesList||[]).filter(a=>a.date===dateStr && a.employeeId===empId).reduce((s,a)=>s+Number(a.amount||0),0);
}


function loadAttendanceForm(){
  const empId = document.getElementById("attEmp").value;
  const date = document.getElementById("attDate").value;
  if(!empId || !date) return;
  const app=ensureApp();
  const rec = (app.attendance?.[date]||{})[empId] || null;
  document.getElementById("attIn").value = rec?.checkIn || "";
  document.getElementById("attOut").value = rec?.checkOut || "";
  document.getElementById("excuseType").value = rec?.excuseType || "none";
  document.getElementById("outOfFactory").value = rec?.outOfFactory ? "1" : "0";
  document.getElementById("attNote").value = rec?.note || "";
}
document.getElementById("attEmp").addEventListener("change", loadAttendanceForm);
document.getElementById("attDate").addEventListener("change", loadAttendanceForm);

document.getElementById("saveAttendance").addEventListener("click", ()=>{
  const empId = document.getElementById("attEmp").value;
  const date = document.getElementById("attDate").value;
  const checkIn = document.getElementById("attIn").value.trim();
  const checkOut = document.getElementById("attOut").value.trim();
  const excuseType = document.getElementById("excuseType").value;
  const outOfFactory = document.getElementById("outOfFactory").value==="1";
  const note = document.getElementById("attNote").value.trim();

  if(!empId){ toast("Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù.", "warn"); return; }
  if(!date){ toast("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®.", "warn"); return; }

  if(checkIn && parseTimeToMinutes(checkIn)==null){ toast("ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­.", "bad"); return; }
  if(checkOut && parseTimeToMinutes(checkOut)==null){ toast("ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ ØºÙŠØ± ØµØ­ÙŠØ­.", "bad"); return; }

  updateApp(app=>{
    app.attendance[date] = app.attendance[date] || {};
    app.attendance[date][empId] = {
      date, employeeId: empId,
      checkIn: checkIn || "",
      checkOut: checkOut || "",
      excuseType,
      outOfFactory,
      note
    };
  });
  toast("ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙˆØ§Ù….");
  buildAttendanceTable();
});

document.getElementById("deleteAttendance").addEventListener("click", ()=>{
  const empId = document.getElementById("attEmp").value;
  const date = document.getElementById("attDate").value;
  if(!empId || !date) return;
  if(!confirm("Ø­Ø°Ù Ø³Ø¬Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŸ")) return;
  updateApp(app=>{
    if(app.attendance?.[date]) delete app.attendance[date][empId];
  });
  toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„.", "warn");
  loadAttendanceForm();
  buildAttendanceTable();
});

function buildAttendanceTable(){
  const ym = document.getElementById("attMonthFilter").value.trim();
  const app=ensureApp();
  const tb=document.getElementById("attTable");
  tb.innerHTML="";
  const exMap = {none:"Ø¨Ø¯ÙˆÙ†", late_excused:"ØªØ£Ø®ÙŠØ± Ø¨Ø¹Ø°Ø±", early_excused:"Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ± Ø¨Ø¹Ø°Ø±", absent_excused:"ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±"};
  const rows=[];
  for(const dateKey of Object.keys(app.attendance||{})){
    if(ym && !dateKey.startsWith(ym+"-")) continue;
    const day = app.attendance[dateKey] || {};
    for(const empId of Object.keys(day)){
      const rec = day[empId];
      rows.push({date:dateKey, empId, ...rec});
    }
  }
  rows.sort((a,b)=>a.date.localeCompare(b.date));
  for(const r of rows){
    const tr=document.createElement("tr");
    {
    const settings = app.monthSettings[(r.date||"").slice(0,7)] || app.monthSettings[yyyymm()] || {};
    const m = computeDayMetrics(settings, r);
    const otH = (m.overtimeMinutes/60);
    const lateH = (m.lateMinutes/60);
    const earlyH = (m.earlyLeaveMinutes/60);
    const advDay = sumAdvancesOnDate(app, r.date, r.empId);
    tr.innerHTML = `<td>${r.date}</td>
      <td>${arDayName(r.date)}</td>
      <td>${getEmpNameById(r.empId)}</td>
      <td>${r.checkIn||"â€”"}</td>
      <td>${r.checkOut||"â€”"}</td>
      <td>${(otH||0).toFixed(2)}</td>
      <td>${(lateH||0).toFixed(2)}</td>
      <td>${(earlyH||0).toFixed(2)}</td>
      <td>${fmtMoney(advDay||0)}</td>
      <td>${exMap[r.excuseType]||"Ø¨Ø¯ÙˆÙ†"}</td>
      <td>${r.outOfFactory?"Ù†Ø¹Ù…":"Ù„Ø§"}</td>
      <td>${(r.note||"")}</td>`;
  }
    tb.appendChild(tr);
  }
}
function exportAttendanceCSV(ym){
  const app=ensureApp();
  const rows = [["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„ÙŠÙˆÙ…","Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù","Ø§Ù„Ø¯Ø®ÙˆÙ„","Ø§Ù„Ø®Ø±ÙˆØ¬","Ø¥Ø¶Ø§ÙÙŠ","ØªØ£Ø®ÙŠØ±","Ù…Ø¨ÙƒØ±","Ø³Ù„Ù","Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø°Ø±","Ù…Ø´ÙˆØ§Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ØµÙ†Ø¹","Ù…Ù„Ø§Ø­Ø¸Ø©"]];
  const exMap = {none:"none", late_excused:"late_excused", early_excused:"early_excused", absent_excused:"absent_excused"};
  for(const dateKey of Object.keys(app.attendance||{})){
    if(!dateKey.startsWith(ym+"-")) continue;
    const day = app.attendance[dateKey] || {};
    for(const empId of Object.keys(day)){
      const rec=day[empId];
      {
      const settings = app.monthSettings[dateKey.slice(0,7)] || app.monthSettings[yyyymm()] || {};
      const m = computeDayMetrics(settings, rec);
      const advDay = sumAdvancesOnDate(app, dateKey, empId);
      rows.push([
        dateKey,
        arDayName(dateKey),
        getEmpNameById(empId),
        rec.checkIn||"",
        rec.checkOut||"",
        (m.overtimeMinutes/60).toFixed(2),
        (m.lateMinutes/60).toFixed(2),
        (m.earlyLeaveMinutes/60).toFixed(2),
        advDay||0,
        rec.excuseType||"none",
        rec.outOfFactory ? "1":"0",
        rec.note||""
      ]);
    }
    }
  }
  downloadText(`attendance_${ym}.csv`, csvStringify(rows), "text/csv;charset=utf-8");
}
document.getElementById("refreshAttTable").addEventListener("click", buildAttendanceTable);
document.getElementById("exportAttCsv").addEventListener("click", ()=>{
  const ym=document.getElementById("attMonthFilter").value.trim();
  if(!/^\d{4}-\d{2}$/.test(ym)){ toast("Ø§ÙƒØªØ¨ Ø§Ù„Ø´Ù‡Ø± Ø¨ØµÙŠØºØ© YYYY-MM.", "warn"); return; }
  exportAttendanceCSV(ym);
});
buildAttendanceTable();

/* ===== Advances ===== */
document.getElementById("advMonth").value = yyyymm();
function loadAdvance(){
  const ym = document.getElementById("advMonth").value.trim();
  const empId = document.getElementById("advEmp").value;
  if(!/^\d{4}-\d{2}$/.test(ym) || !empId) return;
  const app=ensureApp();
  const adv = (app.advances?.[ym]||{})[empId] || {};
  document.getElementById("advAmount").value = adv.amount ?? "";
  document.getElementById("advNote").value = adv.note ?? "";
}
document.getElementById("advMonth").addEventListener("change", loadAdvance);
document.getElementById("advEmp").addEventListener("change", loadAdvance);

document.getElementById("saveAdvance").addEventListener("click", ()=>{
  const ym = document.getElementById("advMonth").value.trim();
  const empId = document.getElementById("advEmp").value;
  const amount = Number(document.getElementById("advAmount").value||0);
  const note = document.getElementById("advNote").value.trim();
  if(!/^\d{4}-\d{2}$/.test(ym)){ toast("Ø§ÙƒØªØ¨ Ø§Ù„Ø´Ù‡Ø± Ø¨ØµÙŠØºØ© YYYY-MM.", "warn"); return; }
  if(!empId){ toast("Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù.", "warn"); return; }
  updateApp(app=>{
    app.advances[ym] = app.advances[ym] || {};
    app.advances[ym][empId] = { amount, note };
  });
  renderAdvTable();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ù„ÙØ©.");
});
document.getElementById("deleteAdvance").addEventListener("click", ()=>{
  const ym = document.getElementById("advMonth").value.trim();
  const empId = document.getElementById("advEmp").value;
  if(!/^\d{4}-\d{2}$/.test(ym) || !empId) return;
  if(!confirm("Ø­Ø°Ù Ø§Ù„Ø³Ù„ÙØ©ØŸ")) return;
  updateApp(app=>{
    if(app.advances?.[ym]) delete app.advances[ym][empId];
  });
  renderAdvTable();
  loadAdvance();
  toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ù„ÙØ©.", "warn");
});
function renderAdvTable(){
  const app=ensureApp();
  const tb=document.getElementById("advTable");
  tb.innerHTML="";
  const rows=[];
  for(const ym of Object.keys(app.advances||{})){
    const m = app.advances[ym]||{};
    for(const empId of Object.keys(m)){
      rows.push({ym, empId, ...m[empId]});
    }
  }
  rows.sort((a,b)=>(a.ym+b.empId).localeCompare(b.ym+b.empId));
  for(const r of rows){
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${r.ym}</td><td>${getEmpNameById(r.empId)}</td><td>${fmtMoney(r.amount||0)}</td><td>${r.note||""}</td>`;
    tb.appendChild(tr);
  }
}
renderAdvTable();
loadAdvance();

/* ===== Payroll ===== */
document.getElementById("payMonth").value = yyyymm();
function buildPayrollTable(){
  const ym = document.getElementById("payMonth").value.trim();
  if(!/^\d{4}-\d{2}$/.test(ym)){ toast("Ø§ÙƒØªØ¨ Ø§Ù„Ø´Ù‡Ø± Ø¨ØµÙŠØºØ© YYYY-MM.", "warn"); return; }
  const app=ensureApp();
  const deptById = Object.fromEntries(app.departments.map(d=>[d.id,d.name]));
  const tb=document.getElementById("payTable");
  tb.innerHTML="";
  const rows=[];
  for(const emp of app.employees){
    const p = computePayrollForEmployee(app, emp, ym);
    rows.push({emp, p});
  }
  for(const r of rows){
    const t=r.p.totals;
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${r.emp.name}</td>
      <td>${deptById[r.emp.departmentId] || "â€”"}</td>
      <td>${fmtMoney(t.baseSalary)}</td>
      <td>${fmtMoney(t.overtimeValue)}</td>
      <td>${fmtMoney(t.lateDeduction)}</td>
      <td>${fmtMoney(t.earlyDeduction)}</td>
      <td>${fmtMoney(t.absenceNoExcuseDeduction)}</td>
      <td>${fmtMoney(t.advances)}</td>
      <td><b>${fmtMoney(t.net)}</b></td>
      <td><button class="btn ghost" data-pdf="${r.emp.id}">Ø·Ø¨Ø§Ø¹Ø©</button></td>
    `;
    tb.appendChild(tr);
  }
}
document.getElementById("calcPayroll").addEventListener("click", buildPayrollTable);
document.getElementById("payTable").addEventListener("click", (e)=>{
  const id = e.target.getAttribute("data-pdf");
  if(!id) return;
  const ym = document.getElementById("payMonth").value.trim();
  const app=ensureApp();
  const emp = app.employees.find(x=>x.id===id);
  if(!emp) return;
  openReceiptPrintWindow(app, emp, ym);
});

document.getElementById("exportPayrollCsv").addEventListener("click", ()=>{
  const ym=document.getElementById("payMonth").value.trim();
  if(!/^\d{4}-\d{2}$/.test(ym)){ toast("Ø§ÙƒØªØ¨ Ø§Ù„Ø´Ù‡Ø± Ø¨ØµÙŠØºØ© YYYY-MM.", "warn"); return; }
  const app=ensureApp();
  const deptById = Object.fromEntries(app.departments.map(d=>[d.id,d.name]));
  const rows=[["Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ù‚Ø³Ù…","Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ","Ø®ØµÙ… Ø§Ù„ØªØ£Ø®ÙŠØ±","Ø®ØµÙ… Ø§Ù„Ù…Ø¨ÙƒØ±","Ø®ØµÙ… Ø§Ù„ØºÙŠØ§Ø¨","Ø§Ù„Ø³Ù„Ù","Ø§Ù„Ù…Ø³ØªØ­Ù‚"]];
  for(const emp of app.employees){
    const p=computePayrollForEmployee(app, emp, ym).totals;
    rows.push([emp.name, deptById[emp.departmentId]||"", p.baseSalary, p.overtimeValue, p.lateDeduction, p.earlyDeduction, p.absenceNoExcuseDeduction, p.advances, p.net]);
  }
  downloadText(`payroll_${ym}.csv`, csvStringify(rows), "text/csv;charset=utf-8");
});

buildPayrollTable();

/* ===== Report ===== */
document.getElementById("repMonth").value = yyyymm();
document.getElementById("buildReport").addEventListener("click", ()=>{
  const ym=document.getElementById("repMonth").value.trim();
  if(!/^\d{4}-\d{2}$/.test(ym)){ toast("Ø§ÙƒØªØ¨ Ø§Ù„Ø´Ù‡Ø± Ø¨ØµÙŠØºØ© YYYY-MM.", "warn"); return; }
  const app=ensureApp();
  const tb=document.getElementById("repTable");
  tb.innerHTML="";
  const settings = app.monthSettings[ym] || {};
  const workHours=Number(settings.workHoursInMonth||176);
  let totalNet=0;
  const deptById = Object.fromEntries(app.departments.map(d=>[d.id,d.name]));
  app.employees.forEach((emp,idx)=>{
    const pr=computePayrollForEmployee(app, emp, ym);
    const t=pr.totals;
    totalNet += Number(t.net||0);
    const hourValue = t.baseSalary / (workHours||1);
    const workHoursDisplay = (workHours||0).toFixed(0);
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${emp.name}</td>
      <td>${workHoursDisplay}</td>
      <td>${fmtMoney(hourValue)}</td>
      <td>${t.absentExcusedDays}</td>
      <td>${fmtMoney(0)}</td>
      <td>${t.absentNoExcuseDays}</td>
      <td>${fmtMoney(t.absenceNoExcuseDeduction)}</td>
      <td>${(t.overtimeMinutes/60).toFixed(2)}</td>
      <td>${fmtMoney(t.overtimeValue)}</td>
      <td>${(t.lateMinutes/60).toFixed(2)}</td>
      <td>${fmtMoney(t.lateDeduction)}</td>
      <td>${(t.earlyLeaveMinutes/60).toFixed(2)}</td>
      <td>${fmtMoney(t.earlyDeduction)}</td>
      <td>${fmtMoney(t.advances)}</td>
      <td><b>${fmtMoney(t.net)}</b></td>
    `;
    tb.appendChild(tr);
  });
  document.getElementById("repTotal").value = fmtMoney(totalNet);
  toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.");
});

/* ===== Import / Export ===== */
document.getElementById("exportJson").addEventListener("click", ()=>{
  const app=ensureApp();
  downloadJSON(`backup_${APP_KEY}_${Date.now()}.json`, app);
});

document.getElementById("importJson").addEventListener("change", async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const txt = await readFileText(file);
    const obj = JSON.parse(txt);
    if(!obj || typeof obj!=="object") throw new Error("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
    // minimal schema check
    if(!obj.company || !obj.employees || !obj.departments) throw new Error("Ù‡ÙŠÙƒÙ„ JSON ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚");
    localStorage.setItem(APP_KEY, JSON.stringify(obj));
    toast("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.");
    location.reload();
  }catch(err){
    toast("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: " + err.message, "bad");
  }finally{ e.target.value=""; }
});

document.getElementById("exportEmployeesCsv").addEventListener("click", ()=>{
  const rows=[["Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ù‚Ø³Ù…","Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ","Ù…Ù„Ø§Ø­Ø¸Ø©"]];
  rows.push(["","", "", ""]);
  downloadText("employees.csv", csvStringify(rows), "text/csv;charset=utf-8");
});

document.getElementById("importEmployeesCsv").addEventListener("change", async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const txt=await readFileText(file);
    const rows=csvParse(txt);
    if(rows.length<2) throw new Error("CSV ÙØ§Ø±Øº");
    const header=rows[0].map(h=>h.replace(/\s+/g,"").toLowerCase());
    // accept arabic or english-ish
    // expected order: name, dept, salary, note
    const data=rows.slice(1).filter(r=>r.some(c=>String(c||"").trim().length));
    updateApp(app=>{
      for(const r of data){
        const name=(r[0]||"").trim();
        const deptName=(r[1]||"").trim();
        const salary=Number((r[2]||"0").toString().replace(/,/g,""))||0;
        const note=(r[3]||"").trim();
        if(!name) continue;

        // ensure dept exists if provided
        let deptId="";
        if(deptName){
          let d=app.departments.find(x=>x.name===deptName);
          if(!d){
            d={id:uid("dep"), name:deptName};
            app.departments.push(d);
          }
          deptId=d.id;
        }

        const existing=app.employees.find(x=>x.name===name);
        if(existing){
          existing.departmentId = deptId;
          existing.monthlySalary = salary;
          existing.notes = note;
          if(existing.active===undefined) existing.active=true;
        }else{
          app.employees.push({id:uid("emp"), name, departmentId:deptId, monthlySalary:salary, active:true, notes:note});
        }
      }
    });
    toast("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­.");
    renderDepartments(); renderEmployees();
  }catch(err){
    toast("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: " + err.message, "bad");
  }finally{ e.target.value=""; }
});

document.getElementById("exportMonthAttendanceCsv").addEventListener("click", ()=>{
  const ym=prompt("Ø§ÙƒØªØ¨ Ø§Ù„Ø´Ù‡Ø± Ù„Ù„ØªØµØ¯ÙŠØ± (YYYY-MM):", yyyymm());
  if(!ym) return;
  if(!/^\d{4}-\d{2}$/.test(ym)){ toast("ØµÙŠØºØ© Ø§Ù„Ø´Ù‡Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.", "bad"); return; }
  exportAttendanceCSV(ym);
});

document.getElementById("importAttendanceCsv").addEventListener("change", async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const txt=await readFileText(file);
    const rows=csvParse(txt);
    if(rows.length<2) throw new Error("CSV ÙØ§Ø±Øº");
    const data=rows.slice(1).filter(r=>r.some(c=>String(c||"").trim().length));
    updateApp(app=>{
      // map employee names to ids
      const map = Object.fromEntries(app.employees.map(x=>[x.name,x.id]));
      for(const r of data){
        const date=(r[0]||"").trim();
        const empName=(r[1]||"").trim();
        const checkIn=(r[2]||"").trim();
        const checkOut=(r[3]||"").trim();
        const excuseType=(r[4]||"none").trim() || "none";
        const outOfFactory=((r[5]||"0").trim()==="1");
        const note=(r[6]||"").trim();

        if(!date || !/^\d{4}-\d{2}-\d{2}$/.test(date)) continue;
        const empId=map[empName];
        if(!empId) continue; // must exist
        if(checkIn && parseTimeToMinutes(checkIn)==null) continue;
        if(checkOut && parseTimeToMinutes(checkOut)==null) continue;

        app.attendance[date] = app.attendance[date] || {};
        app.attendance[date][empId] = {date, employeeId:empId, checkIn, checkOut, excuseType, outOfFactory, note};
      }
    });
    toast("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ§Ù….");
    buildAttendanceTable();
  }catch(err){
    toast("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: " + err.message, "bad");
  }finally{ e.target.value=""; }
});

// catch errors from updateApp throws
window.addEventListener("error", (e)=>{
  // prevent noisy default
});
</script>


<div id="toast" class="toast" role="status" aria-live="polite">
  <div class="dot"></div>
  <div class="msg"></div>
</div>
</body>
</html>
